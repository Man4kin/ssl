
// Обработчик события ПриЗаписи. Определен для версионируемых объектов.
// Объект сериализуется в XML (Fast Infoset).
//
Процедура ВерсионированиеОбъектовПриЗаписиОбъекта(Источник, Отказ) Экспорт
	
	Перем НомерПоследнейВерсии;
	Если НЕ ОбъектВерсионируется(Источник, НомерПоследнейВерсии) Тогда
		Возврат;
	КонецЕсли;
	
	ЗаписьXML = Новый ЗаписьFastInfoset;
	ЗаписьXML.УстановитьДвоичныеДанные();
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	ЗаписатьXML(ЗаписьXML, Источник, НазначениеТипаXML.Явное);
	ДвоичныеДанные = ЗаписьXML.Закрыть();
	ХранилищеДанных = Новый ХранилищеЗначения(ДвоичныеДанные, Новый СжатиеДанных(9));
	
	ВерсионированиеОбъектов.ЗаписатьВерсиюОбъекта(Источник.Ссылка, НомерПоследнейВерсии, ХранилищеДанных);
	
КонецПроцедуры

// Проверяет настройки версионирования по переданному объекту и
// и возвращает вариант версионирования. Если по объекту не настроено
// версионирование, то он версионируется в соответствии с правилами
// версионирования "по умолчанию".
//
Функция ОбъектВерсионируется(знач Источник, НомерПоследнейВерсии)
	
	ИспользоватьВерсионированиеОбъектов = ПолучитьФункциональнуюОпцию("ИспользоватьВерсионированиеОбъектов");
	// Проверяем, что подсистема версионирования включена
	Если НЕ ИспользоватьВерсионированиеОбъектов Тогда
		Возврат Ложь;
	КонецЕсли;
	
	ПолноеИмяОбъектаМетаданных = Источник.Метаданные().ПолноеИмя();
	ВариантВерсионирования = ВерсионированиеОбъектов.ПолучитьВариантВерсионирования(ПолноеИмяОбъектаМетаданных);
	Если ВариантВерсионирования = Ложь Тогда
		ВариантВерсионирования = ВерсионированиеОбъектов.ПолучитьНастройкуВерсионированияПоУмолчанию(ПолноеИмяОбъектаМетаданных);
	КонецЕсли;
	
	НомерПоследнейВерсии = ВерсионированиеОбъектов.ПолучитьНомерПоследнейВерсии(Источник.Ссылка);
	ВерсионироватьОбъект = Истина;
	Если ВариантВерсионирования = Перечисления.ВариантыВерсионированияОбъектов.НеВерсионировать Тогда
		ВерсионироватьОбъект = Ложь;
	ИначеЕсли ВариантВерсионирования = Перечисления.ВариантыВерсионированияОбъектов.ВерсионироватьПриПроведении Тогда
		Если НомерПоследнейВерсии = 0 И НЕ Источник.Проведен Тогда
			ВерсионироватьОбъект = Ложь;
		КонецЕсли;
	КонецЕсли;
		
	Возврат ВерсионироватьОбъект;
	
КонецФункции

// Обработчик события ПриЗаписи Справочников и Документов ИБ.
// Подготавливает объект к записи в регистр версий.
//
Процедура ВерсионированиеОбъектовПередУдалениемОбъекта(Источник, Отказ) Экспорт
	
	ВерсионированиеОбъектов.УдалитьХранимыеВерсииПоОбъекту(Источник.Ссылка);
	
КонецПроцедуры
