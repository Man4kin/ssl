// Обработчик ожидания выполнения резервного копирования.
//
Процедура ОтложенноеИнтерактивноеРезервноеКопирование(ПараметрыКопирования, КоличествоПользователей) Экспорт
	ДатаКопирования = РезервноеКопированиеИБКлиент.ПолучитьДатуКопирования();
	
	Если ТекущаяДата() > ДатаКопирования Тогда
		
		НачатьРезервноеКопирование(Ложь);		
		ПараметрыКопирования.ОтложенноеРезервноеКопирование = Ложь;
		РезервноеКопированиеИБСервер.УстановитьПараметрыРезервногоКопирования(ПараметрыКопирования);
		
	Иначе
		
		Если КоличествоПользователей = 1 Тогда
			ТекстВопроса = НСтр("ru = 'В данный момент с базой больше никто не работает. Выполнить резервное копирование?'");
			Ответ = Вопрос(Нстр(ТекстВопроса), РежимДиалогаВопрос.ДаНет, 30, КодВозвратаДиалога.Да, 
				Нстр("ru = 'Провести резервное копирование прямо сейчас'"), КодВозвратаДиалога.Да);
			
			Если Ответ = КодВозвратаДиалога.Да ИЛИ Ответ = КодВозвратаДиалога.Таймаут Тогда
				НачатьРезервноеКопирование(Истина)
			КонецЕсли;
		КонецЕсли;	
	КонецЕсли;
КонецПроцедуры

Процедура НачатьРезервноеКопирование(ПараметрОтключенияПользователей)
	ПараметрыФормы = Новый Структура("ТипВызова, ТекущаяСтраница, ЗаголовокНадписи", 1, "СтраницаИнформацииИВыполненияРезервногоКопирования", "");
	ФормаОбработки = ОткрытьФорму("Обработка.РезервноеКопированиеИБ.Форма.РезервноеКопированиеИнформационнойБазы", ПараметрыФормы);
КонецПроцедуры

// Выполняет обработчик ожидания старта автоматического резервного копирования
// в процессе работы пользователя, а также повторного оповещения после игнорировании первоначального.
//
Процедура ОбработчикДействийРезервногоКопирования() Экспорт 
	СтруктураПараметровОбработчиков = РезервноеКопированиеИБСервер.ПолучитьНастройкиОбработчиковОжидания();
	
	Если СтруктураПараметровОбработчиков.ПараметрОповещения > 0 И 
		СтруктураПараметровОбработчиков.ПараметрОповещения < 4  Тогда
			РезервноеКопированиеИБКлиент.ОповеститьПользователяОРезервномКопировании(СтруктураПараметровОбработчиков.ПараметрОповещения)
	КонецЕсли;
	
	Если СтруктураПараметровОбработчиков.ПроводитьАвтоматическоеРезервноеКопирование Тогда
		РезервноеКопированиеИБКлиент.ПровестиРезервноеКопирование();
	КонецЕсли;
	
	Если СтруктураПараметровОбработчиков.ОтложенноеРезервноеКопирование Тогда
		ОтложенноеИнтерактивноеРезервноеКопирование(СтруктураПараметровОбработчиков.ПараметрыКопирования, СтруктураПараметровОбработчиков.КоличествоПользователей);
	КонецЕсли;
КонецПроцедуры

