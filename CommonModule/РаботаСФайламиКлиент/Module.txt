// Можно ли освободить Файл
Функция ВозможностьОсвободитьФайл(ОбъектСсылка, РедактируетТекущийПользователь, Редактирует, СтрокаОшибки = "") Экспорт

	Если РедактируетТекущийПользователь Тогда 
		Возврат Истина;
	ИначеЕсли Редактирует.Пустая() Тогда
		СтрокаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		                           НСтр("ru = 'Нельзя освободить файл ""%1"" т.к. он никем не занят.'"), Строка(ОбъектСсылка));
		Возврат Ложь;
	Иначе
		Если ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ЭтоПолноправныйПользовательИБ Тогда
			Возврат Истина;
		КонецЕсли;
		
		СтрокаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		                           НСтр("ru = 'Нельзя освободить файл ""%1"" т.к. он занят пользователем ""%2"".'"),
		                           Строка(ОбъектСсылка),
		                           Строка(Редактирует));
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции // ВозможностьОсвободитьФайл()

// Пометка файла как занятого для редактирования - по ссылке
// (без ПолучитьДанныеФайла - для минимизации числа вызовов сервера)
Функция ЗанятьФайлПоСсылке(ОбъектСсылка, УникальныйИдентификатор = Неопределено) Экспорт
	
	Перем ДанныеФайла;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	СтрокаОшибки = "";
	Если НЕ РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаИЗанятьФайл(ОбъектСсылка, ДанныеФайла, СтрокаОшибки, УникальныйИдентификатор) Тогда
		// Если занять нельзя, то сообщаем об ошибке
		Предупреждение(СтрокаОшибки);
		Возврат Ложь;
	КонецЕсли;	
	
	Если РасширениеПодключено Тогда
		НаЧтение = Ложь;
		ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
		ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		
	КонецЕсли;
	
	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Редактирование файла'"),
		ДанныеФайла.НавигационнаяСсылка,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		    НСтр("ru = 'Файл ""%1"" занят для редактирования.'"), Строка(ДанныеФайла.Ссылка)),
			БиблиотекаКартинок.Информация32);
			
	Возврат Истина;		
	
КонецФункции //ЗанятьФайлПоСсылке

// Пометка файлов как занятых для редактирования - по массиву ссылок
//
Процедура ЗанятьФайлыПоСсылкам(Знач МассивФайлов) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Получение массива данных файлов
	ДанныеФайлов = Новый Массив;
	РаботаСФайламиВызовСервера.ПолучитьДанныеДляМассиваФайлов(МассивФайлов, ДанныеФайлов);
	ВГраницаМассива  = ДанныеФайлов.ВГраница();
	
	Для Инд = 0 По ВГраницаМассива Цикл
		ДанныеФайла = ДанныеФайлов[ВГраницаМассива - Инд];
		
		СтрокаОшибки = "";
		Если НЕ РаботаСФайламиКлиентСервер.МожноЛиЗанятьФайл(ДанныеФайла, СтрокаОшибки) ИЛИ Не ДанныеФайла.Редактирует.Пустая() Тогда // занять невозможно
			ДанныеФайлов.Удалить(ВГраницаМассива - Инд);
		КонецЕсли;	
	КонецЦикла;	
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	// Занять файлы
	КоличествоЗанятых = 0;
	
	Для Каждого ДанныеФайла Из ДанныеФайлов Цикл
		
		Если Не РаботаСФайламиВызовСервера.ЗанятьФайл(ДанныеФайла) Тогда 
			Продолжить;
		КонецЕсли;	
		
		Если РасширениеПодключено Тогда
			НаЧтение = Ложь;
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		КонецЕсли;
		
		КоличествоЗанятых = КоличествоЗанятых + 1;
	КонецЦикла;
	
	ПоказатьОповещениеПользователя(  
		НСтр("ru = 'Занять файлы'"),
		,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Файлы (%1 из %2) заняты для редактирования.'"), 
			КоличествоЗанятых, МассивФайлов.Количество()),
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры //ЗанятьФайлПоСсылкам

// Процедура предназначена для открытия Файла в режиме редактирования - принимает ссылку на Файл
// по ссылке (без ПолучитьДанныеФайла - для минимизации числа вызовов сервера)
Функция РедактироватьФайлПоСсылке(ОбъектСсылка, УникальныйИдентификатор = Неопределено, РабочийКаталогВладельца = Неопределено) Экспорт
	
	Перем ДанныеФайла;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	СтрокаОшибки = "";
	Если НЕ РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаДляОткрытияИЗанятьФайл(ОбъектСсылка, ДанныеФайла, СтрокаОшибки, УникальныйИдентификатор, РабочийКаталогВладельца) Тогда
		// Если занять нельзя, то сообщаем об ошибке
		Предупреждение(СтрокаОшибки);
		Возврат Ложь;
	КонецЕсли;
	
	Если РасширениеПодключено Тогда
		НаЧтение = Ложь;
		ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
		ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
	КонецЕсли;

	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Редактирование файла'"),
		ДанныеФайла.НавигационнаяСсылка,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Файл ""%1"" занят для редактирования.'"), Строка(ДанныеФайла.Ссылка)),
			БиблиотекаКартинок.Информация32);
	
	// Если Файл без файла, то открываем карточку
	Если ДанныеФайла.Версия.Пустая() Тогда 
		ОткрытьЗначение(ДанныеФайла.Ссылка);
		Возврат Истина;
	КонецЕсли;
	
	Если РасширениеПодключено Тогда
		ПолноеИмяФайла = "";
		Результат = ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла, УникальныйИдентификатор);
		Если Результат Тогда
			ОткрытьФайлПриложением(ДанныеФайла, ПолноеИмяФайла);
		КонецЕсли;
	Иначе
		ФайловыеФункцииКлиент.ПоказатьНапоминаниеПриРедактировании();
		ИмяФайла = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		ПолучитьФайл(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии, ИмяФайла, Истина);		
		
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии) Тогда
			УдалитьИзВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии);
		КонецЕсли;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции // РедактироватьФайлПоСсылке()

// Процедура предназначена для открытия Файла в режиме редактирования
Процедура РедактироватьФайл(ДанныеФайла, УникальныйИдентификатор = Неопределено) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	СтрокаОшибки = "";
	Если НЕ РаботаСФайламиКлиентСервер.МожноЛиЗанятьФайл(ДанныеФайла, СтрокаОшибки) Тогда
		Предупреждение(СтрокаОшибки);
		Возврат;
	КонецЕсли;	
	
	// Если Файл никем не занят - займем Файл
	Если ДанныеФайла.Редактирует.Пустая() Тогда
		ЗанятьФайл(ДанныеФайла);
	КонецЕсли;
	
	// Если Файл без файла нужно в таких случаях открывать карточку
	Если ДанныеФайла.Версия.Пустая() Тогда 
		ОткрытьЗначение(ДанныеФайла.Ссылка);
		Возврат;
	КонецЕсли;
	
	Если РасширениеПодключено Тогда
		ПолноеИмяФайла = "";
		Результат = ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла, УникальныйИдентификатор);
		Если Результат Тогда
			ОткрытьФайлПриложением(ДанныеФайла, ПолноеИмяФайла);
		КонецЕсли;
	Иначе
		ФайловыеФункцииКлиент.ПоказатьНапоминаниеПриРедактировании();
		ИмяФайла = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		ПолучитьФайл(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии, ИмяФайла, Истина);
		
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии) Тогда
			УдалитьИзВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры // РедактироватьФайл()

// Процедура открытия Файла
Процедура ОткрытьФайл(ДанныеФайла, УникальныйИдентификатор = Неопределено) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Если Файл без файла нужно в таких случаях открывать карточку
	Если ДанныеФайла.Версия.Пустая() Тогда 
		ОткрытьЗначение(ДанныеФайла.Ссылка);
		Возврат;
	КонецЕсли;
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	Если РасширениеПодключено Тогда
		ПолноеИмяФайла = "";
		Результат = ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла, УникальныйИдентификатор);
		Если Результат Тогда
			ОткрытьФайлПриложением(ДанныеФайла, ПолноеИмяФайла);
		КонецЕсли;
	Иначе
		Если ДанныеФайла.РедактируетТекущийПользователь Тогда 
			ФайловыеФункцииКлиент.ПоказатьНапоминаниеПриРедактировании();
		КонецЕсли;
		ИмяФайла = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		ПолучитьФайл(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии, ИмяФайла, Истина);
		
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии) Тогда
			УдалитьИзВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры // ОткрытьФайл()

// Процедура предназначена для открытия версии Файла
Процедура ОткрытьВерсиюФайла(ДанныеФайла, УникальныйИдентификатор = Неопределено) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	Если РасширениеПодключено Тогда
		ПолноеИмяФайла = "";
		Результат = ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла, УникальныйИдентификатор);
		Если Результат Тогда
			ОткрытьФайлПриложением(ДанныеФайла, ПолноеИмяФайла);
		КонецЕсли;
	Иначе
		Адрес = РаботаСФайламиВызовСервера.ПолучитьНавигационнуюСсылкуДляОткрытия(ДанныеФайла.Версия, УникальныйИдентификатор);
		
		ИмяФайла = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		ПолучитьФайл(Адрес, ИмяФайла, Истина);		
		
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(Адрес) Тогда
			УдалитьИзВременногоХранилища(Адрес);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры // ОткрытьВерсиюФайла()

// На основе переданного пути к файлу на диске создает Файл его и открывает карточку
Процедура СоздатьДокументНаОсновеФайла(ПолноеИмяФайла, ВладелецФайла, ФормаВладелец, 
	НеОткрыватьКарточкуПослеСозданияИзФайла = Неопределено, ИмяСоздаваемогоФайла = Неопределено) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Здесь создаем Файл ...
	Файл = Новый Файл(ПолноеИмяФайла);
	
	ЗапретЗагрузкиФайловПоРасширению = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ЗапретЗагрузкиФайловПоРасширению;
	СписокЗапрещенныхРасширений = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().СписокЗапрещенныхРасширений;
	РасширениеФайла = Файл.Расширение;
	Если Не ФайловыеФункцииКлиентСервер.РасширениеФайлаРазрешеноДляЗагрузки(ЗапретЗагрузкиФайловПоРасширению, СписокЗапрещенныхРасширений, РасширениеФайла) Тогда
		ВызватьИсключение
			   СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				 НСтр("ru = 'Загрузка файлов с расширением ""%1"" запрещена. Обратитесь к администратору системы.'"),
				 РасширениеФайла);
	КонецЕсли;	
	
	МаксРазмерФайла = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().МаксимальныйРазмерФайла;
	
	РазмерВМб = Файл.Размер() / (1024 * 1024);
	РазмерВМбМакс = МаксРазмерФайла / (1024 * 1024);
	
	Если Файл.Размер() > МаксРазмерФайла Тогда
		
		ВызватьИсключение
			   СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				 НСтр("ru = 'Размер файла ""%1"" (%2 Мб) превышает максимально допустимый размер файла (%3 Мб).'"),
				 Файл.Имя, 
				 ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")), 
				 ?(РазмерВМбМакс >= 1, Формат(РазмерВМбМакс, "ЧДЦ=0"), Формат(РазмерВМбМакс, "ЧДЦ=1; ЧН=0")));
	КонецЕсли;
	
	Если НЕ ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ИзвлекатьТекстыФайловНаСервере Тогда
		АдресВременногоХранилищаТекста = ФайловыеФункцииКлиентСервер.ИзвлечьТекстВоВременноеХранилище(
			Файл.ПолноеИмя, 
			ФормаВладелец.УникальныйИдентификатор);
	Иначе
		АдресВременногоХранилищаТекста = "";
	КонецЕсли;
	
	ВремяИзменения = Файл.ПолучитьВремяИзменения();
	ВремяИзмененияУниверсальное = Файл.ПолучитьУниверсальноеВремяИзменения();
	
	ИмяСоздания = Файл.ИмяБезРасширения;
	Если ИмяСоздаваемогоФайла <> Неопределено Тогда
		ИмяСоздания = ИмяСоздаваемогоФайла;
	КонецЕсли;	
	
	ИмяФайла = ИмяСоздания + Файл.Расширение;
	РазмерВМб = Файл.Размер() / (1024 * 1024);
	
	ТекстПояснения =
	СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Идет сохранение файла ""%1"" (%2 Мб).
		|Пожалуйста, подождите...'"),
		ИмяФайла,
		?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
	
	Состояние(ТекстПояснения);
	
	
	// Поместим Файл в ВременноеХранилище
	АдресВременногоХранилищаФайла = "";
	
	ПомещаемыеФайлы = Новый Массив;
	Описание = Новый ОписаниеПередаваемогоФайла(Файл.ПолноеИмя, "");
	ПомещаемыеФайлы.Добавить(Описание);
	
	ПомещенныеФайлы = Новый Массив;

	Если НЕ ПоместитьФайлы(ПомещаемыеФайлы, ПомещенныеФайлы, , Ложь, ФормаВладелец.УникальныйИдентификатор) Тогда		
		ВызватьИсключение
		  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Ошибка при помещении файла в хранилище: %1'"), Файл.ПолноеИмя);
	КонецЕсли;
	
	Если ПомещенныеФайлы.Количество() = 1 Тогда
		АдресВременногоХранилищаФайла = ПомещенныеФайлы[0].Хранение;
	КонецЕсли;
	
	// Создадим карточку Файла в БД
	Док = РаботаСФайламиВызовСервера.СоздатьФайлСВерсией(
		ВладелецФайла,
		ИмяСоздания,
		ФайловыеФункцииКлиентСервер.РасширениеБезТочки(Файл.Расширение),
		ВремяИзменения,
		ВремяИзмененияУниверсальное,
		Файл.Размер(),
		АдресВременногоХранилищаФайла,
		АдресВременногоХранилищаТекста,
		Ложь); // это не веб клиент

	Состояние();
	
	ПараметрыОповещения = Новый Структура("Владелец, Файл", ВладелецФайла, Док);
	Оповестить("СозданФайл", ПараметрыОповещения);
	
	НавигационнаяСсылка = ПолучитьНавигационнуюСсылку(Док);
	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Создание:'"),
		НавигационнаяСсылка,
		Док,
		БиблиотекаКартинок.Информация32);
	
	Параметры = Новый Структура("Ключ, КарточкаОткрытаПослеСозданияФайла, НовыйФайл", Док, Истина, Истина);
	
	Если НеОткрыватьКарточкуПослеСозданияИзФайла <> Истина Тогда
		ОткрытьФорму("Справочник.Файлы.ФормаОбъекта", Параметры, ФормаВладелец);
	КонецЕсли;
	
КонецПроцедуры

// Процедура создания нового Файла
// Параметры:
//	РежимСоздания - как создавать новый Файл
//		1 - создать из шаблона
//		2 - создать из файла
//		3 - создать пустую карточку
Процедура СоздатьФайл(РежимСоздания, ВладелецФайла, ФормаВладелец, НеОткрыватьКарточкуПослеСозданияИзФайла = Неопределено) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	Если РежимСоздания = 1 Тогда
		
		// Создание из шаблона
		ПараметрыОткрытияФормы = Новый Структура("ВыборШаблона, ТекущаяСтрока", 
			Истина, ПредопределенноеЗначение("Справочник.ПапкиФайлов.Шаблоны"));
		Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.ФормаВыбора", ПараметрыОткрытияФормы);
		
		Если Результат = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		Параметры = Новый Структура("ФайлОснование, ВладелецФайла, РежимСоздания", 
			Результат, ВладелецФайла, "ИзШаблона");
		ОткрытьФорму("Справочник.Файлы.ФормаОбъекта", Параметры, ФормаВладелец);
		
	ИначеЕсли РежимСоздания = 2 Тогда
		
		// Создание из файла
		ПолноеИмяФайла = "";
		
		РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
		Если РасширениеПодключено Тогда
			ВыборФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
			ВыборФайла.МножественныйВыбор = Ложь;
			ВыборФайла.Заголовок = НСтр("ru = 'Выбор файла'");
			ВыборФайла.Фильтр = НСтр("ru = 'Все файлы (*.*)|*.*'");
			
			РабочийКаталог = РаботаСФайламиВызовСервера.ПолучитьРабочийКаталог(ВладелецФайла);
			ВыборФайла.Каталог = РабочийКаталог;

			Результат = ВыборФайла.Выбрать();
			ПолноеИмяФайла = ВыборФайла.ПолноеИмяФайла;
		
			Если НЕ Результат Тогда
				Возврат;
			КонецЕсли;
			
			СоздатьДокументНаОсновеФайла(ПолноеИмяФайла, ВладелецФайла, ФормаВладелец, НеОткрыватьКарточкуПослеСозданияИзФайла);
				
		Иначе 
			// Если веб-клиент
			ВремяИзменения = ТекущаяДата(); // Т.к. не можем получить дату модификации файла на диске
			ВремяИзмененияУниверсальное = УниверсальноеВремя(ТекущаяДата());
			Размер = 0;						// Т.к. не можем получить размер файла на диске
			ИмяБезРасширения = "";
			Расширение = "";
			АдресВременногоХранилищаТекста = "";

			// Поместим Файл в ВременноеХранилище
			АдресВременногоХранилищаФайла = "";
			ИмяФайла = "";
			Если НЕ ПоместитьФайл(АдресВременногоХранилищаФайла, ИмяФайла, ИмяФайла, Истина, ФормаВладелец.УникальныйИдентификатор) Тогда
				Возврат;
			КонецЕсли;

			СтрокиПути = ФайловыеФункцииКлиентСервер.РазложитьСтрокуПоТочкамИСлэшам(ИмяФайла);
			Если СтрокиПути.Количество() >= 2 Тогда
				Расширение = СтрокиПути[СтрокиПути.Количество()-1];
				ИмяБезРасширения = СтрокиПути[СтрокиПути.Количество()-2];
			Иначе
				ВызватьИсключение
				  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				    НСтр("ru = 'Ошибка при помещении файла в хранилище: %1'"),ИмяФайла);
			КонецЕсли;
			
			// Создадим карточку файла в БД
			Док = РаботаСФайламиВызовСервера.СоздатьФайлСВерсией(
				ВладелецФайла,
				ИмяБезРасширения,
				ФайловыеФункцииКлиентСервер.РасширениеБезТочки(Расширение),
				ВремяИзменения,
				ВремяИзмененияУниверсальное,
				Размер,
				АдресВременногоХранилищаФайла,
				АдресВременногоХранилищаТекста,
				Истина); // это веб клиент
			
			Если НеОткрыватьКарточкуПослеСозданияИзФайла <> Истина Тогда
				Параметры = Новый Структура("Ключ, НовыйФайл", Док, Истина);
				ОткрытьФорму("Справочник.Файлы.ФормаОбъекта", Параметры, ФормаВладелец);
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли РежимСоздания = 3 Тогда
		// со сканера
		РаботаСоСканеромКлиент.СканироватьИПоказатьДиалогПросмотра(
			ВладелецФайла, 
			ФормаВладелец.УникальныйИдентификатор, 
			ФормаВладелец, 
			НеОткрыватьКарточкуПослеСозданияИзФайла);
	Иначе
		ВызватьИсключение
		  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		    НСтр("ru = 'Неверный режим создания файла: %1'"), РежимСоздания);
	КонецЕсли;
	
КонецПроцедуры // СоздатьФайл()

// Закончить редактирование - по массиву ссылок
//
Функция ЗакончитьРедактированиеПоСсылкам(Знач МассивФайлов, ИдентификаторФормы) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Получение массива данных файлов
	ДанныеФайлов = Новый Массив;
	РаботаСФайламиВызовСервера.ПолучитьДанныеДляМассиваФайлов(МассивФайлов, ДанныеФайлов);
	ВГраницаМассива  = ДанныеФайлов.ВГраница();
	
	Для Инд = 0 По ВГраницаМассива Цикл
		ДанныеФайла = ДанныеФайлов[ВГраницаМассива - Инд];
		
		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует, СтрокаОшибки) Тогда
			ДанныеФайлов.Удалить(ВГраницаМассива - Инд);
		КонецЕсли;
		
	КонецЦикла;	
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	
	ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
	
	СоздатьНовуюВерсию = Истина;
	СоздатьНовуюВерсиюДоступность = Истина;

	ВозвратМассив = Новый Массив;
	
	СтруктураПараметров = Новый Структура("ФайлСсылка, КомментарийКВерсии, СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность", 
		Неопределено, "", СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность);
	ФормаВозврата.УстановитьПараметрыИспользования(СтруктураПараметров);
	
	Результат = ФормаВозврата.ОткрытьМодально();
	Если ТипЗнч(Результат) <> Тип("Структура") Тогда
		Возврат ВозвратМассив;
	КонецЕсли;	
	
	КодВозврата = Результат.КодВозврата;
	Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
		Возврат ВозвратМассив;
	КонецЕсли;	
	
	СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
	КомментарийКВерсии = Результат.КомментарийКВерсии;
	
	ПрименитьКоВсем = Ложь;
	ОсвобождатьФайлы = Истина;
	
	// Занять файлы
	Для Каждого Данные Из ДанныеФайлов Цикл
		
		ПоказыватьОповещение = Ложь;
		
		Если ЗакончитьРедактирование(
					Данные.Ссылка, 
					ИдентификаторФормы, 
					Данные.ХранитьВерсии,
					Данные.РедактируетТекущийПользователь, 
					Данные.Редактирует,
					Данные.АвторТекущейВерсии,
					"",
					СоздатьНовуюВерсию,
					КомментарийКВерсии,
					ПоказыватьОповещение,
					ПрименитьКоВсем,
					ОсвобождатьФайлы) Тогда
					
			ВозвратМассив.Добавить(Данные.Ссылка);
		КонецЕсли;	
		
	КонецЦикла;
	
	ПоказатьОповещениеПользователя(  
		НСтр("ru = 'Закончить редактирование файлов'"),
		,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Закончено редактирование файлов (%1 из %2).'"), 
			ВозвратМассив.Количество(), МассивФайлов.Количество()),
		БиблиотекаКартинок.Информация32);
	
	Возврат ВозвратМассив;
	
КонецФункции //ЗакончитьРедактированиеПоСсылкам

// Закончить редактирование Файла и поместить его на сервер
//
Функция ЗакончитьРедактирование(ОбъектСсылка, ИдентификаторФормы, Знач ХранитьВерсии = Неопределено,
			Знач РедактируетТекущийПользователь = Неопределено, 
			Знач Редактирует = Неопределено,
			Знач АвторТекущейВерсии = Неопределено,
			ПереданныйПолныйПутьКФайлу = "",
			СоздатьНовуюВерсию = Неопределено,
			КомментарийКВерсии = Неопределено,
			ПоказыватьОповещение = Истина,
			ПрименитьКоВсем = Ложь,
			ОсвобождатьФайлы = Истина) Экспорт
	Перем ДанныеФайла;
	
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	Если РасширениеПодключено Тогда // код для тонкого (или толстого) клиента (или веб с подключенным расширением)

		ДанныеФайла = РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаИРабочийКаталог(ОбъектСсылка);
	
		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует, СтрокаОшибки) Тогда
			Предупреждение(СтрокаОшибки);
			Возврат Ложь;
		КонецЕсли;
		
		ПолныйПутьКФайлу = ПереданныйПолныйПутьКФайлу;
		Если ПолныйПутьКФайлу = "" Тогда
			ПолныйПутьКФайлу = ФайловыеФункцииКлиент.ПолучитьПолныйПутьКФайлуВРабочемКаталоге(ДанныеФайла);
		КонецЕсли;
		
		// Проверяем наличие файла на диске
		ФайлНовойВерсии = Новый Файл(ПолныйПутьКФайлу);
		Если НЕ ФайлНовойВерсии.Существует() Тогда
			
			Если ПрименитьКоВсем = Ложь Тогда
			
				СтрокаПредупреждения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				    НСтр("ru = 'Не удалось загрузить файл ""%1"" в информационную базу, т.к. он не найден на локальном компьютере'"),
				    Строка(ДанныеФайла.Ссылка));
					
				Если НЕ ПустаяСтрока(ПолныйПутьКФайлу) Тогда
					СтрокаПредупреждения = СтрокаПредупреждения + " (" + ПолныйПутьКФайлу + ").";	
				Иначе
					СтрокаПредупреждения = СтрокаПредупреждения + ".";	
				КонецЕсли;
				
				СтрокаПредупреждения = СтрокаПредупреждения + Символы.ПС + "Освободить файл?";
					
				ПараметрыФормы = 
				Новый Структура("Заголовок, Информация", 
					НСтр("ru = 'Закончить редактирование'"), СтрокаПредупреждения);
					
				Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.ФормаВопросаЗакончитьРедактирование", ПараметрыФормы);
				
				Если ТипЗнч(Результат) <> Тип("Структура") Тогда
					ОсвобождатьФайлы = Ложь;
				Иначе
					КодВозврата = Результат.КодВозврата;
					
					Если КодВозврата = КодВозвратаДиалога.Да Тогда
						ПрименитьКоВсем = Результат.ПрименитьКоВсем;
						ОсвобождатьФайлы = Истина;
					ИначеЕсли КодВозврата = КодВозвратаДиалога.Нет Тогда
						ПрименитьКоВсем = Результат.ПрименитьКоВсем;
						ОсвобождатьФайлы = Ложь; 
					КонецЕсли;
				КонецЕсли;
				
			КонецЕсли;
			
			Если ОсвобождатьФайлы Тогда
				ОсвободитьФайлБезВопроса(ДанныеФайла, ИдентификаторФормы);
				Возврат Истина;
			КонецЕсли;
			
			Возврат Ложь;
			
		КонецЕсли;
	
		Попытка
			ТолькоЧтение = ФайлНовойВерсии.ПолучитьТолькоЧтение();
			ФайлНовойВерсии.УстановитьТолькоЧтение(НЕ ТолькоЧтение);
			ФайлНовойВерсии.УстановитьТолькоЧтение(ТолькоЧтение);
		Исключение
			
			Предупреждение(
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось вернуть файл ""%1"" в информационную базу, т.к. он заблокирован другой программой'"),
					Строка(ДанныеФайла.Ссылка)));

		КонецПопытки;
			
		// Запрашиваем комментарий и признак хранения версии
		Если СоздатьНовуюВерсию = Неопределено Тогда
			
			ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
			
			СоздатьНовуюВерсию = Истина;
			СоздатьНовуюВерсиюДоступность = Истина;
			
			Если ДанныеФайла.ХранитьВерсии Тогда
				СоздатьНовуюВерсию = Истина;
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если ДанныеФайла.АвторТекущейВерсии <> ДанныеФайла.Редактирует Тогда
					СоздатьНовуюВерсиюДоступность = Ложь;
				Иначе
					СоздатьНовуюВерсиюДоступность = Истина;
				КонецЕсли;			
			Иначе
				СоздатьНовуюВерсию = Ложь;
				СоздатьНовуюВерсиюДоступность = Ложь;
			КонецЕсли;	

			СтруктураПараметров = Новый Структура("ФайлСсылка, КомментарийКВерсии, СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность", 
				ДанныеФайла.Ссылка, "", СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность);
			ФормаВозврата.УстановитьПараметрыИспользования(СтруктураПараметров);
			
			Результат = ФормаВозврата.ОткрытьМодально();
			Если ТипЗнч(Результат) <> Тип("Структура") Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			КодВозврата = Результат.КодВозврата;
			Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
			КомментарийКВерсии = Результат.КомментарийКВерсии;
				
		Иначе //  СоздатьНовуюВерсию и КомментарийКВерсии переданы извне
			
			Если ДанныеФайла.ХранитьВерсии Тогда
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если ДанныеФайла.АвторТекущейВерсии <> ДанныеФайла.Редактирует Тогда
					СоздатьНовуюВерсию = Истина;
				КонецЕсли;			
				
			Иначе
				СоздатьНовуюВерсию = Ложь;
			КонецЕсли;	
			
		КонецЕсли;
		
		СтараяВерсия = ДанныеФайла.ТекущаяВерсия;
		Интерактивно = Ложь;
		
		РазмерВМб = ФайлНовойВерсии.Размер() / (1024 * 1024);
		ВремяИзменения = ФайлНовойВерсии.ПолучитьВремяИзменения();
		ВремяИзмененияУниверсальное = ФайлНовойВерсии.ПолучитьУниверсальноеВремяИзменения();
		Размер = ФайлНовойВерсии.Размер();
		
		// Файл с признаком шифрован - при окончании редактирования снова шифруем для тех же сертификатов
		Если ДанныеФайла.Зашифрован Тогда
			
			МенеджерКриптографии = ЭлектроннаяЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
			
			МассивСертификатов = Новый Массив;
			
			Для Каждого СтруктураСертификата Из ДанныеФайла.МассивСертификатовШифрования Цикл
				
				Сертификат = Новый СертификатКриптографии(СтруктураСертификата.Сертификат);
				МассивСертификатов.Добавить(Сертификат);
				
			КонецЦикла;	
			
			ИмяФайлаСПутемШифрованное = ПолныйПутьКФайлу + ".crp";
			МенеджерКриптографии.Зашифровать(ПолныйПутьКФайлу, ИмяФайлаСПутемШифрованное, МассивСертификатов);
			УдалитьФайл(ПолныйПутьКФайлу);
			ПереместитьФайл(ИмяФайлаСПутемШифрованное, ПолныйПутьКФайлу);
			
		КонецЕсли;	
		
		Пока Истина Цикл
			Попытка
				АдресВременногоХранилища = "";
				ВыбранныйПутьКФайлу = "";
				
				ИмяФайла = ФайлНовойВерсии.Имя;
				
				ТекстПояснения =
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				    НСтр("ru = 'Выполняется передача файла ""%1"" (%2 Мб)...
					|Пожалуйста, подождите.'"),
				    ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
				
				Состояние(ТекстПояснения);
				
				ПомещаемыеФайлы = Новый Массив;
				Описание = Новый ОписаниеПередаваемогоФайла(ПолныйПутьКФайлу, "");
				ПомещаемыеФайлы.Добавить(Описание);
				
				ПомещенныеФайлы = Новый Массив;
				
				Если ПоместитьФайлы(ПомещаемыеФайлы, ПомещенныеФайлы, , Интерактивно, ИдентификаторФормы) Тогда
					Состояние();
					
					Если ПомещенныеФайлы.Количество() = 1 Тогда
						АдресВременногоХранилища = ПомещенныеФайлы[0].Хранение;
					КонецЕсли;
					
					ЭтоВебКлиент = Ложь;
					
					ТекстНеИзвлеченНаКлиенте = Ложь;
					#Если ВебКлиент Тогда
						ТекстНеИзвлеченНаКлиенте = Истина;
					#КонецЕсли	
					
					ИмяБезРасширения = ФайлНовойВерсии.ИмяБезРасширения;
					Расширение = ФайлНовойВерсии.Расширение;

					Если НЕ ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ИзвлекатьТекстыФайловНаСервере Тогда
						АдресВременногоХранилищаТекста = ФайловыеФункцииКлиентСервер.ИзвлечьТекстВоВременноеХранилище(
							ПолныйПутьКФайлу, ИдентификаторФормы);
					Иначе
						АдресВременногоХранилищаТекста = "";
					КонецЕсли;
					
					ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";	

					НеМенятьЗаписьВРабочемКаталоге = Ложь;
					Если ПереданныйПолныйПутьКФайлу <> "" Тогда
						НеМенятьЗаписьВРабочемКаталоге = Истина;
					КонецЕсли;
					
					РаботаСФайламиВызовСервера.ОпубликоватьИОсвободитьФайл(
						ДанныеФайла, 
						СоздатьНовуюВерсию,
						АдресВременногоХранилища,
						КомментарийКВерсии,
						ВремяИзменения,
						ВремяИзмененияУниверсальное,
						Размер,
						ИмяБезРасширения,
						Расширение,
						ПолныйПутьКФайлу,
						АдресВременногоХранилищаТекста,
						ЭтоВебКлиент,
						ТекстНеИзвлеченНаКлиенте,
						ВРабочемКаталогеВладельца,
						НеМенятьЗаписьВРабочемКаталоге,
						ИдентификаторФормы);
					
					НоваяВерсия = ДанныеФайла.ТекущаяВерсия;
					
					Если ПереданныйПолныйПутьКФайлу = "" Тогда
						УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования;
						Если УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования = Неопределено Тогда
							УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования = Ложь;
						КонецЕсли;
						
						Если ДанныеФайла.РабочийКаталогВладельца <> "" Тогда
							УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования = Ложь;
						КонецЕсли;
						
						Если УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования Тогда
							УдалитьФайлИзРабочегоКаталога(НоваяВерсия);
						Иначе
							Файл = Новый Файл(ПолныйПутьКФайлу);
							Файл.УстановитьТолькоЧтение(Истина);	
						КонецЕсли;
					КонецЕсли;
					
					Если ПоказыватьОповещение Тогда
						ПоказатьОповещениеПользователя(
							НСтр("ru = 'Редактирование закончено'"),
							ДанныеФайла.НавигационнаяСсылка,
							СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								НСтр("ru = 'Файл %1 обновлен и освобожден.'"),
									Строка(ДанныеФайла.Ссылка)),
								БиблиотекаКартинок.Информация32);
					КонецЕсли;		
					
					// удаляем зашифрованный файл из кеша
					Если ДанныеФайла.Зашифрован Тогда
						УдалитьФайл(ПолныйПутьКФайлу);	
					КонецЕсли;	
					
					Возврат Истина;
				Иначе
					Состояние();
					Возврат Ложь;
				КонецЕсли;

			Исключение

				ОшибкаИнфо = ИнформацияОбОшибке();
				
				Если ОшибкаИнфо.Причина = Неопределено Тогда
					СообщениеОбОшибке =ОшибкаИнфо.Описание;
				Иначе
					СообщениеОбОшибке = ОшибкаИнфо.Причина.Описание;
				КонецЕсли;

				ТекстВопроса = "";
							 
				ТекстВопроса =
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось вернуть файл ""%1"" в информационную базу по причине: ""%2""
							 |Повторить операцию?'"),
							 Строка(ДанныеФайла.Ссылка), СообщениеОбОшибке);
				
				КодВозврата = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ПовторитьОтмена);
				
				Если КодВозврата = КодВозвратаДиалога.Отмена Тогда
					Возврат Ложь;
				КонецЕсли;
				
			КонецПопытки;
		КонецЦикла;

	Иначе  // веб клиент и нет расширения работы с файлами
		
		Если ХранитьВерсии = Неопределено Тогда
			ДанныеФайла 				= РаботаСФайламиВызовСервера.ПолучитьДанныеФайла(ОбъектСсылка);
			ХранитьВерсии 					= ДанныеФайла.ХранитьВерсии;
			РедактируетТекущийПользователь 	= ДанныеФайла.РедактируетТекущийПользователь;
			Редактирует 					= ДанныеФайла.Редактирует;
			АвторТекущейВерсии				= ДанныеФайла.АвторТекущейВерсии;
		КонецЕсли;

		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ОбъектСсылка, РедактируетТекущийПользователь, Редактирует, СтрокаОшибки) Тогда
			Предупреждение(СтрокаОшибки);
			Возврат Ложь;
		КонецЕсли;
		
		ПолныйПутьКФайлу = "";

		Если СоздатьНовуюВерсию = Неопределено Тогда
			ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
			
			СоздатьНовуюВерсию = Истина;
			СоздатьНовуюВерсиюДоступность = Истина;
			
			Если ХранитьВерсии Тогда
				СоздатьНовуюВерсию = Истина;
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если АвторТекущейВерсии <> Редактирует Тогда
					СоздатьНовуюВерсиюДоступность = Ложь;
				Иначе
					СоздатьНовуюВерсиюДоступность = Истина;
				КонецЕсли;			
			Иначе
				СоздатьНовуюВерсию = Ложь;
				СоздатьНовуюВерсиюДоступность = Ложь;
			КонецЕсли;	

			СтруктураПараметров = Новый Структура("ФайлСсылка, КомментарийКВерсии, СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность", 
				ОбъектСсылка, "", СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность);
			ФормаВозврата.УстановитьПараметрыИспользования(СтруктураПараметров);
			
			Результат = ФормаВозврата.ОткрытьМодально();
			Если ТипЗнч(Результат) <> Тип("Структура") Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			КодВозврата = Результат.КодВозврата;
			Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
			КомментарийКВерсии = Результат.КомментарийКВерсии;
			
		Иначе //  СоздатьНовуюВерсию и КомментарийКВерсии переданы извне
			
			Если ХранитьВерсии Тогда
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если АвторТекущейВерсии <> Редактирует Тогда
					СоздатьНовуюВерсию = Истина;
				КонецЕсли;			
				
			Иначе
				СоздатьНовуюВерсию = Ложь;
			КонецЕсли;	
			
		КонецЕсли;
		
		Интерактивно = Истина;
		
		Пока Истина Цикл
			Попытка
				АдресВременногоХранилища = "";	
				ВыбранныйПутьКФайлу = "";
				ПоказатьНапоминаниеПередПоместитьФайл();
				Если ПоместитьФайл(АдресВременногоХранилища, ПолныйПутьКФайлу, ВыбранныйПутьКФайлу, Интерактивно, ИдентификаторФормы) Тогда
					
					АдресВременногоХранилищаТекста = "";
					ИмяБезРасширения = "";
					Расширение = "";
					
					ЭтоВебКлиент = Истина;
					
					ТекстНеИзвлеченНаКлиенте = Ложь;
					#Если ВебКлиент Тогда
						ТекстНеИзвлеченНаКлиенте = Истина;
					#КонецЕсли	
					
					ВремяИзменения = ТекущаяДата(); // Т.к. не можем получить дату модификации файла на диске
					ВремяИзмененияУниверсальное = УниверсальноеВремя(ТекущаяДата());
					Размер = 0;						// Т.к. не можем получить размер файла на диске
					
					СтрокиПути = ФайловыеФункцииКлиентСервер.РазложитьСтрокуПоТочкамИСлэшам(ВыбранныйПутьКФайлу);
					Если СтрокиПути.Количество() >= 2 Тогда
						Расширение = СтрокиПути[СтрокиПути.Количество()-1];
						ИмяБезРасширения = СтрокиПути[СтрокиПути.Количество()-2];
					КонецЕсли;

					РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаИОпубликоватьИОсвободитьФайл(
						ОбъектСсылка,
						ДанныеФайла,
						СоздатьНовуюВерсию,
						АдресВременногоХранилища,
						КомментарийКВерсии,
						ВремяИзменения,
						ВремяИзмененияУниверсальное,
						Размер,
						ИмяБезРасширения,
						Расширение,
						ПолныйПутьКФайлу,
						АдресВременногоХранилищаТекста,
						ЭтоВебКлиент,
						ТекстНеИзвлеченНаКлиенте,
						ИдентификаторФормы);
					
					НоваяВерсия = ДанныеФайла.ТекущаяВерсия;
					
					Если ПоказыватьОповещение Тогда
						ПоказатьОповещениеПользователя(
							НСтр("ru = 'Редактирование закончено'"),
							ДанныеФайла.НавигационнаяСсылка,
							СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							    НСтр("ru = 'Файл %1 обновлен и освобожден.'"), Строка(ДанныеФайла.Ссылка)),
							БиблиотекаКартинок.Информация32);
					КонецЕсли;	
						
					Возврат Истина;
				Иначе
					Возврат Ложь;
				КонецЕсли;
			Исключение
				
				ОшибкаИнфо = ИнформацияОбОшибке();
				
				Если ОшибкаИнфо.Причина = Неопределено Тогда
					СообщениеОбОшибке =ОшибкаИнфо.Описание;
				Иначе
					СообщениеОбОшибке = ОшибкаИнфо.Причина.Описание;
				КонецЕсли;

				ТекстВопроса =
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось вернуть файл ""%1"" в информационную базу по причине: ""%2""
							 |Повторить операцию?'"),
				Строка(ОбъектСсылка), СообщениеОбОшибке);
				КодВозврата = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ПовторитьОтмена);
				
				Если КодВозврата = КодВозвратаДиалога.Отмена Тогда
					Возврат Ложь;
				КонецЕсли;
				
			КонецПопытки;
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

// Процедура предназначена для освобождения файла. При этом не происходит
// обновления файла, а просто очищается его текущий держатель. Выполняется по массиву ссылок
Процедура ОсвободитьФайлыПоСсылкам(Знач МассивФайлов) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Получение массива данных файлов
	ДанныеФайлов = Новый Массив;
	РаботаСФайламиВызовСервера.ПолучитьДанныеДляМассиваФайлов(МассивФайлов, ДанныеФайлов);
	ВГраницаМассива  = ДанныеФайлов.ВГраница();
	
	Для Инд = 0 По ВГраницаМассива Цикл
		ДанныеФайла = ДанныеФайлов[ВГраницаМассива - Инд];
		
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует, СтрокаОшибки) Тогда
			ДанныеФайлов.Удалить(ВГраницаМассива - Инд);
		КонецЕсли;
		
	КонецЦикла;	
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	Результат = Вопрос(
	  НСтр("ru = 'Отмена редактирования файлов может привести к потере Ваших изменений.
				   |Продолжить?'"),
	РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);
	
	Если Результат <> КодВозвратаДиалога.Да Тогда
		Возврат;
	КонецЕсли;	
	
	// Занять файлы
	Для Каждого ДанныеФайла Из ДанныеФайлов Цикл
		
		НеЗадаватьВопрос = Истина;
		
		ОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.ХранитьВерсии,
			ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует,
			Неопределено, НеЗадаватьВопрос);
	
	КонецЦикла;
	
	ПоказатьОповещениеПользователя(  
		НСтр("ru = 'Отменить редактирование файлов'"),
		,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Отменено редактирование файлов (%1 из %2).'"), 
			ДанныеФайлов.Количество(), МассивФайлов.Количество()),
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры //ОсвободитьФайлыПоСсылкам

// Процедура предназначена для освобождения файла. При этом не происходит
// обновления файла, а просто очищается его текущий держатель.
Функция ОсвободитьФайл(ОбъектСсылка, Знач ХранитьВерсии = Неопределено,
	Знач РедактируетТекущийПользователь = Неопределено, Знач Редактирует = Неопределено,
	УникальныйИдентификатор = Неопределено,
	НеЗадаватьВопрос = Ложь) Экспорт
	
	Перем ДанныеФайла;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();	
	
	Если ХранитьВерсии = Неопределено Тогда
		ДанныеФайла                 = РаботаСФайламиВызовСервера.ПолучитьДанныеФайла(ОбъектСсылка);
		ХранитьВерсии                   = ДанныеФайла.ХранитьВерсии;
		РедактируетТекущийПользователь  = ДанныеФайла.РедактируетТекущийПользователь;
		Редактирует                     = ДанныеФайла.Редактирует;
	КонецЕсли;

	СтрокаОшибки = "";
	Если НЕ ВозможностьОсвободитьФайл(ОбъектСсылка, РедактируетТекущийПользователь, Редактирует, СтрокаОшибки) Тогда
		Предупреждение(СтрокаОшибки);
		Возврат Ложь;
	КонецЕсли;
	
	ПродолжитьРаботу = Истина;
	
	Если НеЗадаватьВопрос = Ложь Тогда
		
		Результат = Вопрос(
		  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		    НСтр("ru = 'Отмена редактирования файла ""%1"" может привести к потере Ваших изменений.
		               |Продолжить?'"), Строка(ОбъектСсылка)),
		РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);
		
		Если Результат <> КодВозвратаДиалога.Да Тогда
			ПродолжитьРаботу = Ложь;
		КонецЕсли;	
		
	КонецЕсли;	
	
	Если ПродолжитьРаботу Тогда
		
		РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
		
		РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаИОсвободитьФайл(ОбъектСсылка, ДанныеФайла, УникальныйИдентификатор);
		
		Если РасширениеПодключено Тогда
			НаЧтение = Истина;
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		КонецЕсли;
		
		Если Не НеЗадаватьВопрос Тогда
			ПоказатьОповещениеПользователя(
				НСтр("ru = 'Файл освобожден'"),
				ДанныеФайла.НавигационнаяСсылка,
				ДанныеФайла.ПолноеНаименованиеВерсии,
				БиблиотекаКартинок.Информация32);
		КонецЕсли;	
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции // ОсвободитьФайл()

// Процедура предназначена для освобождения файла. При этом не происходит
// обновления файла, а просто очищается его текущий держатель.
Процедура ОсвободитьФайлБезВопроса(ДанныеФайла, УникальныйИдентификатор = Неопределено) Экспорт
	
	РаботаСФайламиВызовСервера.ОсвободитьФайл(ДанныеФайла, УникальныйИдентификатор);
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	Если РасширениеПодключено Тогда
		НаЧтение = Истина;
		ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
		ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
	КонецЕсли;
	
	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Файл освобожден'"),
		ДанныеФайла.НавигационнаяСсылка,
		ДанныеФайла.ПолноеНаименованиеВерсии,
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры // ОсвободитьФайл()

// Процедура освобождает файлы по массиву ссылок
//
Процедура ОсвободитьФайлы(ОбъектыСсылка) Экспорт
	
	СписокНевозможноОсвободить = Новый СписокЗначений;

	// Получение массива данных Файлов
	ДанныеФайлов = РаботаСФайламиВызовСервера.ПолучитьДанныеФайла(ОбъектыСсылка);
	ВГраницаМассива  = ДанныеФайлов.ВГраница();	
	
	Для Инд = 0 По ВГраницаМассива Цикл
		ДанныеФайла = ДанныеФайлов[ВГраницаМассива - Инд];
		
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(
				ДанныеФайла.Ссылка, 
				ДанныеФайла.РедактируетТекущийПользователь, 
				ДанныеФайла.Редактирует, 
				СтрокаОшибки) Тогда // освободить невозможно
			
			СписокНевозможноОсвободить.Добавить(ДанныеФайла.Ссылка, СтрокаОшибки);
			ДанныеФайлов.Удалить(ВГраницаМассива - Инд);
		КонецЕсли;
	КонецЦикла;
	
	// Если освободить нельзя, то выдаем диалог
	Если СписокНевозможноОсвободить.Количество() > 0 Тогда 
		Если НЕ ДиалогВопросаСоСписком(
				СписокНевозможноОсвободить, 
				НСтр("ru = 'Освободить остальные файлы?'"),
				НСтр("ru = 'При попытке освободить файлы возникли следующие ошибки:'"),
				НСтр("ru = 'Освободить файлы'")) Тогда
			Возврат;
		КонецЕсли;
	Иначе
		Ответ = Вопрос(
		НСтр("ru = 'Освобождение файлов может привести к потере Ваших изменений.
		           |Освободить файлы?'"),
		РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);

		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	// Освободить файлы
	Для Каждого ДанныеФайла Из ДанныеФайлов Цикл
		
		РаботаСФайламиВызовСервера.ОсвободитьФайл(ДанныеФайла);
		
		Если РасширениеПодключено Тогда
			НаЧтение = Истина;
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		КонецЕсли;
		
		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Файл освобожден'"),
			ДанныеФайла.НавигационнаяСсылка,
			ДанныеФайла.ПолноеНаименованиеВерсии,
			БиблиотекаКартинок.Информация32);
		
	КонецЦикла;
	
КонецПроцедуры

// Процедура выполняет перенос файлов в другую папку - по массиву ссылок
//
Процедура ПеренестиФайлыВПапку(ОбъектыСсылка, Папка) Экспорт
	
	// Получение массива данных Файлов
	ДанныеФайлов = РаботаСФайламиВызовСервера.ПолучитьДанныеФайла(ОбъектыСсылка);

	Для Каждого ДанныеФайла Из ДанныеФайлов Цикл
		
		РаботаСФайламиВызовСервера.ПеренестиФайл(ДанныеФайла, Папка);
		
		ПоказатьОповещениеПользователя(
		НСтр("ru = 'Перенос файла'"),
		ДанныеФайла.НавигационнаяСсылка,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		    НСтр("ru = 'Файл ""%1"" перенесен в папку %2.'"), Строка(ДанныеФайла.Ссылка), Строка(Папка)),
			БиблиотекаКартинок.Информация32);

	КонецЦикла;	
		
КонецПроцедуры	

// Опубликовать - по массиву ссылок
//
Процедура ОпубликоватьФайлыПоСсылкам(Знач МассивФайлов, ИдентификаторФормы) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Получение массива данных файлов
	ДанныеФайлов = Новый Массив;
	РаботаСФайламиВызовСервера.ПолучитьДанныеДляМассиваФайлов(МассивФайлов, ДанныеФайлов);
	ВГраницаМассива  = ДанныеФайлов.ВГраница();
	
	Для Инд = 0 По ВГраницаМассива Цикл
		ДанныеФайла = ДанныеФайлов[ВГраницаМассива - Инд];
		
		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует, СтрокаОшибки) Тогда
			ДанныеФайлов.Удалить(ВГраницаМассива - Инд);
		КонецЕсли;
		
	КонецЦикла;	
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	
	ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
	
	СоздатьНовуюВерсию = Истина;
	СоздатьНовуюВерсиюДоступность = Истина;

	СтруктураПараметров = Новый Структура("ФайлСсылка, КомментарийКВерсии, СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность", 
		Неопределено, "", СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность);
	ФормаВозврата.УстановитьПараметрыИспользования(СтруктураПараметров);
	
	Результат = ФормаВозврата.ОткрытьМодально();
	Если ТипЗнч(Результат) <> Тип("Структура") Тогда
		Возврат;
	КонецЕсли;	
	
	КодВозврата = Результат.КодВозврата;
	Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;	
	
	СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
	КомментарийКВерсии = Результат.КомментарийКВерсии;
	
	Для Каждого Данные Из ДанныеФайлов Цикл
		
		ПоказыватьОповещение = Ложь;
		
		ОпубликоватьФайл(
					Данные.Ссылка, 
					ИдентификаторФормы, 
					Данные.ХранитьВерсии,
					Данные.РедактируетТекущийПользователь, 
					Данные.Редактирует,
					Данные.АвторТекущейВерсии,
					"",
					СоздатьНовуюВерсию,
					КомментарийКВерсии,
					ПоказыватьОповещение);
	КонецЦикла;
	
	ПоказатьОповещениеПользователя(  
		НСтр("ru = 'Сохранить изменения файлов'"),
		,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Сохранены изменения файлов (%1 из %2).'"), 
			ДанныеФайлов.Количество(), МассивФайлов.Количество()),
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры //ОпубликоватьФайлыПоСсылкам

// Процедура предназначена для опубликования файла без его освобождения
//
// Параметры:
//
Функция ОпубликоватьФайл(ОбъектСсылка, ИдентификаторФормы, Знач ХранитьВерсии = Неопределено,
			Знач РедактируетТекущийПользователь = Неопределено, 
			Знач Редактирует = Неопределено,
			Знач АвторТекущейВерсии = Неопределено,
			ПереданныйПолныйПутьКФайлу = "",
			СоздатьНовуюВерсию = Неопределено,
			КомментарийКВерсии = Неопределено,
			ПоказыватьОповещение = Истина) Экспорт
			
	Перем ДанныеФайла;
	Перем АдресВременногоХранилища;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();	

	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	Если РасширениеПодключено Тогда // код для тонкого (или толстого) клиента (или веб с подключенным расширением)

		ДанныеФайла = РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаИРабочийКаталог(ОбъектСсылка);
		
		ХранитьВерсии = ДанныеФайла.ХранитьВерсии;
	
		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует, СтрокаОшибки) Тогда
			Предупреждение(СтрокаОшибки);
			Возврат Ложь;
		КонецЕсли;

		ПолныйПутьКФайлу = ПереданныйПолныйПутьКФайлу;
		Если ПолныйПутьКФайлу = "" Тогда
			ПолныйПутьКФайлу = ФайловыеФункцииКлиент.ПолучитьПолныйПутьКФайлуВРабочемКаталоге(ДанныеФайла);
		КонецЕсли;
		
		НеМенятьЗаписьВРабочемКаталоге = Ложь;
		Если ПереданныйПолныйПутьКФайлу <> "" Тогда
			НеМенятьЗаписьВРабочемКаталоге = Истина;
		КонецЕсли;
		
		// Проверяем наличие файла на диске
		ФайлНовойВерсии = Новый Файл(ПолныйПутьКФайлу);
		Если НЕ ФайлНовойВерсии.Существует() Тогда
			
			СтрокаПредупреждения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			    НСтр("ru = 'Не удалось загрузить файл ""%1"" в информационную базу, т.к. он не найден на локальном компьютере'"),
			    Строка(ДанныеФайла.Ссылка));
			Если НЕ ПустаяСтрока(ПолныйПутьКФайлу) Тогда
				СтрокаПредупреждения = СтрокаПредупреждения + " (" + ПолныйПутьКФайлу + ").";	
			Иначе
				СтрокаПредупреждения = СтрокаПредупреждения + ".";	
			КонецЕсли;
			
			СтрокаПредупреждения = СтрокаПредупреждения + Символы.ПС + "Освободить файл?";
			                                                        			
			КодВозврата = Вопрос(СтрокаПредупреждения, РежимДиалогаВопрос.ДаНет);
			
			Если КодВозврата = КодВозвратаДиалога.Да Тогда
				ОсвободитьФайлБезВопроса(ДанныеФайла, ИдентификаторФормы);
			КонецЕсли;
				
			Возврат Ложь;
			
		КонецЕсли;
		
		// Запрашиваем комментарий и признак хранения версии
		Если СоздатьНовуюВерсию = Неопределено Тогда

			ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
			
			СоздатьНовуюВерсию = Истина;
			СоздатьНовуюВерсиюДоступность = Истина;
			
			Если ДанныеФайла.ХранитьВерсии Тогда
				СоздатьНовуюВерсию = Истина;
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если ДанныеФайла.АвторТекущейВерсии <> ДанныеФайла.Редактирует Тогда
					СоздатьНовуюВерсиюДоступность = Ложь;
				Иначе
					СоздатьНовуюВерсиюДоступность = Истина;
				КонецЕсли;			
			Иначе
				СоздатьНовуюВерсию = Ложь;
				СоздатьНовуюВерсиюДоступность = Ложь;
			КонецЕсли;	
			
			СтруктураПараметров = Новый Структура("ФайлСсылка, КомментарийКВерсии, СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность", 
				ДанныеФайла.Ссылка, "", СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность);
			ФормаВозврата.УстановитьПараметрыИспользования(СтруктураПараметров);
			
			Результат = ФормаВозврата.ОткрытьМодально();
			Если ТипЗнч(Результат) <> Тип("Структура") Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			КодВозврата = Результат.КодВозврата;
			Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
			КомментарийКВерсии = Результат.КомментарийКВерсии;
			
		Иначе //  СоздатьНовуюВерсию и КомментарийКВерсии переданы извне
			
			Если ХранитьВерсии Тогда
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если АвторТекущейВерсии <> Редактирует Тогда
					СоздатьНовуюВерсию = Истина;
				КонецЕсли;			
				
			Иначе
				СоздатьНовуюВерсию = Ложь;
			КонецЕсли;	
			
		КонецЕсли;
			
		Интерактивно = Ложь;
		ВыбранныйПутьКФайлу = "";
		
		ИмяФайлаСПутемВременное = "";
		
		РазмерВМб = ФайлНовойВерсии.Размер() / (1024 * 1024);
		ВремяИзменения = ФайлНовойВерсии.ПолучитьВремяИзменения();
		ВремяИзмененияУниверсальное = ФайлНовойВерсии.ПолучитьУниверсальноеВремяИзменения();
		РазмерФайла = ФайлНовойВерсии.Размер();
		
		// Файл с признаком шифрован - при публикации снова шифруем для тех же сертификатов
		Если ДанныеФайла.Зашифрован Тогда
			
			МассивСертификатов = Новый Массив;
			МенеджерКриптографии = ЭлектроннаяЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
			
			Для Каждого СтруктураСертификата Из ДанныеФайла.МассивСертификатовШифрования Цикл
				
				Сертификат = Новый СертификатКриптографии(СтруктураСертификата.Сертификат);
				МассивСертификатов.Добавить(Сертификат);
				
			КонецЦикла;	
			
			ИмяФайлаСПутемШифрованное = ПолныйПутьКФайлу + ".crp";
			МенеджерКриптографии.Зашифровать(ПолныйПутьКФайлу, ИмяФайлаСПутемШифрованное, МассивСертификатов);
			ИмяФайлаСПутемВременное = ПолныйПутьКФайлу + ".bak";
			ПереместитьФайл(ПолныйПутьКФайлу, ИмяФайлаСПутемВременное);
			ПереместитьФайл(ИмяФайлаСПутемШифрованное, ПолныйПутьКФайлу);
			
		КонецЕсли;	
		
		ИмяФайла = ФайлНовойВерсии.Имя;
		
		ТекстПояснения =
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Выполняется передача файла ""%1"" (%2 Мб)...
				|Пожалуйста, подождите.'"),
		    ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
		
		Состояние(ТекстПояснения);

		ПомещаемыеФайлы = Новый Массив;
		Описание = Новый ОписаниеПередаваемогоФайла(ПолныйПутьКФайлу, "");
		ПомещаемыеФайлы.Добавить(Описание);
		
		ПомещенныеФайлы = Новый Массив;
		
		Если ПоместитьФайлы(ПомещаемыеФайлы, ПомещенныеФайлы, , Интерактивно, ИдентификаторФормы) Тогда
			Состояние();
			
			Если ПомещенныеФайлы.Количество() = 1 Тогда
				АдресВременногоХранилища = ПомещенныеФайлы[0].Хранение;
			КонецЕсли;

			ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
			ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
			
			ОтносительныйПутьКФайлу = "";
			
			ИмяБезРасширения = ФайлНовойВерсии.ИмяБезРасширения;
			Расширение = ФайлНовойВерсии.Расширение;
			
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			
			Если ДанныеФайла.РабочийКаталогВладельца <> "" Тогда // есть рабочий каталог
				ОтносительныйПутьКФайлу = ПолныйПутьКФайлу;
			Иначе
				Позиция = Найти(ПолныйПутьКФайлу, ИмяКаталога);
				Если Позиция <> 0 Тогда
					ОтносительныйПутьКФайлу = Сред(ПолныйПутьКФайлу, СтрДлина(ИмяКаталога) + 1);
				КонецЕсли;
			КонецЕсли;
			
			Если НЕ ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ИзвлекатьТекстыФайловНаСервере Тогда
				АдресВременногоХранилищаТекста = ФайловыеФункцииКлиентСервер.ИзвлечьТекстВоВременноеХранилище(
					ПолныйПутьКФайлу, ИдентификаторФормы);
			Иначе
				АдресВременногоХранилищаТекста = "";
			КонецЕсли;
			
			ЭтоВебКлиент = Ложь;
			
			ТекстНеИзвлеченНаКлиенте = Ложь;
			#Если ВебКлиент Тогда
				ТекстНеИзвлеченНаКлиенте = Истина;
			#КонецЕсли	
			
			РаботаСФайламиВызовСервера.ОпубликоватьФайл(
				ДанныеФайла.Ссылка, 
				СоздатьНовуюВерсию,
				АдресВременногоХранилища,
				КомментарийКВерсии,
				ВремяИзменения,
				ВремяИзмененияУниверсальное,
				РазмерФайла,
				ИмяБезРасширения,
				Расширение,
				ОтносительныйПутьКФайлу,
				ПолныйПутьКФайлу,
				АдресВременногоХранилищаТекста,
				ЭтоВебКлиент,
				ТекстНеИзвлеченНаКлиенте,
				ВРабочемКаталогеВладельца,
				НеМенятьЗаписьВРабочемКаталоге,
				ИдентификаторФормы);
				
			Если ПоказыватьОповещение Тогда
				ПоказатьОповещениеПользователя(
					НСтр("ru = 'Новая версия сохранена'"),
					ДанныеФайла.НавигационнаяСсылка,
					ДанныеФайла.ПолноеНаименованиеВерсии,
					БиблиотекаКартинок.Информация32);
			КонецЕсли;	
				
			// удаляем зашифрованный файл из кеша
			Если ДанныеФайла.Зашифрован Тогда
				ПереместитьФайл(ИмяФайлаСПутемВременное, ПолныйПутьКФайлу);
			КонецЕсли;	
				
		Иначе
			Состояние();
		КонецЕсли;
		
	Иначе // веб клиент и нет расширения работы с файлами

		Если ХранитьВерсии = Неопределено Тогда
			ДанныеФайла 				= РаботаСФайламиВызовСервера.ПолучитьДанныеФайла(ОбъектСсылка);
			ХранитьВерсии 					= ДанныеФайла.ХранитьВерсии;
			РедактируетТекущийПользователь 	= ДанныеФайла.РедактируетТекущийПользователь;
			Редактирует 					= ДанныеФайла.Редактирует;
			АвторТекущейВерсии				= ДанныеФайла.АвторТекущейВерсии;
		КонецЕсли;

		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ОбъектСсылка, РедактируетТекущийПользователь, Редактирует, СтрокаОшибки) Тогда
			Предупреждение(СтрокаОшибки);
			Возврат Ложь;
		КонецЕсли;
		
		ПолныйПутьКФайлу = "";

		Если СоздатьНовуюВерсию = Неопределено Тогда
			
			// Запрашиваем комментарий и признак хранения версии
			ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
			
			СоздатьНовуюВерсию = Истина;
			СоздатьНовуюВерсиюДоступность = Истина;
			
			Если ХранитьВерсии Тогда
				СоздатьНовуюВерсию = Истина;
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если АвторТекущейВерсии <> Редактирует Тогда
					СоздатьНовуюВерсиюДоступность = Ложь;
				Иначе
					СоздатьНовуюВерсиюДоступность = Истина;
				КонецЕсли;			
			Иначе
				СоздатьНовуюВерсию = Ложь;
				СоздатьНовуюВерсиюДоступность = Ложь;
			КонецЕсли;	

			СтруктураПараметров = Новый Структура("ФайлСсылка, КомментарийКВерсии, СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность", 
				ОбъектСсылка, "", СоздатьНовуюВерсию, СоздатьНовуюВерсиюДоступность);
			ФормаВозврата.УстановитьПараметрыИспользования(СтруктураПараметров);
			
			Результат = ФормаВозврата.ОткрытьМодально();
			Если ТипЗнч(Результат) <> Тип("Структура") Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			КодВозврата = Результат.КодВозврата;
			Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
			КомментарийКВерсии = Результат.КомментарийКВерсии;
			
		Иначе //  СоздатьНовуюВерсию и КомментарийКВерсии переданы извне
			
			Если ХранитьВерсии Тогда
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если АвторТекущейВерсии <> Редактирует Тогда
					СоздатьНовуюВерсию = Истина;
				КонецЕсли;			
				
			Иначе
				СоздатьНовуюВерсию = Ложь;
			КонецЕсли;	
			
		КонецЕсли;
		
		Интерактивно = Истина;
		
		ВыбранныйПутьКФайлу = "";
		ПоказатьНапоминаниеПередПоместитьФайл();
		Если ПоместитьФайл(АдресВременногоХранилища, ПолныйПутьКФайлу, ВыбранныйПутьКФайлу, Интерактивно, ИдентификаторФормы) Тогда
			
			ИмяБезРасширения = "";
			Расширение = "";
			ВремяИзменения = ТекущаяДата(); // Т.к. не можем получить дату модификации файла на диске
			ВремяИзмененияУниверсальное = УниверсальноеВремя(ТекущаяДата());
			РазмерФайла = 0;				// Т.к. не можем получить размер файла на диске
			
			ОтносительныйПутьКФайлу = "";
			АдресВременногоХранилищаТекста = "";

			СтрокиПути = ФайловыеФункцииКлиентСервер.РазложитьСтрокуПоТочкамИСлэшам(ВыбранныйПутьКФайлу);
			Если СтрокиПути.Количество() >= 2 Тогда
				Расширение = СтрокиПути[СтрокиПути.Количество()-1];
				ИмяБезРасширения = СтрокиПути[СтрокиПути.Количество()-2];
			КонецЕсли;

			ЭтоВебКлиент = Истина;
			
			ТекстНеИзвлеченНаКлиенте = Ложь;
			#Если ВебКлиент Тогда
				ТекстНеИзвлеченНаКлиенте = Истина;
			#КонецЕсли	
			
			ВРабочемКаталогеВладельца = Ложь;
			
			РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаИОпубликоватьФайл(
				ОбъектСсылка, 
				ДанныеФайла,
				СоздатьНовуюВерсию,
				АдресВременногоХранилища,
				КомментарийКВерсии,
				ВремяИзменения,
				ВремяИзмененияУниверсальное,
				РазмерФайла,
				ИмяБезРасширения,
				Расширение,
				ОтносительныйПутьКФайлу,
				ПолныйПутьКФайлу,
				АдресВременногоХранилищаТекста,
				ЭтоВебКлиент,
				ТекстНеИзвлеченНаКлиенте,
				ВРабочемКаталогеВладельца,
				ИдентификаторФормы);
				
			Если ПоказыватьОповещение Тогда
				ПоказатьОповещениеПользователя(
					НСтр("ru = 'Новая версия сохранена'"),
					ДанныеФайла.НавигационнаяСсылка,
					ДанныеФайла.ПолноеНаименованиеВерсии,
					БиблиотекаКартинок.Информация32);
			КонецЕсли;	
		
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции // ОпубликоватьФайл()

// Процедура предназначена для интерактивного создания нового Файла
// В частности, происходит вызов диалога выбора режима создания Файла
// Параметры:
//	ВладелецФайла - определяет группу, в которой создается Элемент, если
//		группа неизвестна в момент вызова этого метода - там будет Неопределено
Процедура СозданиеНовогоФайла(ВладелецФайла, ФормаВладелец, РежимСоздания = 1, НеОткрыватьКарточкуПослеСозданияИзФайла = Неопределено) Экспорт
	
	Форма = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВыбораВариантаСозданияНовогоФайла();
	Форма.УстановитьПараметрыИспользования(РежимСоздания);
	РежимСозданияРезультат = Форма.ОткрытьМодально();
	
	Если ТипЗнч(РежимСозданияРезультат) = Тип("Число") Тогда
		СоздатьФайл(РежимСозданияРезультат, ВладелецФайла, ФормаВладелец, НеОткрыватьКарточкуПослеСозданияИзФайла);
	КонецЕсли;
	
КонецПроцедуры // СозданиеНовогоФайла()

// Процедура предназначена для копирования существующего Файла
// Параметры:
//	ФайлОснование - откуда копируется Файл (тип - СправочникСсылка)
Процедура СкопироватьФайл(ВладелецФайла, ФайлОснование) Экспорт
	
	Параметры = Новый Структура("ФайлОснование, ВладелецФайла", ФайлОснование, ВладелецФайла);
	Форма = ОткрытьФорму("Справочник.Файлы.ФормаОбъекта", Параметры);
	
КонецПроцедуры // СкопироватьФайл()

// При переименовании Файл и ВерсияФайла обновляет информацию в рабочем каталоге (имя файла на диске и в регистре)
Процедура ОбновитьИнформациюВРабочемКаталоге(ТекущаяВерсия, НовоеИмя) Экспорт
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	ПолноеИмяФайла = "";
	
	ВРабочемКаталогеНаЧтение = Истина;
	ВРабочемКаталогеВладельца = Ложь;
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(Неопределено, ТекущаяВерсия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	Если ФайлВРабочемКаталоге = Ложь Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		Файл = Новый Файл(ПолноеИмяФайла);
		ТолькоИмя = Файл.Имя;
		РазмерФайла = Файл.Размер();
		ПутьБезИмени = Лев(ПолноеИмяФайла, СтрДлина(ПолноеИмяФайла) - СтрДлина(ТолькоИмя));
		НовоеПолноеИмя = ПутьБезИмени + НовоеИмя + Файл.Расширение;
		ПереместитьФайл(ПолноеИмяФайла, НовоеПолноеИмя);
		
		РаботаСФайламиВызовСервера.УдалитьИзРегистра(ТекущаяВерсия);
		РаботаСФайламиВызовСервера.ЗанестиИнформациюФайлаВРегистр(ТекущаяВерсия, НовоеПолноеИмя, ИмяКаталога, ВРабочемКаталогеНаЧтение, РазмерФайла, ВРабочемКаталогеВладельца);
	Исключение
	КонецПопытки;
	
КонецПроцедуры

// Перерегистрировать В рабочем каталоге с другим флагом НаЧтение - если там вообще есть такой Файл
Процедура ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца)
	// Если Файл без файла - ничего не делаем в рабочем каталоге
	Если ДанныеФайла.Версия.Пустая() Тогда 
		Возврат;
	КонецЕсли;

	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	ПолноеИмяФайла = "";
	
	ВРабочемКаталогеНаЧтение = Истина;
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ДанныеФайла.ТекущаяВерсия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	Если ФайлВРабочемКаталоге = Ложь Тогда
		Возврат;
	КонецЕсли;
	
	РаботаСФайламиВызовСервера.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.ТекущаяВерсия, ПолноеИмяФайла, ИмяКаталога, НаЧтение, 0, ВРабочемКаталогеВладельца);
	Файл = Новый Файл(ПолноеИмяФайла);
	Файл.УстановитьТолькоЧтение(НаЧтение);	
КонецПроцедуры

// Удаление файла со снятием атрибута readonly
Процедура УдалитьФайл(ПолноеИмяФайла, ЗадаватьВопрос = Неопределено, ШапкаВопроса = Неопределено) Экспорт
	ПодтверждатьПриУдаленииИзЛокальногоКэшаФайлов = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПодтверждатьПриУдаленииИзЛокальногоКэшаФайлов;
	Если ЗадаватьВопрос <> Неопределено Тогда
		ПодтверждатьПриУдаленииИзЛокальногоКэшаФайлов = ЗадаватьВопрос;
	КонецЕсли;		
	
	Если ПодтверждатьПриУдаленииИзЛокальногоКэшаФайлов = Истина Тогда
		ТекстВопроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Удалить файл ""%1"" из основного рабочего каталога?'"), ПолноеИмяФайла);
		
		Если ШапкаВопроса <> Неопределено Тогда
			ТекстВопроса = ШапкаВопроса + Символы.ПС + Символы.ПС + ТекстВопроса;
		КонецЕсли;	
		
		Если Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;	
	
	Файл = Новый Файл(ПолноеИмяФайла);
	Файл.УстановитьТолькоЧтение(Ложь);
	УдалитьФайлы(ПолноеИмяФайла);
КонецПроцедуры

// Получает Файл из информационной базы на чтение на локальный диск - в локальный кэш
// и возвращает путь к этому файлу в параметре
Функция ПолучитьФайлВерсииВЛокальныйКэшФайловНаЧтение(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы = Неопределено)
	
	ПолноеИмяФайла = "";
	НаЧтение = Истина;
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	
	ВРабочемКаталогеНаЧтение = Истина;
	ВРабочемКаталогеВладельца = Ложь;
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ДанныеФайла.Версия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	Если НЕ ФайлВРабочемКаталоге Тогда
		Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
	КонецЕсли;
	
	// Получаем путь файла в рабочем каталоге - с проверкой на уникальность
	ИмяФайлаСПутем = ПолноеИмяФайла;
	Если ИмяФайлаСПутем = "" Тогда
		Предупреждение(НСтр("ru = 'Ошибка помещения файла в локальный кэш файлов.'"));
		Возврат Ложь;
	КонецЕсли;
	
	// Ниже - уже известно, что Файл в рабочем каталоге есть. 
	// Надо проверить его дату модификации и принять решение что делать дальше
	// - перезаписать, спросить пользователя и т.д.
	
	ФайлВерсии = Новый Файл(ПолноеИмяФайла);
	ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
	РазмерФайлаНаДиске = ФайлВерсии.Размер();
	РазмерФайлаВБазе = ДанныеФайла.Размер;
	
	РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
	Если РазницаДат < 0 Тогда
		РазницаДат = -РазницаДат;
	КонецЕсли;
	
	Если РазницаДат <= 1 Тогда // 1 секунда - допустимая разница (на Win95 может быть такое)
		// Дата одинаковая, но размер отличается - странно, но возможно	
		Если РазмерФайлаВБазе <> 0 И РазмерФайлаНаДиске <> РазмерФайлаВБазе Тогда
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("РазмерФайлаНаСервере",     	РазмерФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("РазмерВРабочемКаталоге",      РазмерФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Сообщение",            		НСтр("ru = 'Размер файла в рабочем каталоге и на сервере отличается. Перезаписать файл в рабочем каталоге?'"));
			
			Ответ = ОткрытьФормуМодально("ОбщаяФорма.РазмерФайлаВРабочемКаталогеОтличается", ПараметрыОткрытияФормы);
			
			Если Ответ = КодВозвратаДиалога.Да Тогда // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда // Открыть существующий
				Возврат Истина;
			Иначе  // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			КонецЕсли;
		КонецЕсли;
		
		Возврат Истина; // Все совпадает - и дата, и размер
	ИначеЕсли ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда // В рабочем каталоге более старый
		Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
			
			Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более раннюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять из информационной базы и перезаписать?'");
			ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
			
			Ответ = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
			
			Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
				Возврат Истина;
			ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
		Иначе // В рабочем каталоге на чтение
			// Перезапишем ни о чем не спросив
			УдалитьФайл(ПолноеИмяФайла);
			Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
		КонецЕсли;
	ИначеЕсли ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
		ЗанятМной = (ДанныеФайла.Редактирует = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ТекущийПользователь);
		Если (ВРабочемКаталогеНаЧтение = Ложь) И ЗанятМной Тогда // В рабочем каталоге на редактирование и занят текущим пользователем
			Возврат Истина; // Ничего делать не надо
		Иначе // В рабочем каталоге на чтение
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
			
			Сообщение = НСтр("ru = 'Файл на локальном компьютере имеет более позднюю дату, возможно, он был изменен. Открыть существующий или взять с сервера и перезаписать?'");
			ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
			
			Результат = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
			
			Если Результат = КодВозвратаДиалога.Да Тогда  // Открыть существующий
				Возврат Истина;
			ИначеЕсли Результат = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			ИначеЕсли Результат = КодВозвратаДиалога.Нет Тогда  // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;
КонецФункции // ПолучитьФайлВерсииВРабочийКаталог()

// Получает Файл из информационной базы на редактирование на локальный диск - в локальный кэш
// и возвращает путь к этому файлу в параметре
Функция ПолучитьФайлВерсииВЛокальныйКэшФайловНаРедактирование(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы = Неопределено)
	ПолноеИмяФайла = "";
	НаЧтение = Ложь;
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	РазмерФайлаВБазе = ДанныеФайла.Размер;
	
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	
	ВРабочемКаталогеНаЧтение = Истина;
	ВРабочемКаталогеВладельца = Ложь;
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ДанныеФайла.Версия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	Если ФайлВРабочемКаталоге = Ложь Тогда
		Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
	КонецЕсли;

	// Получаем путь файла в рабочем каталоге - с проверкой на уникальность
	ИмяФайлаСПутем = ПолноеИмяФайла;
	Если ИмяФайлаСПутем = "" Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Ошибка помещения файла в локальный кэш файлов.'"));
		Возврат Ложь;
	КонецЕсли;
	
	// Ниже - уже известно, что Файл в рабочем каталоге есть. 
	// Надо проверить его дату модификации и принять решение что делать дальше
	// - перезаписать, спросить пользователя и т.д.
	
	ФайлВерсии = Новый Файл(ПолноеИмяФайла);
	ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
	РазмерФайлаНаДиске = ФайлВерсии.Размер();
	
	РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
	Если РазницаДат < 0 Тогда
		РазницаДат = -РазницаДат;
	КонецЕсли;
	
	Если РазницаДат <= 1 Тогда // 1 секунда - допустимая разница (на Win95 может быть такое)
		// Дата одинаковая, но размер отличается - странно, но возможно	
		Если РазмерФайлаВБазе <> 0 И РазмерФайлаНаДиске <> РазмерФайлаВБазе Тогда
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("РазмерФайлаНаСервере",     	РазмерФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("РазмерВРабочемКаталоге",      РазмерФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Сообщение",            		НСтр("ru = 'Размер файла в рабочем каталоге и на сервере отличается. Перезаписать файл в рабочем каталоге?'"));
			
			Ответ = ОткрытьФормуМодально("ОбщаяФорма.РазмерФайлаВРабочемКаталогеОтличается", ПараметрыОткрытияФормы);
			
			Если Ответ = КодВозвратаДиалога.Да Тогда // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда // Открыть существующий
				Возврат Истина;
			Иначе // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			КонецЕсли;
		КонецЕсли;
		
		// Все совпадает - и дата, и размер
		Если ВРабочемКаталогеНаЧтение = НаЧтение Тогда
			Возврат Истина;
		Иначе
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			ПеререгистрироватьВРабочемКаталоге(ДанныеФайла.Версия, ИмяФайлаСПутем, НаЧтение, ВРабочемКаталогеВладельца);
			Возврат Истина;
		КонецЕсли;
	ИначеЕсли ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда // В рабочем каталоге более старый
		Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
			
			Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более раннюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
			ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
			
			Ответ = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
			
			Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
				Возврат Истина;
			ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
		Иначе // В рабочем каталоге на чтение
			// Перезапишем ни о чем не спросив
			УдалитьФайл(ПолноеИмяФайла);
			Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
		КонецЕсли;
	ИначеЕсли ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
		
		Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
			Возврат Истина; // Ничего делать не надо
		Иначе // В рабочем каталоге на чтение
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
			
			Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более позднюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
			ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
			
			Ответ = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
			
			Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
				Возврат Истина;
			ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;	
КонецФункции // ПолучитьФайлВерсииВРабочийКаталог()

// Получает Файл из информационной базы на чтение на локальный диск - в рабочий каталог папки
// и возвращает путь к этому файлу в параметре
Функция ПолучитьФайлВерсииВРабочийКаталогНаЧтение(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы = Неопределено)
	
	Перем Версия;
	Перем ДатаПомещения;	
	
	НаЧтение = Истина;
	ВРабочемКаталогеВладельца = Истина;
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	
	Если ПолноеИмяФайла = "" Тогда
		ПолноеИмяФайла = ДанныеФайла.РабочийКаталогВладельца + ДанныеФайла.ПолноеНаименованиеВерсии + "." + ДанныеФайла.Расширение;
	КонецЕсли;
	
	// находим в рабочем каталоге по пути, а не по ВерсииФайла
	Владелец = Неопределено;
	НомерВерсии = Неопределено;
	ВРегистреНаЧтение = Неопределено;
	ВРегистреКодФайла = Неопределено;
	ВРегистреПапка = Неопределено;
	ФайлЕстьВРегистре = РаботаСФайламиВызовСервера.НайтиВРегистреПоПути(ПолноеИмяФайла, Версия, ДатаПомещения, Владелец, НомерВерсии, 
		ВРегистреНаЧтение, ВРегистреКодФайла, ВРегистреПапка);
		
	Если ФайлЕстьВРегистре Тогда
		// проверить что уже есть Файл по этому пути
		ФайлНаДиске = Новый Файл(ПолноеИмяФайла);
		Если НЕ ФайлНаДиске.Существует() Тогда
			РаботаСФайламиВызовСервера.УдалитьИзРегистра(Версия);
			ФайлЕстьВРегистре = Ложь;
		КонецЕсли;	
	КонецЕсли;
	
	Если НЕ ФайлЕстьВРегистре Тогда // на Файл нет ссылки в регистре
		
		// проверить что уже есть Файл по этому пути
		ФайлНаДиске = Новый Файл(ПолноеИмяФайла);
		Если ФайлНаДиске.Существует() Тогда
			
			ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
			ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
			РазмерФайлаВБазе = ДанныеФайла.Размер;

			ДатаФайлаНаДиске = ФайлНаДиске.ПолучитьВремяИзменения();
			РазмерФайлаНаДиске = ФайлНаДиске.Размер();
			
			РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
			Если РазницаДат < 0 Тогда
				РазницаДат = -РазницаДат;
			КонецЕсли;
			
			// размер и дата модификации одинаковы - используем его - зарегистрируем в кеше
			Если РазницаДат <= 1 И РазмерФайлаВБазе = РазмерФайлаНаДиске Тогда
				ФайлНаДиске.УстановитьТолькоЧтение(НаЧтение);
				ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
				ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
				РаботаСФайламиВызовСервера.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.Версия, ПолноеИмяФайла, ИмяКаталога, НаЧтение, РазмерФайлаВБазе, ВРабочемКаталогеВладельца);
				Возврат Истина;	// используем находящийся на диске Файл
			КонецЕсли;
			
			Если РазницаДат > 1 Тогда
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ПолноеИмяФайла);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				
				Если ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда
					ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
				Иначе	
					ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
				КонецЕсли;	
				
				Сообщение = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Файл ""%1"" в рабочем каталоге на локальном компьютере уже есть, но его дата изменения отличается от даты в информационной базе. Открыть файл из локального каталога или взять из информационной базы и перезаписать?'"),
					Строка(ДанныеФайла.Ссылка));
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					ФайлНаДиске.УстановитьТолькоЧтение(НаЧтение);
					ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
					ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
					РаботаСФайламиВызовСервера.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.Версия, ПолноеИмяФайла, ИмяКаталога, НаЧтение, РазмерФайлаВБазе, ВРабочемКаталогеВладельца);
					Возврат Истина;
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена ИЛИ Ответ = Неопределено Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла);
					Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
									  
    		Иначе
				СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				                      НСтр("ru = 'Файл ""%3"" в рабочем каталоге уже есть, но его размер отличается от даты на сервере. 
									  | Размер файла в рабочем каталоге: %1
									  | Размер файла на сервере: %2
									  |Переименуйте его или переместите в другой каталог. '"),
				                      РазмерФайлаНаДиске, РазмерФайлаВБазе, ПолноеИмяФайла);			
									  
				Предупреждение(СтрокаСообщения);
				Возврат Ложь; // отмена операции
								  
			КонецЕсли;					  
		КонецЕсли;	
		
		// на Файл нет ссылки в регистре и файла на диске тоже нет
		Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
	КонецЕсли; // на Файл нет ссылки в регистре	 
	
	
	// Файл по пути в рабочем каталоге имеет ссылку в регистре сведений
	Если Версия <> ДанныеФайла.ТекущаяВерсия Тогда // в раб каталоге лежит Файл не той ВерсииФайла (или вообще другой объект Файл)
		
		Если Владелец = ДанныеФайла.Ссылка И ВРегистреНаЧтение = Истина Тогда // на диске тот же Файл, но другой ВерсииФайла - и при этом на чтение
			Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
		КонецЕсли;
		
		СтрокаСообщения = "";
			
		СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							  НСтр("ru = 'В рабочем каталоге уже есть файл ""%1"", связанный с другим файлом информационной базы. 
							  | Код файла на сервере: %2
							  | Код файла на локальном компьютере: %3 '"),
							  ПолноеИмяФайла,
							  ДанныеФайла.КодФайла, 
							  ВРегистреКодФайла);			
							  
		Если ДанныеФайла.Владелец = ВРегистреПапка Тогда // одна и та же папка
			СтрокаСообщения = СтрокаСообщения + Символы.ПС + НСтр("ru = 'Переименуйте один из файлов в информационной базе.'");
		Иначе
			СтрокаСообщения = СтрокаСообщения + Символы.ПС + НСтр("ru = 'Измените рабочий каталог одной из папок в информационной базе
				| (У двух папок не должно быть одинакового рабочего каталога).'");
		КонецЕсли;	
								  
		Предупреждение(СтрокаСообщения);
		Возврат Ложь;
		
	Иначе // Файл по пути в рабочем каталоге - нужной нам версии и на него есть ссылка в регистре
		
		// Ниже - уже известно, что Файл в рабочем каталоге есть. 
		// Надо проверить его дату модификации и принять решение что делать дальше
		// - перезаписать, спросить пользователя и т.д.
		
		ИмяФайлаСПутем = ПолноеИмяФайла;
		ВРабочемКаталогеНаЧтение = ВРегистреНаЧтение;
	
		ФайлВерсии = Новый Файл(ПолноеИмяФайла);
		ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
		РазмерФайлаНаДиске = ФайлВерсии.Размер();
		РазмерФайлаВБазе = ДанныеФайла.Размер;
		
		РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
		Если РазницаДат < 0 Тогда
			РазницаДат = -РазницаДат;
		КонецЕсли;
		
		Если РазницаДат <= 1 Тогда // 1 секунда - допустимая разница (на Win95 может быть такое)
			// Дата одинаковая, но размер отличается - странно, но возможно	
			Если РазмерФайлаВБазе <> 0 И РазмерФайлаНаДиске <> РазмерФайлаВБазе Тогда
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("РазмерФайлаНаСервере",     	РазмерФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("РазмерВРабочемКаталоге",      РазмерФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Сообщение",            		НСтр("ru = 'Размер файла в рабочем каталоге и на сервере отличается. Перезаписать файл в рабочем каталоге?'"));
				
				Ответ = ОткрытьФормуМодально("ОбщаяФорма.РазмерФайлаВРабочемКаталогеОтличается", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда // Открыть существующий
					Возврат Истина;
				Иначе  // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				КонецЕсли;
			КонецЕсли;
			
			Возврат Истина; // Все совпадает - и дата, и размер
		ИначеЕсли ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда // В рабочем каталоге более старый
			Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более раннюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
			Иначе // В рабочем каталоге на чтение
				// Перезапишем ни о чем не спросив
				УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
		ИначеЕсли ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
			ЗанятМной = (ДанныеФайла.Редактирует = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ТекущийПользователь);
			Если (ВРабочемКаталогеНаЧтение = Ложь) И ЗанятМной Тогда // В рабочем каталоге на редактирование и занят текущим пользователем
				Возврат Истина; // Ничего делать не надо
			Иначе // В рабочем каталоге на чтение
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере имеет более позднюю дату, возможно, он был изменен. Открыть существующий или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Результат = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Результат = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Результат = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Результат = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;
		
		Возврат Ложь;
	КонецЕсли;		
	
	
	Возврат Ложь;
КонецФункции // ПолучитьФайлВерсииВРабочийКаталог()

// Получает Файл из информационной базы на редактирование на локальный диск - в рабочий каталог папки
// и возвращает путь к этому файлу в параметре
Функция ПолучитьФайлВерсииВРабочийКаталогНаРедактирование(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы = Неопределено)
	
	Перем Версия;
	Перем ДатаПомещения;	
	
	НаЧтение = Ложь;
	ВРабочемКаталогеВладельца = Истина;
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	
	Если ПолноеИмяФайла = "" Тогда
		ПолноеИмяФайла = ДанныеФайла.РабочийКаталогВладельца + ДанныеФайла.ПолноеНаименованиеВерсии + "." + ДанныеФайла.Расширение;
	КонецЕсли;
	
	// находим в рабочем каталоге по пути, а не по ВерсииФайла
	Владелец = Неопределено;
	НомерВерсии = Неопределено;
	ВРегистреНаЧтение = Неопределено;
	ВРегистреКодФайла = Неопределено;
	ВРегистреПапка = Неопределено;
	ФайлЕстьВРегистре = РаботаСФайламиВызовСервера.НайтиВРегистреПоПути(ПолноеИмяФайла, Версия, ДатаПомещения, Владелец, НомерВерсии, 
		ВРегистреНаЧтение, ВРегистреКодФайла, ВРегистреПапка);
	
	Если ФайлЕстьВРегистре Тогда
		// проверить что уже есть Файл по этому пути
		ФайлНаДиске = Новый Файл(ПолноеИмяФайла);
		Если НЕ ФайлНаДиске.Существует() Тогда
			РаботаСФайламиВызовСервера.УдалитьИзРегистра(Версия);
			ФайлЕстьВРегистре = Ложь;
		КонецЕсли;	
	КонецЕсли;
	
	Если НЕ ФайлЕстьВРегистре Тогда // на Файл нет ссылки в регистре
		
		// проверить что уже есть Файл по этому пути
		ФайлНаДиске = Новый Файл(ПолноеИмяФайла);
		Если ФайлНаДиске.Существует() Тогда
			
			ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
			ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
			РазмерФайлаВБазе = ДанныеФайла.Размер;

			ДатаФайлаНаДиске = ФайлНаДиске.ПолучитьВремяИзменения();
			РазмерФайлаНаДиске = ФайлНаДиске.Размер();
			
			РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
			Если РазницаДат < 0 Тогда
				РазницаДат = -РазницаДат;
			КонецЕсли;
			
			// размер и дата модификации одинаковы - используем его - зарегистрируем в кеше
			Если РазницаДат <= 1 И РазмерФайлаВБазе = РазмерФайлаНаДиске Тогда
				ФайлНаДиске.УстановитьТолькоЧтение(НаЧтение);
				ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
				ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
				
				РаботаСФайламиВызовСервера.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.Версия, ПолноеИмяФайла, ИмяКаталога, НаЧтение, РазмерФайлаВБазе, ВРабочемКаталогеВладельца);
				Возврат Истина;	// используем находящийся на диске Файл
			КонецЕсли;
			
			Если РазницаДат > 1 Тогда
				СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				                      НСтр("ru = 'Файл ""%3"" в рабочем каталоге уже есть, но его дата изменения отличается от даты на сервере. 
									  | Дата изменения файла в рабочем каталоге: %1
									  | Дата изменения файла на сервере: %2
									  |Переименуйте его или переместите в другой каталог. '"),
				                      ДатаФайлаНаДиске, ДатаФайлаВБазе, ПолноеИмяФайла);
									  
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ПолноеИмяФайла);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				
				Если ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда
					ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
				Иначе	
					ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
				КонецЕсли;	
				
				Сообщение = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Файл ""%1"" в рабочем каталоге на локальном компьютере уже есть, но его дата изменения отличается от даты на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'"),
					Строка(ДанныеФайла.Ссылка));
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					ФайлНаДиске.УстановитьТолькоЧтение(НаЧтение);
					ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
					ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
					
					РаботаСФайламиВызовСервера.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.Версия, ПолноеИмяФайла, ИмяКаталога, НаЧтение, РазмерФайлаВБазе, ВРабочемКаталогеВладельца);
					Возврат Истина;	// используем находящийся на диске Файл
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена ИЛИ Ответ = Неопределено Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла);
					Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
									  
    		Иначе
				СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				                      НСтр("ru = 'Файл ""%3"" в рабочем каталоге уже есть, но его размер отличается от даты на сервере. 
									  | Размер файла в рабочем каталоге: %1
									  | Размер файла на сервере: %2
									  |Переименуйте его или переместите в другой каталог. '"),
				                      РазмерФайлаНаДиске, РазмерФайлаВБазе, ПолноеИмяФайла);			
									  
				Предупреждение(СтрокаСообщения);
				Возврат Ложь; // отмена операции
									  
			КонецЕсли;					  
		КонецЕсли;	
		
		// на Файл нет ссылки в регистре и файла на диске тоже нет
		Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
	КонецЕсли; // на Файл нет ссылки в регистре	 
	
	
	// Файл по пути в рабочем каталоге имеет ссылку в регистре сведений
	Если Версия <> ДанныеФайла.ТекущаяВерсия Тогда // в раб каталоге лежит Файл не той ВерсииФайла (или вообще другой объект Файл)
		
		Если Владелец = ДанныеФайла.Ссылка И ВРегистреНаЧтение = Истина Тогда // на диске тот же Файл, но другой ВерсииФайла - и при этом на чтение
			Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
		КонецЕсли;
		
		СтрокаСообщения = "";
			
		СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							  НСтр("ru = 'В рабочем каталоге уже есть файл ""%1"", связанный с другим файлом информационной базы. 
							  | Код файла на сервере: %2
							  | Код файла на локальном компьютере: %3 '"),
							  ПолноеИмяФайла,
							  ДанныеФайла.КодФайла, 
							  ВРегистреКодФайла);			
							  
		Если ДанныеФайла.Владелец = ВРегистреПапка Тогда // одна и та же папка
			СтрокаСообщения = СтрокаСообщения + Символы.ПС + НСтр("ru = 'Переименуйте один из файлов в информационной базе.'");
		Иначе
			СтрокаСообщения = СтрокаСообщения + Символы.ПС + НСтр("ru = 'Измените рабочий каталог одной из папок в информационной базе
				| (У двух папок не должно быть одинакового рабочего каталога).'");
		КонецЕсли;	
								  
		Предупреждение(СтрокаСообщения);
		Возврат Ложь;
		
	Иначе // Файл по пути в рабочем каталоге - нужной нам версии и на него есть ссылка в регистре
		
		// Ниже - уже известно, что Файл в рабочем каталоге есть. 
		// Надо проверить его дату модификации и принять решение что делать дальше
		// - перезаписать, спросить пользователя и т.д.
		
		ИмяФайлаСПутем = ПолноеИмяФайла;
		ВРабочемКаталогеНаЧтение = ВРегистреНаЧтение;
	
		ФайлВерсии = Новый Файл(ПолноеИмяФайла);
		ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
		РазмерФайлаНаДиске = ФайлВерсии.Размер();
		РазмерФайлаВБазе = ДанныеФайла.Размер;
		
		РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
		Если РазницаДат < 0 Тогда
			РазницаДат = -РазницаДат;
		КонецЕсли;
		
		Если РазницаДат <= 1 Тогда // 1 секунда - допустимая разница (на Win95 может быть такое)
			// Дата одинаковая, но размер отличается - странно, но возможно	
			Если РазмерФайлаВБазе <> 0 И РазмерФайлаНаДиске <> РазмерФайлаВБазе Тогда
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("РазмерФайлаНаСервере",     	РазмерФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("РазмерВРабочемКаталоге",      РазмерФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Сообщение",            		НСтр("ru = 'Размер файла в рабочем каталоге и на сервере отличается. Перезаписать файл в рабочем каталоге?'"));
				
				Ответ = ОткрытьФормуМодально("ОбщаяФорма.РазмерФайлаВРабочемКаталогеОтличается", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда // Открыть существующий
					Возврат Истина;
				Иначе // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				КонецЕсли;
			КонецЕсли;
			
			// Все совпадает - и дата, и размер
			Если ВРабочемКаталогеНаЧтение = НаЧтение Тогда
				Возврат Истина;
			Иначе
				ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
				ПеререгистрироватьВРабочемКаталоге(ДанныеФайла.Версия, ИмяФайлаСПутем, НаЧтение, ВРабочемКаталогеВладельца);
				Возврат Истина;
			КонецЕсли;
		ИначеЕсли ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда // В рабочем каталоге более старый
			Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более раннюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
			Иначе // В рабочем каталоге на чтение
				// Перезапишем ни о чем не спросив
				УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
		ИначеЕсли ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
			
			Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
				Возврат Истина; // Ничего делать не надо
			Иначе // В рабочем каталоге на чтение
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более позднюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;
		
		Возврат Ложь;
	КонецЕсли;		
	
	
	Возврат Ложь;
КонецФункции // ПолучитьФайлВерсииВРабочийКаталог()

// Получить Файл из информационной базы на локальный диск и возвращает путь
//к этому файлу в параметре
Функция ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы = Неопределено) Экспорт
	
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	Если ИмяКаталога = Неопределено ИЛИ ПустаяСтрока(ИмяКаталога) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	РабочийКаталогВладельца = ДанныеФайла.РабочийКаталогВладельца;
	
	НаЧтение = ДанныеФайла.НаЧтение;
	Если (НаЧтение И РабочийКаталогВладельца = "") Или ДанныеФайла.Версия <> ДанныеФайла.ТекущаяВерсия Тогда 
		Возврат ПолучитьФайлВерсииВЛокальныйКэшФайловНаЧтение(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы);
	ИначеЕсли РабочийКаталогВладельца = "" Тогда
		Возврат ПолучитьФайлВерсииВЛокальныйКэшФайловНаРедактирование(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы);
	ИначеЕсли НаЧтение И РабочийКаталогВладельца <> "" Тогда 
		Возврат ПолучитьФайлВерсииВРабочийКаталогНаЧтение(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы);
	ИначеЕсли НаЧтение = Ложь И РабочийКаталогВладельца <> "" Тогда
		Возврат ПолучитьФайлВерсииВРабочийКаталогНаРедактирование(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы);
	КонецЕсли;
	
КонецФункции // ПолучитьФайлВерсииВРабочийКаталог()

// Получить Файл с сервера и зарегистрировать в рабочем каталоге
Функция ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайлаВРабочемКаталоге, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы)
	
	ПолноеИмяФайла = "";
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	
	ВРабочемКаталогеНаЧтение = Истина;
	ВРабочемКаталогеВладельца = Ложь;
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ДанныеФайла.Версия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	Если ФайлВРабочемКаталоге Тогда
		// Получаем путь файла в рабочем каталоге - с проверкой на уникальность
		ИмяФайлаСПутем = ПолноеИмяФайла;
		Если ИмяФайлаСПутем = "" Тогда
			Предупреждение(НСтр("ru = 'Ошибка помещения файла в рабочий каталог.'"));
			Возврат Ложь;
		КонецЕсли;
		
		// Ниже - уже известно, что Файл в рабочем каталоге есть. 
		// Надо проверить его дату модификации и принять решение что делать дальше
		// - перезаписать, спросить пользователя и т.д.
		
		ФайлВерсии = Новый Файл(ПолноеИмяФайла);
		ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
		РазмерФайлаНаДиске = ФайлВерсии.Размер();
		РазмерФайлаВБазе = ДанныеФайла.Размер;
		
		РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
		Если РазницаДат < 0 Тогда
			РазницаДат = -РазницаДат;
		КонецЕсли;
		
		Если РазницаДат <= 1 Тогда // 1 секунда - допустимая разница (на Win95 может быть такое)
			// Дата одинаковая, но размер отличается - странно, но возможно	
			Если РазмерФайлаВБазе <> 0 И РазмерФайлаНаДиске <> РазмерФайлаВБазе Тогда
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("РазмерФайлаНаСервере",     	РазмерФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("РазмерВРабочемКаталоге",      РазмерФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Сообщение",            		НСтр("ru = 'Размер файла в рабочем каталоге и на сервере отличается. Перезаписать файл в рабочем каталоге?'"));
				
				Ответ = ОткрытьФормуМодально("ОбщаяФорма.РазмерФайлаВРабочемКаталогеОтличается", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда // Открыть существующий
					Возврат Истина;
				Иначе  // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				КонецЕсли;
			КонецЕсли;
			
			// Все совпадает - и дата, и размер - удаляем и потом получаем в рабочий каталог папки
			УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
			
		ИначеЕсли ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда // В рабочем каталоге более старый
			Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более раннюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
				КонецЕсли;
			Иначе // В рабочем каталоге на чтение
				// Перезапишем ни о чем не спросив
				УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
			КонецЕсли;
		ИначеЕсли ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
			ЗанятМной = (ДанныеФайла.Редактирует = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ТекущийПользователь);
			Если (ВРабочемКаталогеНаЧтение = Ложь) И ЗанятМной Тогда // В рабочем каталоге на редактирование и занят текущим пользователем
				Возврат Истина; // Ничего делать не надо - т.е. не надо удалять из локального кеша и класть в рабочий каталог - т.к. пропадут изменения
			Иначе // В рабочем каталоге на чтение
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере имеет более позднюю дату, возможно, он был изменен. Открыть существующий или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Результат = ОткрытьФормуМодально("ОбщаяФорма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Результат = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Результат = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Результат = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайлаВРабочемКаталоге, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
КонецФункции

// Функция предназначена для открытия файла соответствующим приложением
//
Процедура ОткрытьФайлПриложением(ДанныеФайла, ИмяОткрываемогоФайла)
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	Если РасширениеПодключено Тогда
		// Открыть Файл
		Попытка
			
			ЗапуститьПриложение(ИмяОткрываемогоФайла);
			
		Исключение
			
			Инфо = ИнформацияОбОшибке();
			Предупреждение(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			                      НСтр("ru = 'Описание=""%1""'"),
			                      Инфо.Описание));
			
		КонецПопытки;
	КонецЕсли;
КонецПроцедуры // ОткрытьФайл()

// Сохранение на диск Файла
// 
Функция СохранитьКак(ДанныеФайла) Экспорт
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	Если РасширениеПодключено Тогда

		// проверим - если файл уже есть в кеше, и он новее чем в базе - дадим диалог с выбором
		ПутьКФайлуВКеше = "";
		Если ДанныеФайла.РедактируетТекущийПользователь Тогда
			ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
			ВРабочемКаталогеНаЧтение = Истина;
			ВРабочемКаталогеВладельца = Ложь;
			ПолноеИмяФайла = "";
			ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ДанныеФайла.Версия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
			
			Если ФайлВРабочемКаталоге = Истина Тогда
				
				ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
				ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);

				ФайлВерсии = Новый Файл(ПолноеИмяФайла);
				ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
				
				Если ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
				
					ПараметрыОткрытияФормы = Новый Структура;
					ПараметрыОткрытияФормы.Вставить("Файл",       ПолноеИмяФайла);
					
					Сообщение = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Дата изменения файла ""%1"" на локальном компьютере более поздняя, чем в информационной базе. Возможно, он был изменен.'"), 
						Строка(ДанныеФайла.Ссылка));
					ПараметрыОткрытияФормы.Вставить("Сообщение",  Сообщение);
					
					Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.РежимСозданияФайлаДляСохранитьКак", ПараметрыОткрытияФормы);
					
					Если Ответ = КодВозвратаДиалога.Отмена ИЛИ Ответ = Неопределено Тогда
						Возврат "";
					КонецЕсли;	
					
					Если Ответ = 1 Тогда // На основе файла на локальном компьютере
						ПутьКФайлуВКеше = ПолноеИмяФайла;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;	
		
		ПутьВыбора = ДанныеФайла.ПапкаДляСохранитьКак;
		Если ПутьВыбора = Неопределено ИЛИ ПутьВыбора = "" Тогда
			
			ПутьВыбора = "";
		#Если НЕ ВебКлиент Тогда	

			Если СтандартныеПодсистемыКлиентПовтИсп.ПараметрыРаботыКлиента().ЭтоБазоваяВерсияКонфигурации Тогда
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Данная операция не поддерживается в базовой версии.'"));
				Возврат "";
			КонецЕсли;
			
			Оболочка = Новый COMОбъект("MSScriptControl.ScriptControl");
			Оболочка.Language = "vbscript";
			Оболочка.AddCode("
				|Function SpecialFoldersName(Name)
				|set Shell=CreateObject(""WScript.Shell"")
				|SpecialFoldersName=Shell.SpecialFolders(Name)
				|End Function");
			ПутьВыбора = Оболочка.Run("SpecialFoldersName", "MyDocuments");
		#КонецЕсли	
		
		КонецЕсли;

		Пароль = "";
		СохранятьСРасшифровкой = Ложь;
		РасширениеДляЗашифрованныхФайлов = "";
		Если ДанныеФайла.Зашифрован Тогда
			
			ПредставленияСертификатов = "";
			Для Каждого СтруктураСертификата Из ДанныеФайла.МассивСертификатовШифрования Цикл
				
				Отпечаток = СтруктураСертификата.Отпечаток;
				
				ТолькоВЛичномХранилище = Истина;
				Сертификат = ЭлектроннаяЦифроваяПодписьКлиент.ПолучитьСертификатПоОтпечатку(Отпечаток, ТолькоВЛичномХранилище);
				Если Сертификат <> Неопределено Тогда // тут собираем только личные сертификаты - с закрытым ключом
					Если НЕ ПустаяСтрока(ПредставленияСертификатов) Тогда
						ПредставленияСертификатов = ПредставленияСертификатов + Символы.ПС;
					КонецЕсли;
					ПредставленияСертификатов = ПредставленияСертификатов + СтруктураСертификата.Представление;
				КонецЕсли;
				
			КонецЦикла;	
			
			Заголовок = НСтр("ru = 'Выбор режима сохранения'");
			ПараметрыФормы = Новый Структура("Заголовок, ПредставленияСертификатов", 
				Заголовок, ПредставленияСертификатов);
			КодВозврата = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВыборСохраненияШифрованногоФайла", ПараметрыФормы);
			Если ТипЗнч(КодВозврата) = Тип("Структура") Тогда
				
				Пароль = КодВозврата.Пароль;
				РасширениеДляЗашифрованныхФайлов = КодВозврата.РасширениеДляЗашифрованныхФайлов;
				
				Если КодВозврата.СохранятьСРасшифровкой = 1 Тогда
					СохранятьСРасшифровкой = Истина;
				Иначе
					СохранятьСРасшифровкой = Ложь;
				КонецЕсли;	
				
			Иначе
				Возврат "";
			КонецЕсли;
			
		КонецЕсли;	
		
		ИмяСРасширением = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		Расширение = ДанныеФайла.Расширение;
		
		Если НЕ СохранятьСРасшифровкой Тогда
			Если НЕ ПустаяСтрока(РасширениеДляЗашифрованныхФайлов) Тогда
				ИмяСРасширением = ИмяСРасширением + "." + РасширениеДляЗашифрованныхФайлов;
				Расширение = РасширениеДляЗашифрованныхФайлов;
			КонецЕсли;	
		КонецЕсли;	
		
		// выбираем путь к файлу на диске
		ВыборФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
		ВыборФайла.МножественныйВыбор = Ложь;
		ВыборФайла.ПолноеИмяФайла = ИмяСРасширением;
		Фильтр = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Все файлы (*.%1)|*.%1'"), Расширение, Расширение);
		ВыборФайла.Фильтр = Фильтр;
		ВыборФайла.Каталог = ПутьВыбора;
		
		Если ВыборФайла.Выбрать() Тогда
			
			АдресФайла = ДанныеФайла.НавигационнаяСсылкаТекущейВерсии;
			
			ИмяФайла = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
			РазмерВМб = ДанныеФайла.Размер / (1024 * 1024);
			
			ТекстПояснения =
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Выполняется сохранение файла ""%1"" (%2 Мб)...
					|Пожалуйста, подождите.'"),
				ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
				
			Состояние(ТекстПояснения);	
			
			Файл = Новый Файл(ВыборФайла.ПолноеИмяФайла);
			Если Файл.Существует() Тогда
				Если ПутьКФайлуВКеше <> ВыборФайла.ПолноеИмяФайла Тогда
					Файл.УстановитьТолькоЧтение(Ложь);
					УдалитьФайлы(ВыборФайла.ПолноеИмяФайла);
				КонецЕсли;
			КонецЕсли;
			
			Если ПутьКФайлуВКеше = "" Тогда
				
				ПередаваемыеФайлы = Новый Массив;
				Описание = Новый ОписаниеПередаваемогоФайла(ВыборФайла.ПолноеИмяФайла, АдресФайла);
				ПередаваемыеФайлы.Добавить(Описание);
				
				ПутьКФайлу = Файл.Путь;
				Если Прав(ПутьКФайлу,1) <> "\" Тогда
					ПутьКФайлу = ПутьКФайлу + "\";
				КонецЕсли;
				
				// Сохраним Файл из БД на диск
				Если ПолучитьФайлы(ПередаваемыеФайлы,, ПутьКФайлу, Ложь) Тогда
					
					// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
					Если ЭтоАдресВременногоХранилища(АдресФайла) Тогда
						УдалитьИзВременногоХранилища(АдресФайла);
					КонецЕсли;
					
					Если СохранятьСРасшифровкой Тогда
						ИмяФайлаСПутем = ВыборФайла.ПолноеИмяФайла;
						
						Попытка
							МенеджерКриптографии = ЭлектроннаяЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
							МенеджерКриптографии.ПарольДоступаКЗакрытомуКлючу = Пароль;
							
							ИмяФайлаСПутемРасшифрованное = ИмяФайлаСПутем + ".dec";
							МенеджерКриптографии.Расшифровать(ИмяФайлаСПутем, ИмяФайлаСПутемРасшифрованное);
							
							УдалитьФайлы(ИмяФайлаСПутем);
							ПереместитьФайл(ИмяФайлаСПутемРасшифрованное, ИмяФайлаСПутем);
						Исключение
							УдалитьФайлы(ИмяФайлаСПутем);
							ВызватьИсключение;
						КонецПопытки;
					КонецЕсли;
					
					
					НовыйФайл = Новый Файл(ВыборФайла.ПолноеИмяФайла);
					
					ДатаСоздаваемогоФайлаНаДиске = ДанныеФайла.ДатаМодификацииУниверсальная;
					ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаСоздаваемогоФайлаНаДиске);
					
					НовыйФайл.УстановитьВремяИзменения(ДатаСоздаваемогоФайлаНаДиске);

					Состояние(НСтр("ru = 'Файл успешно сохранен'"), , ВыборФайла.ПолноеИмяФайла);
				КонецЕсли;
			Иначе
				Если ПутьКФайлуВКеше <> ВыборФайла.ПолноеИмяФайла Тогда
					КопироватьФайл(ПутьКФайлуВКеше, ВыборФайла.ПолноеИмяФайла);
				КонецЕсли;
				Состояние(НСтр("ru = 'Файл успешно сохранен'"), , ВыборФайла.ПолноеИмяФайла);
			КонецЕсли;
			
			ПутьВыбораПрежний = ПутьВыбора;
			Файл = Новый Файл(ВыборФайла.ПолноеИмяФайла);
			ПутьВыбора = Файл.Путь;
			Если ПутьВыбораПрежний <> ПутьВыбора Тогда
				ОбщегоНазначения.ХранилищеОбщихНастроекСохранить("НастройкиПрограммы", "ПапкаДляСохранитьКак",  ПутьВыбора);
			КонецЕсли;
			
			Возврат ВыборФайла.ПолноеИмяФайла;
		КонецЕсли;
		
	Иначе  // веб клиент
		АдресФайла = ДанныеФайла.НавигационнаяСсылкаТекущейВерсии;
		
		ИмяФайла = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		РазмерВМб = ДанныеФайла.Размер / (1024 * 1024);
		
		ТекстПояснения =
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Выполняется сохранение файла ""%1"" (%2 Мб)...
				|Пожалуйста, подождите.'"),
			ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
			
		Состояние(ТекстПояснения);	
		
		// Сохраним Файл из БД на диск
		ПолучитьФайл(АдресФайла, ИмяФайла, Истина);
			
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(АдресФайла) Тогда
			УдалитьИзВременногоХранилища(АдресФайла);
		КонецЕсли;
	КонецЕсли;	
	
	Возврат "";
КонецФункции

// Процедура открывает проводник Windows, позиционируясь на Файл
// 
Процедура КаталогФайла(ДанныеФайла) Экспорт
	
	// Если Файл без файла  - эта операция не имеет смысла
	Если ДанныеФайла.Версия.Пустая() Тогда 
		Возврат;
	КонецЕсли;
	
#Если НЕ ВебКлиент Тогда
	ПолноеИмяФайла = ПолучитьПутьФайлаВРабочемКаталоге(ДанныеФайла);
	Если ФайловыеФункцииКлиент.ОткрытьПроводникСФайлом(ПолноеИмяФайла) = Истина Тогда
		Возврат;
	КонецЕсли;
	
	ИмяФайла = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
	
	КодВозврата = Вопрос(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
	НСтр("ru = 'Файл ""%1"" отсутствует в рабочем каталоге! Получить файл с сервера?'"), ИмяФайла),
	РежимДиалогаВопрос.ДаНет);
	
	Если КодВозврата = КодВозвратаДиалога.Да Тогда
		ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла);
		ФайловыеФункцииКлиент.ОткрытьПроводникСФайлом(ПолноеИмяФайла);
	КонецЕсли;
	
	// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
	Если ЭтоАдресВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии) Тогда
		УдалитьИзВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии);
	КонецЕсли;
#Иначе
	Предупреждение(НСтр("ru = 'В Веб-клиенте данная функция не поддерживается.'"));
#КонецЕсли
КонецПроцедуры

// Открывает диалог вопроса со списком Файлов или информации о Файлах
//
Функция ДиалогВопросаСоСписком(Список, СообщениеВопрос, СообщениеЗаголовок, Заголовок)
	Параметры = Новый Структура;	
	Параметры.Вставить("СообщениеВопрос", СообщениеВопрос);
	Параметры.Вставить("СообщениеЗаголовок", СообщениеЗаголовок);
	Параметры.Вставить("Заголовок", Заголовок);
	Параметры.Вставить("Файлы", Список);
	
	Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.ФормаВопроса", Параметры);
	Возврат (Результат = КодВозвратаДиалога.Да);

КонецФункции

// Обработчик события Перетаскивание в формах объектов - владельцев Файл (кроме формы ХранилищеФайлов)
//
Процедура ОбработкаПеретаскиванияВЛинейныйСписок(ПараметрыПеретаскивания, ВладелецФайлаСписка, ЭтаФорма,
	НеОткрыватьКарточкуПослеСозданияИзФайла = Неопределено) Экспорт
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Файл") И ПараметрыПеретаскивания.Значение.ЭтоФайл() = Истина Тогда
		
		СоздатьДокументНаОсновеФайла(ПараметрыПеретаскивания.Значение.ПолноеИмя, ВладелецФайлаСписка, ЭтаФорма, НеОткрыватьКарточкуПослеСозданияИзФайла);
		
	ИначеЕсли ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Файл") И ПараметрыПеретаскивания.Значение.ЭтоФайл() = Ложь Тогда
		
		Предупреждение(Нстр("ru = 'Выберите для импорта только файлы, но не каталоги.'"));
		Возврат;
		
	ИначеЕсли ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("СправочникСсылка.Файлы") Тогда	
		
		ПеренестиФайлВПриложенныеФайлы(ПараметрыПеретаскивания.Значение, ВладелецФайлаСписка);	
		
	ИначеЕсли ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Массив") Тогда
		
		Если ПараметрыПеретаскивания.Значение.Количество() >= 1 И ТипЗнч(ПараметрыПеретаскивания.Значение[0]) = Тип("Файл") Тогда
			Для Каждого ФайлПринятый Из ПараметрыПеретаскивания.Значение Цикл
				Если Не ФайлПринятый.ЭтоФайл() Тогда // только файлы, но не каталоги
					Предупреждение(Нстр("ru = 'Выберите для импорта только файлы, но не каталоги.'"));
					Возврат;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		Если ПараметрыПеретаскивания.Значение.Количество() >= 1 И ТипЗнч(ПараметрыПеретаскивания.Значение[0]) = Тип("Файл") Тогда
			Для Каждого ФайлПринятый Из ПараметрыПеретаскивания.Значение Цикл
				НеОткрыватьКарточкуПослеСозданияИзФайла = Истина;
				СоздатьДокументНаОсновеФайла(ФайлПринятый.ПолноеИмя, ВладелецФайлаСписка, ЭтаФорма, НеОткрыватьКарточкуПослеСозданияИзФайла);
			КонецЦикла;
		КонецЕсли;
		
		Если ПараметрыПеретаскивания.Значение.Количество() >= 1 И ТипЗнч(ПараметрыПеретаскивания.Значение[0]) = Тип("СправочникСсылка.Файлы") Тогда
			ПеренестиФайлыВПриложенныеФайлы(ПараметрыПеретаскивания.Значение, ВладелецФайлаСписка);
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры

// переносит файл из одного списка приложенных файлов в другой
Процедура ПеренестиФайлВПриложенныеФайлы(ФайлСсылка, ВладелецФайла)

	Результат = РаботаСФайламиВызовСервера.ПолучитьДанныеДляПереносаВПриложенныеФайлы(ФайлСсылка, ВладелецФайла).Получить(ФайлСсылка);
	
	Если Результат = "Скопировать" Тогда
		
		СозданФайл = РаботаСФайламиВызовСервера.СкопироватьФайлВПриложенных(ФайлСсылка, ВладелецФайла);
		Оповестить("СозданФайл", Новый Структура("Владелец, Файл", ВладелецФайла, СозданФайл));
		
		ПоказатьОповещениеПользователя(
				"Создание:", 
				ПолучитьНавигационнуюСсылку(СозданФайл),
				Строка(СозданФайл),
				БиблиотекаКартинок.Информация32);
		
	ИначеЕсли Результат = "Обновить" Тогда	
		
		ОбновленФайл = РаботаСФайламиВызовСервера.ОбновитьФайлВПриложенных(ФайлСсылка, ВладелецФайла);
			
		ПоказатьОповещениеПользователя(
				"Изменение:", 
				ПолучитьНавигационнуюСсылку(ОбновленФайл),
				Строка(ОбновленФайл),
				БиблиотекаКартинок.Информация32);
		
	КонецЕсли;
	
КонецПроцедуры	

// переносит файлы из одного списка приложенных файлов в другой
Процедура ПеренестиФайлыВПриложенныеФайлы(МассивФайлов, ВладелецФайла)
	
	Если МассивФайлов.Количество() = 1 Тогда 
		ПеренестиФайлВПриложенныеФайлы(МассивФайлов[0], ВладелецФайла);
	Иначе
		
		Результат = РаботаСФайламиВызовСервера.ПолучитьДанныеДляПереносаВПриложенныеФайлы(МассивФайлов, ВладелецФайла);
		
		МассивОбновить = Новый Массив;
		МассивСкопировать = Новый Массив;
		Для Каждого ФайлСсылка Из МассивФайлов Цикл
			Если Результат.Получить(ФайлСсылка) = "Скопировать" Тогда
				МассивСкопировать.Добавить(ФайлСсылка);
			ИначеЕсли Результат.Получить(ФайлСсылка) = "Обновить" Тогда
				МассивОбновить.Добавить(ФайлСсылка);
			КонецЕсли;
		КонецЦикла;	
		
		Если МассивСкопировать.Количество() > 0 Тогда 
			РаботаСФайламиВызовСервера.СкопироватьФайлВПриложенных(МассивСкопировать, ВладелецФайла);
		КонецЕсли;	
		
		Если МассивОбновить.Количество() > 0 Тогда 
			РаботаСФайламиВызовСервера.ОбновитьФайлВПриложенных(МассивОбновить, ВладелецФайла);
		КонецЕсли;	
		
		ОбщееКоличество = МассивСкопировать.Количество() + МассивОбновить.Количество();
		Если ОбщееКоличество > 0 Тогда 
			
			ПолноеОписание = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Файлы (%1 шт) перенесены в %2'"),
				ОбщееКоличество,
				ВладелецФайла);
			
			ПоказатьОповещениеПользователя(
				НСтр("ru = 'Файлы перенесены'"), 
				,
				ПолноеОписание,
				БиблиотекаКартинок.Информация32);
				
		КонецЕсли;	
			
	КонецЕсли;	
	
КонецПроцедуры

// Выбирает на  диске файл и создает из него новую версию - реализация низкоуровневая
Процедура ОбновитьИзФайлаНаДискеРеализация(ДанныеФайла, ИдентификаторФормы, ДиалогПолноеИмяФайла, 
	СоздатьНовуюВерсию = Неопределено, КомментарийКВерсии = Неопределено) Экспорт
	
	// данные файла могли измениться - обновим
	ДанныеФайла = РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаИРабочийКаталог(ДанныеФайла.Ссылка);

	ПредыдущаяВерсия = ДанныеФайла.Версия;
	
	ФайлНаДиске = Новый Файл(ДиалогПолноеИмяФайла);
	ИмяИРасширениеФайлаНаДиске = ФайлНаДиске.Имя;
	ИмяИРасширениеФайлаВБазе = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
	ВремяИзмененияВыбранное = ФайлНаДиске.ПолучитьВремяИзменения();
	
	РедактируетТекущийПользователь = ДанныеФайла.РедактируетТекущийПользователь;
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	
	Если ВремяИзмененияВыбранное < ДатаФайлаВБазе Тогда // в кеше более новый
		СтрокаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					   НСтр("ru = 'Файл ""%1"" на сервере имеет более позднюю дату изменения (%2), чем выбранный файл (%3). 
					   |Операция прервана.'"), 
					   Строка(ДанныеФайла.Ссылка), ДатаФайлаВБазе, ВремяИзмененияВыбранное);
		Предупреждение(СтрокаОшибки);
		Возврат;
	КонецЕсли;
	
	
	// проверим  - есть ли файл в локальном кеше
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	ВРабочемКаталогеНаЧтение = Истина;
	ВРабочемКаталогеВладельца = Ложь;
	ПолноеИмяФайла = "";
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(Неопределено, ПредыдущаяВерсия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	
	Если РедактируетТекущийПользователь Тогда // файл уже был занят
		
		Если ФайлВРабочемКаталоге = Истина Тогда
			ФайлВКеше = Новый Файл(ПолноеИмяФайла);
			ВремяИзмененияВКеше = ФайлВКеше.ПолучитьВремяИзменения();
			
			Если ВремяИзмененияВыбранное < ВремяИзмененияВКеше Тогда // в кеше более новый
				СтрокаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							   НСтр("ru = 'Файл ""%1"" в рабочем каталоге имеет более позднюю дату изменения (%2), чем выбранный файл (%3). 
							   |Операция прервана.'"), 
							   Строка(ДанныеФайла.Ссылка), ВремяИзмененияВКеше, ВремяИзмененияВыбранное);
				Предупреждение(СтрокаОшибки);
				Возврат;
			КонецЕсли;
			
			#Если НЕ ВебКлиент Тогда
				Попытка
					// проверяем что файл занят приложением
					ТекстовыйДокумент = Новый ТекстовыйДокумент;
					ТекстовыйДокумент.Прочитать(ПолноеИмяФайла);
				Исключение
					СтрокаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								   НСтр("ru = 'Файл в основном рабочем каталоге
								   |""%1"" 
								   |открыт для редактирования. 
								   |Закончите редактирование перед выполнением обновления из файла на диске.'"), 
								   ПолноеИмяФайла);
					Предупреждение(СтрокаОшибки);
					Возврат;
				КонецПопытки;
			#КонецЕсли
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если ФайлВРабочемКаталоге И ИмяИРасширениеФайлаНаДиске <> ИмяИРасширениеФайлаВБазе Тогда
		Попытка
			УдалитьФайлИзРабочегоКаталога(ДанныеФайла.ТекущаяВерсия, Истина);
			ФайлВРабочемКаталоге = Ложь;
		Исключение
			Инфо = ИнформацияОбОшибке();
			Предупреждение(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								  НСтр("ru = 'Описание=""%1""'"), Инфо.Описание));
			
			Возврат;
		КонецПопытки;
	КонецЕсли;	

	Если Не РедактируетТекущийПользователь Тогда
		
		СтрокаОшибки = "";
		Если Не РаботаСФайламиКлиентСервер.МожноЛиЗанятьФайл(ДанныеФайла, СтрокаОшибки) Тогда
			Предупреждение(СтрокаОшибки);
			Возврат;
		КонецЕсли;
		
		СтрокаОшибки = "";
		Если Не РаботаСФайламиВызовСервера.ЗанятьФайл(ДанныеФайла, СтрокаОшибки, ИдентификаторФормы) Тогда 
			Предупреждение(СтрокаОшибки);
			Возврат;
		КонецЕсли;
		
		НаЧтение = Ложь;
		ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
		ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		
	КонецЕсли;
	
	ПереданныйПолныйПутьКФайлу = "";
	
	Если ФайлВРабочемКаталоге Тогда
		КопироватьФайл(ДиалогПолноеИмяФайла, ПолноеИмяФайла);
	Иначе
		ПереданныйПолныйПутьКФайлу = ДиалогПолноеИмяФайла;
	КонецЕсли;
	
	Если РедактируетТекущийПользователь Тогда // файл уже был занят
		
		ОпубликоватьФайл(ДанныеФайла.Ссылка, 
			ИдентификаторФормы,
			Неопределено,
			Неопределено, 
			Неопределено,
			Неопределено,
			ПереданныйПолныйПутьКФайлу,
			СоздатьНовуюВерсию, 
			КомментарийКВерсии);
			
	Иначе
		
		ЗакончитьРедактирование(
			ДанныеФайла.Ссылка, 
			ИдентификаторФормы,
			ДанныеФайла.ХранитьВерсии,
			ДанныеФайла.РедактируетТекущийПользователь,
			ДанныеФайла.Редактирует,
			ДанныеФайла.АвторТекущейВерсии,
			ПереданныйПолныйПутьКФайлу,
			СоздатьНовуюВерсию, 
			КомментарийКВерсии); 
			
	КонецЕсли;	
	
	Если ИмяИРасширениеФайлаНаДиске <> ИмяИРасширениеФайлаВБазе ИЛИ НЕ ФайлВРабочемКаталоге Тогда
		
		// обновим данные
		ДанныеФайла = РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаДляОткрытия(
			ДанныеФайла.Ссылка, Неопределено, ИдентификаторФормы);
			
		// получим в кеш
		ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла);
	КонецЕсли;	
КонецПроцедуры

// Выбирает на  диске файл и создает из него новую версию
// 
Функция ОбновитьИзФайлаНаДиске(ДанныеФайла, ИдентификаторФормы) Экспорт
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	Если РасширениеПодключено Тогда
	
		Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
		
		ПутьВыбора = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиПрограммы", "ПапкаДляОбновитьИзФайла");
		Если ПутьВыбора = Неопределено ИЛИ ПутьВыбора = "" Тогда
			
			#Если НЕ ВебКлиент Тогда
				
				Если СтандартныеПодсистемыКлиентПовтИсп.ПараметрыРаботыКлиента().ЭтоБазоваяВерсияКонфигурации Тогда
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Данная операция не поддерживается в базовой версии.'"));
					Возврат Ложь;
				КонецЕсли;
				
				Оболочка = Новый COMОбъект("MSScriptControl.ScriptControl");
				Оболочка.Language = "vbscript";
				Оболочка.AddCode("
					|Function SpecialFoldersName(Name)
					|set Shell=CreateObject(""WScript.Shell"")
					|SpecialFoldersName=Shell.SpecialFolders(Name)
					|End Function");
				ПутьВыбора = Оболочка.Run("SpecialFoldersName", "MyDocuments");
			#Иначе	
				ПутьВыбора = "";
			#КонецЕсли
		КонецЕсли;
		
		Диалог.Заголовок                   = НСтр("ru = 'Выбор файла'");
		Диалог.ПредварительныйПросмотр     = Ложь;
		Диалог.ПроверятьСуществованиеФайла = Ложь;
		Диалог.МножественныйВыбор          = Ложь;
		Диалог.Каталог					   = ПутьВыбора;
		Диалог.ПолноеИмяФайла			   = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение); 
		Диалог.Фильтр                      = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Файл (*.%1)|*.%1|Все файлы (*.*)|*.*'"), ДанныеФайла.Расширение, ДанныеФайла.Расширение);
		
		Если Диалог.Выбрать() Тогда
					
			ПутьВыбораПрежний = ПутьВыбора;
			ФайлНаДиске = Новый Файл(Диалог.ПолноеИмяФайла);
			ПутьВыбора = ФайлНаДиске.Путь;
			Если ПутьВыбораПрежний <> ПутьВыбора Тогда
				ОбщегоНазначения.ХранилищеОбщихНастроекСохранить("НастройкиПрограммы", "ПапкаДляОбновитьИзФайла",  ПутьВыбора);
			КонецЕсли;
			
			ОбновитьИзФайлаНаДискеРеализация(ДанныеФайла, ИдентификаторФормы, Диалог.ПолноеИмяФайла);
			
			Возврат Истина;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Процедура ПоказатьЗанятыеФайлыПриЗавершенииРаботы(Отказ) Экспорт
	
	ТекущийПользователь = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ТекущийПользователь;
	
	КоличествоЗанятыхФайлов = РаботаСФайламиВызовСервера.ПолучитьКоличествоЗанятыхФайлов(, ТекущийПользователь);
	Если КоличествоЗанятыхФайлов > 0 Тогда 
		
		ПараметрыФормы = Новый Структура;	
		ПараметрыФормы.Вставить("СообщениеВопрос", 		НСтр("ru = 'Завершить работу с программой?'"));
		ПараметрыФормы.Вставить("СообщениеЗаголовок", 	НСтр("ru = 'Следующие файлы заняты вами для редактирования:'"));
		ПараметрыФормы.Вставить("Заголовок", 			НСтр("ru = 'Завершение работы'"));
		ПараметрыФормы.Вставить("Редактирует", 			ТекущийПользователь);
		
		Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.СписокЗанятыхСВопросом", ПараметрыФормы);
		Если Результат <> КодВозвратаДиалога.Да Тогда 
			Отказ = Истина;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры	

// Шифрует Файл
Функция Зашифровать(ФайлСсылка,
					МассивСертификатов,
					УникальныйИдентификаторФормы,
					ДанныеФайла,
					МассивДанныхДляЗанесенияВБазу,
					МассивОтпечатков) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	МассивОтпечатков = Новый Массив;
	Для Каждого Сертификат Из МассивСертификатов Цикл
		Отпечаток = Base64Строка(Сертификат.Отпечаток);
		Представление = ЭлектроннаяЦифроваяПодписьКлиентСервер.ПолучитьПредставлениеПользователя(Сертификат.Субъект);
		ДвоичныеДанныеСертификата = Сертификат.Выгрузить();
		
		ОтпечатокСтруктура = Новый Структура("Отпечаток, Представление, Сертификат", Отпечаток, Представление, ДвоичныеДанныеСертификата);
		МассивОтпечатков.Добавить(ОтпечатокСтруктура);
	КонецЦикла;
	
	МассивОбъектовШифрования = Новый Массив;
	
	КоличествоВерсий = ДанныеФайла.КоличествоВерсий;
	
	Если КоличествоВерсий > 1 Тогда
		
		ТекстВопроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Сейчас будет выполнено шифрование всех %1 версий файла. Это может занять продолжительное время. Продолжить шифрование файла?'"),
			КоличествоВерсий);
		
		Если Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет) <> КодВозвратаДиалога.Да Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;
	
	МассивВерсий = РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаИНавигационнуюСсылкуВсехВерсийФайла(ФайлСсылка, УникальныйИдентификаторФормы);
	
	Если МассивВерсий.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Выполняется получение всех версий файла ""%1""'"), ФайлСсылка);
	Состояние(ТекстСообщения, 0);
	
	Счетчик = 0;
	Для Каждого СтруктураВерсии Из МассивВерсий Цикл
		
		Прогресс = Счетчик / МассивВерсий.Количество() * 100;
		Состояние(ТекстСообщения, Прогресс);
		
		ДанныеФайла = СтруктураВерсии.ДанныеФайла;
		АдресФайла = СтруктураВерсии.НавигационнаяСсылкаВерсии;
		
		ДвоичныеДанные = ПолучитьИзВременногоХранилища(АдресФайла);
		
		СтруктураДляШифрования = Новый Структура("ДвоичныеДанные, ВерсияСсылка, АдресФайла", 
													ДвоичныеДанные,
													СтруктураВерсии.ВерсияСсылка,
													АдресФайла);
			
		МассивОбъектовШифрования.Добавить(СтруктураДляШифрования);
		
		Счетчик = Счетчик + 1;
		
	КонецЦикла;
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Выполняется шифрование всех версий файла ""%1""'"),
		ФайлСсылка);
	Состояние(ТекстСообщения);
	
	МенеджерКриптографии = ЭлектроннаяЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
	
	МассивДанныхДляЗанесенияВБазу = Новый Массив;
	
	Для Каждого СтруктураДляШифрования Из МассивОбъектовШифрования Цикл
		
		ДвоичныеДанные = СтруктураДляШифрования.ДвоичныеДанные;
		ВерсияСсылка = СтруктураДляШифрования.ВерсияСсылка;
		
		ШифрованныйФайлДвоичныеДанные = МенеджерКриптографии.Зашифровать(ДвоичныеДанные, МассивСертификатов);
		АдресВременногоХранилища = ПоместитьВоВременноеХранилище(ШифрованныйФайлДвоичныеДанные, УникальныйИдентификаторФормы);
		
		ДанныеДляЗаписиНаСервере = Новый Структура("АдресВременногоХранилища, ВерсияСсылка, АдресФайла, АдресВременногоХранилищаТекста", 
			АдресВременногоХранилища, ВерсияСсылка, СтруктураДляШифрования.АдресФайла, "");
		МассивДанныхДляЗанесенияВБазу.Добавить(ДанныеДляЗаписиНаСервере);
		
	КонецЦикла;
	
	Состояние();
	
	Возврат Истина;
	
КонецФункции

// Расшифрует объект - Файл, Версия
Функция Расшифровать(ФайлСсылка, УникальныйИдентификаторФормы, ДанныеФайла,
	МассивДанныхДляЗанесенияВБазу) Экспорт
	
	КоличествоВерсий = ДанныеФайла.КоличествоВерсий;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключеноФайл = ПодключитьРасширениеРаботыСФайлами();
	
	ПредставленияСертификатов = "";
	Для Каждого СтруктураСертификата Из ДанныеФайла.МассивСертификатовШифрования Цикл
		
		Отпечаток = СтруктураСертификата.Отпечаток;
		
		ТолькоВЛичномХранилище = Истина; // тут собираем только личные сертификаты - с закрытым ключом
		Сертификат = ЭлектроннаяЦифроваяПодписьКлиент.ПолучитьСертификатПоОтпечатку(Отпечаток, ТолькоВЛичномХранилище);
		Если Сертификат <> Неопределено Тогда 
			Если НЕ ПустаяСтрока(ПредставленияСертификатов) Тогда
				ПредставленияСертификатов = ПредставленияСертификатов + Символы.ПС;
			КонецЕсли;
			ПредставленияСертификатов = ПредставленияСертификатов + СтруктураСертификата.Представление;
		КонецЕсли;
		
	КонецЦикла;	
	
	Пароль = "";
	Заголовок = НСтр("ru = 'Введите пароль для расшифровки'");
	ПараметрыФормы = Новый Структура("Заголовок, ПредставленияСертификатов, Файл", 
		Заголовок, ПредставленияСертификатов, ФайлСсылка);
	КодВозврата = ОткрытьФормуМодально("ОбщаяФорма.ВводПароляСОписаниями", ПараметрыФормы);
	Если ТипЗнч(КодВозврата) = Тип("Строка") Тогда
		Пароль = КодВозврата;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
	МассивОбъектовШифрования = Новый Массив;
	
	Если КоличествоВерсий > 1 Тогда
		
		ТекстВопроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Сейчас будет выполнена расшифровка всех %1 версий файла. Это может занять продолжительное время. Продолжить расшифровку файла?'"),
			КоличествоВерсий);
		
		Если Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет) <> КодВозвратаДиалога.Да Тогда
			Возврат Ложь;
		КонецЕсли;	
	КонецЕсли;	
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Выполняется получение всех версий файла ""%1""'"),
		ФайлСсылка);
		
	Состояние(ТекстСообщения, 0);
	МассивВерсий = РаботаСФайламиВызовСервера.ПолучитьДанныеФайлаИНавигационнуюСсылкуВсехВерсийФайла(ФайлСсылка, УникальныйИдентификаторФормы);
	
	Счетчик = 0;
	Для Каждого СтруктураВерсии Из МассивВерсий Цикл
		
		Прогресс = Счетчик / МассивВерсий.Количество() * 100;
		Состояние(ТекстСообщения, Прогресс);
		
		ДанныеФайла = СтруктураВерсии.ДанныеФайла;
		АдресФайла = СтруктураВерсии.НавигационнаяСсылкаВерсии;
		
		ДвоичныеДанные = ПолучитьИзВременногоХранилища(АдресФайла);
		
		СтруктураДляШифрования = Новый Структура("ДвоичныеДанные, ВерсияСсылка, АдресФайла, Расширение", 
			ДвоичныеДанные, СтруктураВерсии.ВерсияСсылка, АдресФайла, ДанныеФайла.Расширение);
			
		МассивОбъектовШифрования.Добавить(СтруктураДляШифрования);
		Счетчик = Счетчик + 1;
		
	КонецЦикла;	
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Выполняется расшифровка всех версий файла ""%1""'"),
		ФайлСсылка);
	Состояние(ТекстСообщения);
	
	МенеджерКриптографии = ЭлектроннаяЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
	МенеджерКриптографии.ПарольДоступаКЗакрытомуКлючу = Пароль;
	
	МассивДанныхДляЗанесенияВБазу = Новый Массив;
	ИзвлекатьТекстыФайловНаСервере = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ИзвлекатьТекстыФайловНаСервере;
	
	Для Каждого СтруктураДляШифрования Из МассивОбъектовШифрования Цикл
		
		ДвоичныеДанные = СтруктураДляШифрования.ДвоичныеДанные;
		ВерсияСсылка = СтруктураДляШифрования.ВерсияСсылка;
		
		ДвоичныеДанныеРасшифрованные = МенеджерКриптографии.Расшифровать(ДвоичныеДанные);
		АдресВременногоХранилища = ПоместитьВоВременноеХранилище(ДвоичныеДанныеРасшифрованные, УникальныйИдентификаторФормы);
		
		АдресВременногоХранилищаТекста = "";
		#Если НЕ ВебКлиент Тогда
			Если НЕ ИзвлекатьТекстыФайловНаСервере Тогда
				ПолныйПутьКФайлу = ПолучитьИмяВременногоФайла(СтруктураДляШифрования.Расширение);
				ДвоичныеДанныеРасшифрованные.Записать(ПолныйПутьКФайлу);
				
				АдресВременногоХранилищаТекста = ФайловыеФункцииКлиентСервер.ИзвлечьТекстВоВременноеХранилище(
					ПолныйПутьКФайлу, УникальныйИдентификаторФормы);
					
				УдалитьФайлы(ПолныйПутьКФайлу);	
			Иначе
				АдресВременногоХранилищаТекста = "";
			КонецЕсли;
		#КонецЕсли
		
		ДанныеДляЗаписиНаСервере = Новый Структура("АдресВременногоХранилища, ВерсияСсылка, АдресФайла, АдресВременногоХранилищаТекста", 
			АдресВременногоХранилища, ВерсияСсылка, СтруктураДляШифрования.АдресФайла, АдресВременногоХранилищаТекста);
		МассивДанныхДляЗанесенияВБазу.Добавить(ДанныеДляЗаписиНаСервере);
		
	КонецЦикла;
	
	Состояние();
	
	Возврат Истина;
	
КонецФункции	

// По окончании Зашифровать нотифицирует
Процедура ИнформироватьОШифровании(МассивФайловВРабочемКаталогеДляУдаления, ВладелецФайла, 
	ФайлСсылка) Экспорт
	
	ОповеститьОбИзменении(ФайлСсылка);
	Оповестить("ПрисоединенныйФайлЗашифрован", ВладелецФайла);
	Оповестить("ДанныеФайлаИзменены", ФайлСсылка);
	
	// удаляем из рабочего каталога все версии файла
	Для Каждого ПутьФайла Из МассивФайловВРабочемКаталогеДляУдаления Цикл
		УдалитьФайл(ПутьФайла, Ложь); // не задавать вопрос
	КонецЦикла;	
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Файл ""%1"" зашифрован'"),
		ФайлСсылка);
	Состояние(ТекстСообщения);
	
КонецПроцедуры	

// По окончании Расшифровать нотифицирует
Процедура ИнформироватьОРасшифровке(ВладелецФайла, ФайлСсылка) Экспорт
	
	ОповеститьОбИзменении(ФайлСсылка);
	Оповестить("ПрисоединенныйФайлЗашифрован", ВладелецФайла);
	Оповестить("ДанныеФайлаИзменены", ФайлСсылка);
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Файл ""%1"" расшифрован'"),
		ФайлСсылка);
	Состояние(ТекстСообщения);
	
КонецПроцедуры	

// Заносит информацию о подписях
Процедура ЗанестиИнформациюОПодписях(ФайлСсылка, Владелец, МассивДанныхДляЗанесенияВБазу, УникальныйИдентификатор = Неопределено) Экспорт
	
	РаботаСФайламиВызовСервера.ЗанестиИнформациюОПодписях(МассивДанныхДляЗанесенияВБазу, УникальныйИдентификатор);
	
	ОповеститьОбИзменении(ФайлСсылка);
	Оповестить("ОбъектПодписан", ФайлСсылка);
	Оповестить("ПрисоединенныйФайлПодписан", Владелец);
	
	Если МассивДанныхДляЗанесенияВБазу.Количество() = 1 Тогда
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Добавлена подпись из файла для ""%1""'"),
			ФайлСсылка);
	Иначе
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Добавлены подписи из файлов для ""%1""'"),
			ФайлСсылка);
	КонецЕсли;	
	
	Состояние(ТекстСообщения);
	
КонецПроцедуры

// Очистка рабочего каталога - для освобождения места - в первую очередь удаляет файлы 
// наиболее давно помещенные в рабочий каталог
Процедура ОчиститьРабочийКаталог(РазмерФайловВРабочемКаталоге, РазмерДобавляемогоФайла, ОчищатьВсе) Экспорт
#Если Не ВебКлиент Тогда
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	
	ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	
	ТаблицаФайлов = Новый Массив;
	
	МассивФайлов = НайтиФайлы(ИмяКаталога, "*.*");
	
	ОбходФайловТаблица(ИмяКаталога, МассивФайлов, ТаблицаФайлов);
	
	// Вызов сервера - для сортировки
	//  сортировка по дате - в начале будут самые давно помещенные в рабочий каталог
	РаботаСФайламиВызовСервера.СортироватьМассивСтруктур(ТаблицаФайлов);
	
	МаксРазмер = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().МаксимальныйРазмерЛокальногоКэшаФайлов;
	
	СреднийРазмерФайла = 1000;
	Если ТаблицаФайлов.Количество() <> 0 Тогда
		СреднийРазмерФайла = РазмерФайловВРабочемКаталоге / ТаблицаФайлов.Количество();
	КонецЕсли;
	
	СколькоНадоОсвободитьМеста = МаксРазмер / 10;
	Если СреднийРазмерФайла * 3 / 2 > СколькоНадоОсвободитьМеста Тогда
		СколькоНадоОсвободитьМеста = СреднийРазмерФайла * 3 / 2;
	КонецЕсли;
	
	СколькоОсталось = РазмерФайловВРабочемКаталоге + РазмерДобавляемогоФайла;	
	
	Для Каждого Строка из ТаблицаФайлов Цикл
		
		Если Строка.Версия.Пустая() Тогда
			ТекстВопроса =
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Файл ""%1%2"" не найден на сервере.
						   |Удалить его из рабочего каталога?'"),
				ИмяКаталога, Строка.Путь);
				
				
			Если ОчищатьВсе	= Ложь Тогда
				ТекстВопроса = Нстр("ru = 'Выполняется очистка рабочего каталога при добавлении файла.'") + Символы.ПС + Символы.ПС + ТекстВопроса;
			КонецЕсли;	
			
			КодВозврата = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);

			Если КодВозврата = КодВозвратаДиалога.Нет Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;

		ПолныйПуть = ИмяКаталога + Строка.Путь;
		ФайлНаДиске = Новый Файл(ПолныйПуть);
		ФайлНаДиске.УстановитьТолькоЧтение(Ложь);
		ШапкаВопроса = Нстр("ru = 'Выполняется очистка рабочего каталога при добавлении файла.'");
		УдалитьФайл(ПолныйПуть, Неопределено, ШапкаВопроса);
		
		ПутьСПодкаталогом = ИмяКаталога;
		позиция = Найти(Строка.Путь, "\");
		Если позиция <> 0 Тогда
			ПутьСПодкаталогом = ИмяКаталога + Лев(Строка.Путь, позиция);
		КонецЕсли;
		
		// Если каталог стал пуст - удалить его
		МассивФайловВКаталоге = НайтиФайлы(ПутьСПодкаталогом, "*.*");
		Если МассивФайловВКаталоге.Количество() = 0 Тогда
			Если ПутьСПодкаталогом <> ИмяКаталога Тогда
				УдалитьФайлы(ПутьСПодкаталогом);
			КонецЕсли;
		КонецЕсли;
	
		// Удалим из регистра сведений
		РаботаСФайламиВызовСервера.УдалитьИзРегистра(Строка.Версия);
		
		СколькоОсталось = СколькоОсталось - Строка.Размер;
		Если СколькоОсталось < МаксРазмер - СколькоНадоОсвободитьМеста Тогда
			Если НЕ ОчищатьВсе Тогда
				Прервать; // Освободили достаточно - выходим
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Если ОчищатьВсе Тогда
		РаботаСФайламиВызовСервера.ОчиститьВсеСвоиКромеЗанятых();
	КонецЕсли;
#КонецЕсли
КонецПроцедуры

// Рекурсивный обход файлов в рабочем каталоге и сбор информации о них
Процедура ОбходФайловТаблица(Путь, МассивФайлов, ТаблицаФайлов)
#Если Не ВебКлиент Тогда
	Перем Версия;
	Перем ДатаПомещения;
	
	ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	
	Для Каждого ВыбранныйФайл Из МассивФайлов Цикл
		
		Если ВыбранныйФайл.ЭтоКаталог() Тогда
			НовыйПуть = Строка(Путь);
			НовыйПуть = НовыйПуть + "\";
			НовыйПуть = НовыйПуть + Строка(ВыбранныйФайл.Имя);
			МассивФайловВКаталоге = НайтиФайлы(НовыйПуть, "*.*");
			
			Если МассивФайловВКаталоге.Количество() <> 0 Тогда
				ОбходФайловТаблица(НовыйПуть, МассивФайловВКаталоге, ТаблицаФайлов);
			КонецЕсли;
		
			Продолжить;
		КонецЕсли;
		
		// временные файлы Word не удаляем из рабочего каталога
		Если Лев(ВыбранныйФайл.Имя, 1) = "~" И ВыбранныйФайл.ПолучитьНевидимость() = Истина Тогда
			Продолжить;
		КонецЕсли;
		
		ОтносительныйПуть = Сред(ВыбранныйФайл.ПолноеИмя, СтрДлина(ИмяКаталога) + 1);
		
		// Если не найдем на диске - то минимальная дата 
		//  будет самой старой - и удалится при очистке из рабочего каталога самых старых файлов
		ДатаПомещения = Дата('00010101');
		
		Владелец = Неопределено;
		НомерВерсии = Неопределено;
		ВРегистреНаЧтение = Неопределено;
		ВРегистреКодФайла = Неопределено;
		ВРегистреПапка = Неопределено;
		ФайлЕстьВРегистре = РаботаСФайламиВызовСервера.НайтиВРегистреПоПути(ОтносительныйПуть, Версия, ДатаПомещения, Владелец, НомерВерсии, 
			ВРегистреНаЧтение, ВРегистреКодФайла, ВРегистреПапка);

		Если ФайлЕстьВРегистре Тогда
			РедактируетТекущийПользователь = РаботаСФайламиВызовСервера.ПолучитьРедактируетТекущийПользователь(Версия);

			// Если не занят текущим пользователем, можно удалить
			Если Не РедактируетТекущийПользователь Тогда
				Запись = Новый Структура;
				Запись.Вставить("Путь", ОтносительныйПуть);
				Запись.Вставить("Размер", ВыбранныйФайл.Размер());
				Запись.Вставить("Версия", Версия);
				Запись.Вставить("ДатаПомещенияВРабочийКаталог", ДатаПомещения);
				ТаблицаФайлов.Добавить(Запись);
			КонецЕсли;
		Иначе
			Запись = Новый Структура;
			Запись.Вставить("Путь", ОтносительныйПуть);
			Запись.Вставить("Размер", ВыбранныйФайл.Размер());
			Запись.Вставить("Версия", Версия);
			Запись.Вставить("ДатаПомещенияВРабочийКаталог", ДатаПомещения);
			ТаблицаФайлов.Добавить(Запись);
		КонецЕсли;
		
	КонецЦикла;
#КонецЕсли
	
КонецПроцедуры

// Удалить с диска и из регистра сведений
//
Процедура УдалитьФайлИзРабочегоКаталога(Ссылка, УдалитьДажеВРабочемКаталоге = Неопределено) Экспорт
	
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	
	ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	
	ВРабочемКаталогеНаЧтение = Ложь;
	ВРабочемКаталогеВладельца = Ложь;
	ПутьВРегистре = РаботаСФайламиВызовСервера.ПолучитьИмяФайлаСПутемИзРегистра(Ссылка, ИмяКаталога, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);	
	
	// Получить путь из регистра
	ИмяФайлаСПутем = ПутьВРегистре;
	Если ИмяФайлаСПутем <> "" Тогда
		
		// обычно в рабочем каталоге не удаляем - только если передан УдалитьДажеВРабочемКаталоге
		Если Не ВРабочемКаталогеВладельца ИЛИ УдалитьДажеВРабочемКаталоге = Истина Тогда
		
			ФайлНаДиске = Новый Файл(ИмяФайлаСПутем);
			Если ФайлНаДиске.Существует() Тогда
				файл = Новый Файл(ИмяФайлаСПутем);
				файл.УстановитьТолькоЧтение(Ложь);
				УдалитьФайл(ИмяФайлаСПутем);
				
				ПутьСПодкаталогом = ИмяКаталога;
				позиция = Найти(ПутьВРегистре, "\");
				Если позиция <> 0 Тогда
					ПутьСПодкаталогом = ИмяКаталога + Лев(ПутьВРегистре, позиция);
				КонецЕсли;
				
				МассивФайловВКаталоге = НайтиФайлы(ПутьСПодкаталогом, "*.*");
				Если МассивФайловВКаталоге.Количество() = 0 Тогда
					Если ПутьСПодкаталогом <> ИмяКаталога Тогда
						УдалитьФайлы(ПутьСПодкаталогом);
					КонецЕсли;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
	
	КонецЕсли;
	
	РаботаСФайламиВызовСервера.УдалитьИзРегистра(Ссылка);
	
КонецПроцедуры

// Получает относительный путь к файлу в рабочем каталоге - если есть в регистре сведений - оттуда,
// если нет - сгенерируем - и запишем в регистр сведений
//
Функция ПолучитьПутьФайлаВРабочемКаталоге(ДанныеФайла)
	
	ПутьДляВозврата = "";
	ИмяФайлаСПутем = "";
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	
	// Сперва пытаемся найти такую запись в регистре сведений
	ИмяФайлаСПутем = ДанныеФайла.ИмяФайлаСПутемВРабочемКаталоге;
	ВРабочемКаталогеНаЧтение = ДанныеФайла.ВРабочемКаталогеНаЧтение;
	
	Если ИмяФайлаСПутем <> "" Тогда
		// Тут надо еще на наличие на диске проверять
		ФайлНаДиске = Новый Файл(ИмяФайлаСПутем);
		Если ФайлНаДиске.Существует() Тогда
			Возврат ИмяФайлаСПутем;	
		КонецЕсли;
	КонецЕсли;
	
	// Формирование имени файла с расширением
	ИмяФайла = ДанныеФайла.ПолноеНаименованиеВерсии;
	Расширение = ДанныеФайла.Расширение;
	Если Не ПустаяСтрока(Расширение) Тогда 
		ИмяФайла = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ИмяФайла, Расширение);
	КонецЕсли;
	
	ИмяФайлаСПутем = "";
	Если Не ПустаяСтрока(ИмяФайла) Тогда
		Если ДанныеФайла.РабочийКаталогВладельца <> "" Тогда
			ИмяФайлаСПутем = ДанныеФайла.РабочийКаталогВладельца + ДанныеФайла.ПолноеНаименованиеВерсии + "." + ДанныеФайла.Расширение;
		Иначе
			ИмяФайлаСПутем = ФайловыеФункцииКлиентСервер.ПолучитьУникальноеИмяСПутем(ИмяКаталога, ИмяФайла);
		КонецЕсли;		
	КонецЕсли;
	
	Если ПустаяСтрока(ИмяФайла) Тогда
		Возврат "";
	КонецЕсли;
	
	// Запишем в регистр имя файла
	НаЧтение = Истина;
	ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
	РаботаСФайламиВызовСервера.ЗаписатьИмяФайлаСПутемВРегистр(ДанныеФайла.Версия, ИмяФайлаСПутем, НаЧтение, ВРабочемКаталогеВладельца);
	
	Если ДанныеФайла.РабочийКаталогВладельца = "" Тогда
		ПутьДляВозврата = ИмяКаталога + ИмяФайлаСПутем;
	Иначе
		ПутьДляВозврата = ИмяФайлаСПутем;
	КонецЕсли;
	
	Возврат ПутьДляВозврата;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Служебные функции модуля

// Пометка файла как занятого для редактирования
Процедура ЗанятьФайл(ДанныеФайла)
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	СтрокаОшибки = "";
	Если РаботаСФайламиКлиентСервер.МожноЛиЗанятьФайл(ДанныеФайла, СтрокаОшибки) Тогда
		
		РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
		СтрокаОшибки = "";
		Если Не РаботаСФайламиВызовСервера.ЗанятьФайл(ДанныеФайла, СтрокаОшибки) Тогда 
			Предупреждение(СтрокаОшибки);
			Возврат;
		КонецЕсли;	
		
		Если РасширениеПодключено Тогда
			НаЧтение = Ложь;
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		КонецЕсли;

		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Редактирование файла'"),
			ДанныеФайла.НавигационнаяСсылка,
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			  НСтр("ru = 'Файл ""%1"" занят для редактирования.'"), Строка(ДанныеФайла.Ссылка)),
			БиблиотекаКартинок.Информация32);
		
	Иначе
		Предупреждение(СтрокаОшибки);
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

// Покажет напоминание - если стоит настройка
Процедура ПоказатьНапоминаниеПередПоместитьФайл()
	Если ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПоказыватьПодсказкиПриРедактированииФайлов = Истина Тогда
		
		РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
		Если НЕ РасширениеПодключено Тогда
			// Кешируем форму на клиенте
			Форма = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуНапоминанияПередПоместитьФайл();
			БольшеНеПоказывать = Форма.ОткрытьМодально();
			
			Если БольшеНеПоказывать = Истина Тогда
				ПоказыватьПодсказкиПриРедактированииФайлов = Ложь;
				ОбщегоНазначения.ХранилищеОбщихНастроекСохранитьИОбновитьПовторноИспользуемыеЗначения("НастройкиПрограммы", "ПоказыватьПодсказкиПриРедактированииФайлов", ПоказыватьПодсказкиПриРедактированииФайлов);
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры // ПоказатьНапоминаниеПередПоместитьФайл()

// Находится ли в рабочем каталоге Файл для данной версии
Функция ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ТекущаяВерсия, ИмяФайлаСПутем, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца)
	ИмяФайлаСПутем = "";
	
	// Если это активная версия - берем из ДанныеФайла
	Если ДанныеФайла <> Неопределено И ДанныеФайла.ТекущаяВерсия = ТекущаяВерсия Тогда
		ИмяФайлаСПутем = ДанныеФайла.ИмяФайлаСПутемВРабочемКаталоге;
		ВРабочемКаталогеНаЧтение = ДанныеФайла.ВРабочемКаталогеНаЧтение;
	Иначе
		ВРабочемКаталогеНаЧтение = Истина;
		ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
		// Пытаемся найти такую запись в регистре сведений
		ИмяФайлаСПутем = РаботаСФайламиВызовСервера.ПолучитьИмяФайлаСПутемИзРегистра(ТекущаяВерсия, ИмяКаталога, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	КонецЕсли;
	
	Если ИмяФайлаСПутем <> "" Тогда
		// Тут надо еще на наличие на диске проверять 
		ФайлНаДиске = Новый Файл(ИмяФайлаСПутем);
	    Если ФайлНаДиске.Существует() Тогда
			Возврат Истина;	
		Иначе
			ИмяФайлаСПутем = "";
			// Тут же удалим из регистра - т.к. в регистре есть, а на диске нет
			РаботаСФайламиВызовСервера.УдалитьИзРегистра(ТекущаяВерсия);
	    КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;
КонецФункции

// Освободить место для помещения файла - если место есть, ничего не делает
Процедура ОсвободитьМестоВРабочемКаталоге(РеквизитыВерсии)
	#Если НЕ ВебКлиент Тогда
		МаксРазмер = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().МаксимальныйРазмерЛокальногоКэшаФайлов;
		
		// Если размер РабочийКаталог стоит равным 0, то считать что никакого ограничения нет 
		//  и умолчание в 10 Мб не использовать.
		Если МаксРазмер = 0 Тогда
			Возврат;
		КонецЕсли;
		
		ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
		ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
		
		МассивФайлов = НайтиФайлы(ИмяКаталога, "*.*");
		
		РазмерФайловВРабочемКаталоге = 0;
		КоличествоСуммарное = 0;
		// Вычисляем полный размер файлов в рабочем каталоге
		ФайловыеФункцииКлиент.ОбходФайловРазмер(ИмяКаталога, МассивФайлов, РазмерФайловВРабочемКаталоге, КоличествоСуммарное);
		
		Размер = РеквизитыВерсии.Размер;
		Если РазмерФайловВРабочемКаталоге + Размер > МаксРазмер Тогда
			ОчиститьРабочийКаталог(РазмерФайловВРабочемКаталоге, Размер, Ложь); // ОчищатьВсе= Ложь
		КонецЕсли;
	#КонецЕсли
КонецПроцедуры

// Получить Файл с сервера и зарегистрировать в локальном кеше
Функция ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ИмяФайлаСПутем, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы = Неопределено)
	
	ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
	
	Если ИмяФайлаСПутем = "" Тогда
		ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
		ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
		
		// Формирование имени файла с расширением
		ИмяФайла = ДанныеФайла.ПолноеНаименованиеВерсии;
		Если НЕ ПустаяСтрока(ДанныеФайла.Расширение) Тогда 
			ИмяФайла = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ИмяФайла, ДанныеФайла.Расширение);
		КонецЕсли;
		
		ИмяФайлаСПутем = "";
		Если НЕ ПустаяСтрока(ИмяФайла) Тогда
			ИмяФайлаСПутем = ФайловыеФункцииКлиентСервер.ПолучитьУникальноеИмяСПутем(ИмяКаталога, ИмяФайла);
			ИмяФайлаСПутем = ИмяКаталога + ИмяФайлаСПутем;
		КонецЕсли;
		
		Если ПустаяСтрока(ИмяФайла) Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Если ВРабочемКаталогеВладельца = Ложь Тогда
		#Если Не ВебКлиент Тогда // в веб клиенте нельзя определить количество свободного места на диске
			ОсвободитьМестоВРабочемКаталоге(ДанныеФайла);
		#КонецЕсли
	КонецЕсли;		

	РазмерФайла = 0;
	
	
	// Запись Файл в каталог
	Попытка
		
		АдресФайла = ДанныеФайла.НавигационнаяСсылкаТекущейВерсии;
		Если ДанныеФайла.Версия <> ДанныеФайла.ТекущаяВерсия Тогда 
			АдресФайла = РаботаСФайламиВызовСервера.ПолучитьНавигационнуюСсылкуДляОткрытия(ДанныеФайла.Версия, ИдентификаторФормы);
		КонецЕсли;
		
		ИмяФайла = ФайловыеФункцииКлиентСервер.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		РазмерВМб = ДанныеФайла.Размер / (1024 * 1024);
		
		ТекстПояснения =
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		    НСтр("ru = 'Выполняется передача файла ""%1"" (%2 Мб)...
				|Пожалуйста, подождите.'"),
		    ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
		
		Состояние(ТекстПояснения);
		
		ПередаваемыеФайлы = Новый Массив;
		Описание = Новый ОписаниеПередаваемогоФайла(ИмяФайла, АдресФайла);
		ПередаваемыеФайлы.Добавить(Описание);
		
		ФайлНаДискеПоИмени = Новый Файл(ИмяФайлаСПутем);
		ПутьКФайлу = ФайлНаДискеПоИмени.Путь;
		Если Прав(ПутьКФайлу,1) <> "\" Тогда
			ПутьКФайлу = ПутьКФайлу + "\";
		КонецЕсли;
		ИмяФайлаСПутем = ПутьКФайлу + ИмяФайла; // могло смениться расширение
		
		Если НЕ ПолучитьФайлы(ПередаваемыеФайлы,, ПутьКФайлу, Ложь) Тогда
			Возврат Ложь;
		КонецЕсли;
		
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(АдресФайла) Тогда
			УдалитьИзВременногоХранилища(АдресФайла);
		КонецЕсли;
		
		Состояние();
		
		Если ДанныеФайла.Зашифрован Тогда
			
			ПредставленияСертификатов = "";
			Для Каждого СтруктураСертификата Из ДанныеФайла.МассивСертификатовШифрования Цикл
				
				Отпечаток = СтруктураСертификата.Отпечаток;
				
				ТолькоВЛичномХранилище = Истина;
				Сертификат = ЭлектроннаяЦифроваяПодписьКлиент.ПолучитьСертификатПоОтпечатку(Отпечаток, ТолькоВЛичномХранилище);
				Если Сертификат <> Неопределено Тогда // тут собираем только личные сертификаты - с закрытым ключом - для расшифровки
					Если НЕ ПустаяСтрока(ПредставленияСертификатов) Тогда
						ПредставленияСертификатов = ПредставленияСертификатов + Символы.ПС;
					КонецЕсли;
					ПредставленияСертификатов = ПредставленияСертификатов + СтруктураСертификата.Представление;
				КонецЕсли;
				
			КонецЦикла;	
			
			Пароль = "";
			Заголовок = НСтр("ru = 'Введите пароль для расшифровки'");
			ПараметрыФормы = Новый Структура("Заголовок, ПредставленияСертификатов, Файл", 
				Заголовок, ПредставленияСертификатов, ДанныеФайла.Ссылка);
			КодВозврата = ОткрытьФормуМодально("ОбщаяФорма.ВводПароляСОписаниями", ПараметрыФормы);
			Если ТипЗнч(КодВозврата) = Тип("Строка") Тогда
				Пароль = КодВозврата;
			Иначе
				УдалитьФайлы(ИмяФайлаСПутем);
				ИмяФайлаСПутем = "";
				Возврат Ложь;
			КонецЕсли;
			
			Попытка
				МенеджерКриптографии = ЭлектроннаяЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
				МенеджерКриптографии.ПарольДоступаКЗакрытомуКлючу = Пароль;
				
				ИмяФайлаСПутемРасшифрованное = ИмяФайлаСПутем + ".dec";
				МенеджерКриптографии.Расшифровать(ИмяФайлаСПутем, ИмяФайлаСПутемРасшифрованное);
				
				УдалитьФайлы(ИмяФайлаСПутем);
				ПереместитьФайл(ИмяФайлаСПутемРасшифрованное, ИмяФайлаСПутем);
			Исключение
				УдалитьФайлы(ИмяФайлаСПутем);
				ВызватьИсключение;
			КонецПопытки;
			
		КонецЕсли;	
		
		// Установим время изменения файла таким, как оно стоит в текущей версии
		ФайлНаДиске = Новый Файл(ИмяФайлаСПутем);
		ФайлНаДиске.УстановитьВремяИзменения(ДатаФайлаВБазе);
		
		РазмерФайла = ФайлНаДиске.Размер(); // Т.к. размер на диске может отличаться от размера в базе (при добавлении из веб клиента)
		
		ФайлНаДиске.УстановитьТолькоЧтение(НаЧтение);
		
	Исключение
		Предупреждение(КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		Возврат Ложь;
	КонецПопытки;
	
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	
	РаботаСФайламиВызовСервера.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.Версия, ИмяФайлаСПутем, ИмяКаталога, НаЧтение, РазмерФайла, ВРабочемКаталогеВладельца);	
	
	Возврат Истина;
КонецФункции

// Перерегистрировать В рабочем каталоге с другим флагом НаЧтение
Процедура ПеререгистрироватьВРабочемКаталоге(ТекущаяВерсия, ИмяФайлаСПутем, НаЧтение, ВРабочемКаталогеВладельца)
	ФайловыеФункцииКлиент.ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	
	РаботаСФайламиВызовСервера.ЗанестиИнформациюФайлаВРегистр(ТекущаяВерсия, ИмяФайлаСПутем, ИмяКаталога, НаЧтение, 0, ВРабочемКаталогеВладельца);	
	Файл = Новый Файл(ИмяФайлаСПутем);
	Файл.УстановитьТолькоЧтение(НаЧтение);	
КонецПроцедуры

// Рекурсивная функция импорта файлов с диска - принимает массив файлов (или каталогов)
// - если файл, просто добавляет его,   если каталог - создает группу и рекурсивно вызывает саму себя
Процедура ИмпортФайлов(
	Владелец, 
	ФайлыАргумент, 
	Индикатор, 
	МассивИменФайловСОшибками, 
	МассивСтруктурВсехФайлов, 
	Комментарий, 
	ХранитьВерсии, 
	Рекурсивно, 
	КоличествоСуммарное, 
	Счетчик,
	ИдентификаторФормы,
	Знач ПсевдоФайловаяСистема,
	ДобавленныеФайлы,
	МассивВсехПапок,
	РежимЗагрузки = Ложь) Экспорт
	
	Перем ПерваяПапкаСТакимЖеИменем;
	Перем ДокГруппаСсылка;
	
	МаксРазмерФайла = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().МаксимальныйРазмерФайла;
	ЗапретЗагрузкиФайловПоРасширению = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ЗапретЗагрузкиФайловПоРасширению;
	СписокЗапрещенныхРасширений = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().СписокЗапрещенныхРасширений;
	
	Для Каждого ВыбранныйФайл Из ФайлыАргумент Цикл
		Попытка

			Если ВыбранныйФайл.Существует() Тогда

				Если ВыбранныйФайл.Расширение = ".lnk" Тогда
					ВыбранныйФайл = РазыменоватьLnkФайл(ВыбранныйФайл);
				КонецЕсли;
				
				Если ВыбранныйФайл.ЭтоКаталог() Тогда
					
					Если Рекурсивно = Истина Тогда
						НовыйПуть = Строка(ВыбранныйФайл.Путь);
						ФайловыеФункцииКлиентСервер.ДобавитьСлешЕслиНужно(НовыйПуть);
						НовыйПуть = НовыйПуть + Строка(ВыбранныйФайл.Имя);
						МассивФайлов = ФайловыеФункцииКлиентСервер.НайтиФайлыПсевдо(ПсевдоФайловаяСистема, НовыйПуть);
						
						// Создаем группу в справочнике - эквивалент папки на диске
						Если МассивФайлов.Количество() <> 0 Тогда
							ИмяФайла = ВыбранныйФайл.Имя;
							
							ПапкаУжеНайдена = Ложь;
							
							Если РаботаСФайламиВызовСервера.ЕстьПапкаСТакимИменем(ИмяФайла, Владелец, ПерваяПапкаСТакимЖеИменем) Тогда
								
								Если РежимЗагрузки Тогда
									ПапкаУжеНайдена = Истина;
									ДокГруппаСсылка = ПерваяПапкаСТакимЖеИменем;
								Иначе	
								
									ТекстВопроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
													НСтр("ru = 'Внимание! Папка ""%1"" уже существует. Продолжить импорт папки?'"),
													ИмяФайла);
										
									КодВозврата = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);

									Если КодВозврата = КодВозвратаДиалога.Нет Тогда
										Продолжить;
									КонецЕсли;
									
								КонецЕсли;
							КонецЕсли;
							
							Если Не ПапкаУжеНайдена Тогда							
								ДокГруппаСсылка = РаботаСФайламиВызовСервера.СправочникиПапкиСоздатьЭлемент(ИмяФайла, Владелец);
							КонецЕсли;
							
							ИмпортФайлов(
								ДокГруппаСсылка, 
								МассивФайлов, 
								Индикатор, 
								МассивИменФайловСОшибками, 
								МассивСтруктурВсехФайлов, 
								Комментарий, 
								ХранитьВерсии, 
								Рекурсивно, 
								КоличествоСуммарное, 
								Счетчик,
								ИдентификаторФормы,
								ПсевдоФайловаяСистема,
								ДобавленныеФайлы,
								МассивВсехПапок,
								РежимЗагрузки);
								
							МассивВсехПапок.Добавить(НовыйПуть);	
						КонецЕсли;
					КонецЕсли;
				
					Продолжить;
				КонецЕсли;
				
				Если Не ФайловыеФункцииКлиентСервер.ФайлМожноЗагружать(ВыбранныйФайл, МаксРазмерФайла, ЗапретЗагрузкиФайловПоРасширению, СписокЗапрещенныхРасширений, МассивИменФайловСОшибками) Тогда
					Продолжить;
				КонецЕсли;	
					
				// Обновим индикатор прогресса
				Счетчик = Счетчик + 1;
				Индикатор = Счетчик * 100 / КоличествоСуммарное; // Считаем проценты
				РазмерВМб = ВыбранныйФайл.Размер() / (1024 * 1024);
				НадписьПодробнее =
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					 НСтр("ru = 'Обрабатывается файл ""%1"" (%2 Мб)...'"),
					 ВыбранныйФайл.Имя, ? (РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0") ) );
					 
				ТекстСостояния = НСтр("ru = 'Импорт файлов с диска...'");	 
				Если РежимЗагрузки Тогда
					ТекстСостояния = НСтр("ru = 'Загрузка файлов с диска...'");	 
				КонецЕсли;
				
				Состояние(
					ТекстСостояния, 
					Индикатор, 
					НадписьПодробнее, 
					БиблиотекаКартинок.Информация32);
				
				// Создаем Элемент справочника Файлы
				ИмяБезРасширения = ВыбранныйФайл.ИмяБезРасширения;
				Расширение = ВыбранныйФайл.Расширение;
				
				Если РежимЗагрузки Тогда
					Если РаботаСФайламиВызовСервера.ЕстьФайлСТакимИменем(ИмяБезРасширения, Владелец) Тогда
						Запись = Новый Структура;
						Запись.Вставить("ИмяФайла", ВыбранныйФайл.ПолноеИмя);
						Запись.Вставить("Ошибка", НСтр("ru = 'Файл с таким именем уже есть в информационной базе'"));
						МассивИменФайловСОшибками.Добавить(Запись);
						Продолжить;
					КонецЕсли;	
				КонецЕсли;	
				
				АдресВременногоХранилищаФайла = "";

				ПомещаемыеФайлы = Новый Массив;
				Описание = Новый ОписаниеПередаваемогоФайла(ВыбранныйФайл.ПолноеИмя, "");
				ПомещаемыеФайлы.Добавить(Описание);
				
				ПомещенныеФайлы = Новый Массив;
				
				Если Не ПоместитьФайлы(ПомещаемыеФайлы, ПомещенныеФайлы, , Ложь, ИдентификаторФормы) Тогда
					ВызватьИсключение
					  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Ошибка помещения файла в хранилище: %1'"), ВыбранныйФайл.ПолноеИмя);
				КонецЕсли;

				Если ПомещенныеФайлы.Количество() = 1 Тогда
					АдресВременногоХранилищаФайла = ПомещенныеФайлы[0].Хранение;
				КонецЕсли;
				
				Если НЕ ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ИзвлекатьТекстыФайловНаСервере Тогда
					АдресВременногоХранилищаТекста = ФайловыеФункцииКлиентСервер.ИзвлечьТекстВоВременноеХранилище(
						ВыбранныйФайл.ПолноеИмя,
						ИдентификаторФормы);
				Иначе
					АдресВременногоХранилищаТекста = "";
				КонецЕсли;

				// Создаем элемент справочника Файлы
				РаботаСФайламиКлиентСервер.СоздатьЭлементСправочникаФайлы(ВыбранныйФайл, МассивСтруктурВсехФайлов,
					Владелец, ИдентификаторФормы, Комментарий, ХранитьВерсии, ДобавленныеФайлы,
					АдресВременногоХранилищаФайла, АдресВременногоХранилищаТекста);
				
			Иначе
				Запись = Новый Структура;
				Запись.Вставить("ИмяФайла", ВыбранныйФайл.ПолноеИмя);
				Запись.Вставить("Ошибка", НСтр("ru = 'Файл отсутствует на диске'"));
				МассивИменФайловСОшибками.Добавить(Запись);
			КонецЕсли;

		Исключение
			ОшибкаИнфо = ИнформацияОбОшибке();
			СообщениеОбОшибке = "";
			Если ОшибкаИнфо.Причина = Неопределено Тогда
				СообщениеОбОшибке =ОшибкаИнфо.Описание;
			Иначе
				СообщениеОбОшибке = ОшибкаИнфо.Причина.Описание;
			КонецЕсли;
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СообщениеОбОшибке);
			
			Запись = Новый Структура;
			Запись.Вставить("ИмяФайла", ВыбранныйФайл.ПолноеИмя);
			Запись.Вставить("Ошибка", СообщениеОбОшибке);
			МассивИменФайловСОшибками.Добавить(Запись);
		
		КонецПопытки;
	КонецЦикла;
	
КонецПроцедуры

// Импорт - с вспомогательными операциями типа проверки предельного размера и впоследствии удаления файлов и показа ошибок
//   при импорте только одной папки - вернет на нее ссылку
Функция ИмпортФайловВыполнить(
	ПапкаДляДобавления, 
	ВыбранныеФайлы, 
	Комментарий, 
	ХранитьВерсии, 
	УдалятьФайлыПослеДобавления, 
	Рекурсивно, 
	ИдентификаторФормы,
	Знач ПсевдоФайловаяСистема,
	ДобавленныеФайлы,
	РежимЗагрузки = Ложь) Экспорт
	
	Перем ПерваяПапкаСТакимЖеИменем;
	Перем ПапкаДляДобавленияТекущая;

	ВыбранКаталог = Ложь;
	Путь = "";
	
	КоличествоСуммарное = 0;
	Если ПроверитьПредельныйРазмерФайлов(ВыбранныеФайлы, Рекурсивно, КоличествоСуммарное, ПсевдоФайловаяСистема, РежимЗагрузки) = Ложь Тогда
		Состояние();
		Возврат Неопределено;
	КонецЕсли;

	Состояние();
	
	Если КоличествоСуммарное = 0 Тогда
		
		Если Не РежимЗагрузки Тогда
			Предупреждение(НСтр("ru = 'Нет файлов для добавления'"));
		КонецЕсли;
		
		Возврат Неопределено;
	КонецЕсли;
	
	Индикатор = 0;
	
	МассивФайлов = Новый Массив;
	Счетчик = 0;
	МассивИменФайловСОшибками = Новый Массив;
	МассивСтруктурВсехФайлов = Новый Массив;
	МассивВсехПапок = Новый Массив;
	
	ПапкаДляДобавленияТекущая = Неопределено;
	
	Для Каждого ИмяФайла Из ВыбранныеФайлы Цикл
		Попытка
			ВыбранныйФайл = Новый Файл(ИмяФайла.Значение);
			
			ВыбранКаталог = Ложь;
			Если ВыбранныйФайл.Существует() Тогда
				ВыбранКаталог = ВыбранныйФайл.ЭтоКаталог();
			КонецЕсли;
			
			Если ВыбранКаталог Тогда
				Путь = ИмяФайла.Значение;
				МассивФайловЭтогоКаталога = ФайловыеФункцииКлиентСервер.НайтиФайлыПсевдо(ПсевдоФайловаяСистема, Путь);
				
				ИмяПапки = ВыбранныйФайл.Имя;
				
				ПапкаУжеНайдена = Ложь;
				
				Если РаботаСФайламиВызовСервера.ЕстьПапкаСТакимИменем(ИмяПапки, ПапкаДляДобавления, ПерваяПапкаСТакимЖеИменем) Тогда
					
					Если РежимЗагрузки Тогда
						ПапкаУжеНайдена = Истина;
						ПапкаДляДобавленияТекущая = ПерваяПапкаСТакимЖеИменем;
					Иначе	
					
						ТекстВопроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
										НСтр("ru = 'Внимание! Папка ""%1"" уже существует. Продолжить импорт папки?'"),
										ИмяПапки);
							
						КодВозврата = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);

						Если КодВозврата = КодВозвратаДиалога.Нет Тогда
							Продолжить;
						КонецЕсли;
						
					КонецЕсли;
				КонецЕсли;
				
				Если Не ПапкаУжеНайдена Тогда
					ПапкаДляДобавленияТекущая = РаботаСФайламиВызовСервера.СправочникиПапкиСоздатьЭлемент(ИмяПапки, ПапкаДляДобавления);
				КонецЕсли;
				
				// Собственно импорт 
				ИмпортФайлов(
					ПапкаДляДобавленияТекущая, 
					МассивФайловЭтогоКаталога, 
					Индикатор, 
					МассивИменФайловСОшибками, 
					МассивСтруктурВсехФайлов, 
					Комментарий, 
					ХранитьВерсии, 
					Рекурсивно, 
					КоличествоСуммарное, 
					Счетчик,
					ИдентификаторФормы,
					ПсевдоФайловаяСистема,
					ДобавленныеФайлы,
					МассивВсехПапок,
					РежимЗагрузки);
				МассивВсехПапок.Добавить(Путь);	
					
			Иначе
				МассивФайлов.Добавить(ВыбранныйФайл);
			КонецЕсли;
		Исключение
			Инфо = ИнформацияОбОшибке();
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					   НСтр("ru = 'Описание=""%1""'"), Инфо.Описание ));
		КонецПопытки;
	КонецЦикла;
	
	Если МассивФайлов.Количество() <> 0 Тогда
		// Собственно импорт 
		ИмпортФайлов(
			ПапкаДляДобавления, 
			МассивФайлов, 
			Индикатор, 
			МассивИменФайловСОшибками, 
			МассивСтруктурВсехФайлов, 
			Комментарий, 
			ХранитьВерсии, 
			Рекурсивно, 
			КоличествоСуммарное, 
			Счетчик,
			ИдентификаторФормы,
			ПсевдоФайловаяСистема,
			ДобавленныеФайлы,
			МассивВсехПапок,
			РежимЗагрузки);
	КонецЕсли;
	
	Если МассивСтруктурВсехФайлов.Количество() > 1 Тогда
		
		ТекстСостояния = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Импорт файлов завершен. Импортировано %1 файлов'"), Строка(МассивСтруктурВсехФайлов.Количество()) );
			
		Если РежимЗагрузки Тогда
			ТекстСостояния = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Загрузка файлов завершена. Загружено %1 файлов'"), Строка(МассивСтруктурВсехФайлов.Количество()) );
		КонецЕсли;
		
		Состояние(ТекстСостояния);
	Иначе
		Состояние();
	КонецЕсли;
	
	Если УдалятьФайлыПослеДобавления = Истина Тогда
		ФайловыеФункцииКлиентСервер.УдалитьФайлыПослеДобавления(МассивСтруктурВсехФайлов, МассивВсехПапок, РежимЗагрузки);
	КонецЕсли;
	
	Если МассивСтруктурВсехФайлов.Количество() = 1 Тогда
		Элемент0 = МассивСтруктурВсехФайлов[0];
		Ссылка = ПолучитьНавигационнуюСсылку(элемент0.Файл);
		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Изменение:'"),
			ссылка,
			Элемент0.Файл,
			БиблиотекаКартинок.Информация32);
	КонецЕсли;
	
	// Вывод сообщений об ошибках
	Если МассивИменФайловСОшибками.Количество() <> 0 Тогда
		
		Параметры = Новый Структура;
		Параметры.Вставить("МассивИменФайловСОшибками", МассивИменФайловСОшибками);
		Если РежимЗагрузки Тогда
			Параметры.Вставить("Заголовок", "Отчет о загрузке файлов");
		КонецЕсли;
		
		ОткрытьФорму("Справочник.Файлы.Форма.ФормаОтчета", Параметры);
	КонецЕсли;
	
	Если ВыбранныеФайлы.Количество() <> 1 Тогда
		ПапкаДляДобавленияТекущая = Неопределено;
	КонецЕсли;	
	
	Возврат ПапкаДляДобавленияТекущая;
КонецФункции

// Проверить Предельный Размер Файлов - вернет Ложь, если есть файлы, превышающие предельный размер,
//   и пользователь в диалоге предупреждения о наличии таких файлов выбрал "Отмена"
Функция ПроверитьПредельныйРазмерФайлов(ВыбранныеФайлы, Рекурсивно, КоличествоСуммарное, Знач ПсевдоФайловаяСистема, РежимЗагрузки = Ложь) Экспорт
	
	МассивСлишкомБольшихФайлов = Новый Массив;
	
	Путь = "";
	
	МассивФайлов = Новый Массив;
	КоличествоСуммарное = 0;
	
	Для Каждого ИмяФайла Из ВыбранныеФайлы Цикл
		
		Путь = ИмяФайла.Значение;
		ВыбранныйФайл = Новый Файл(Путь);

		Попытка
			ВыбранныйФайл = Новый Файл(ИмяФайла.Значение);
			ВыбранКаталог = Ложь;
			
			Если ВыбранныйФайл.Существует() Тогда
				ВыбранКаталог = ВыбранныйФайл.ЭтоКаталог();
			КонецЕсли;
			
			Если ВыбранКаталог Тогда
				Состояние(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					   НСтр("ru = 'Идет сбор информации о каталоге ""%1"". 
					   |Пожалуйста, подождите.'"), Путь ));
				
				МассивФайловЭтогоКаталога = ФайловыеФункцииКлиентСервер.НайтиФайлыПсевдо(ПсевдоФайловаяСистема, Путь);
				ОбходФайловДляПроверкиПредельногоРазмера(МассивФайловЭтогоКаталога, МассивСлишкомБольшихФайлов, Рекурсивно, КоличествоСуммарное, ПсевдоФайловаяСистема);
			Иначе
				МассивФайлов.Добавить(ВыбранныйФайл);
			КонецЕсли;
		Исключение
			Инфо = ИнформацияОбОшибке();
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						  НСтр("ru = 'Описание=""%1""'"), Инфо.Описание ));
		КонецПопытки;
	КонецЦикла;
	
	Если МассивФайлов.Количество() <> 0 Тогда
		ОбходФайловДляПроверкиПредельногоРазмера(МассивФайлов, МассивСлишкомБольшихФайлов, Рекурсивно, КоличествоСуммарное, ПсевдоФайловаяСистема);
	КонецЕсли;
	
	// Был хоть один слишком большой файл
	Если МассивСлишкомБольшихФайлов.Количество() <> 0 Тогда 
		
		ФайлыБольшие = Новый СписокЗначений;
		Параметры = Новый Структура;
		
		Для Каждого Файл Из МассивСлишкомБольшихФайлов Цикл
			БольшойФайл = Новый Файл(Файл);
			РазмерФайлаВМб = Цел(БольшойФайл.Размер() / (1024 * 1024));
			ТекстСтроки = Строка(Файл) + " (" + Строка(РазмерФайлаВМб) + " " + НСтр("ru = 'МБ)'");
			ФайлыБольшие.Добавить(ТекстСтроки);
		КонецЦикла;
		
		Параметры.Вставить("ФайлыБольшие", ФайлыБольшие);
		Параметры.Вставить("РежимЗагрузки", РежимЗагрузки);
		Параметры.Вставить("Заголовок", "Предупреждение при загрузке файлов");
		
		Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВопросПриИмпортеФайлов", Параметры);
		
		Возврат Результат = КодВозвратаДиалога.ОК;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

// Обход Файлов рекурсивный - для определения размера файлов
Процедура ОбходФайловДляПроверкиПредельногоРазмера(
				МассивФайлов,
				МассивСлишкомБольшихФайлов,
				Рекурсивно,
				КоличествоСуммарное,
				Знач ПсевдоФайловаяСистема) Экспорт
	
	МаксРазмерФайла = ФайловыеФункцииКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().МаксимальныйРазмерФайла;
	
	Для Каждого ВыбранныйФайл Из МассивФайлов Цикл
		
		Попытка
			Если ВыбранныйФайл.Существует() Тогда
				
				Если ВыбранныйФайл.Расширение = ".lnk" Тогда
					ВыбранныйФайл = РазыменоватьLnkФайл(ВыбранныйФайл);
				КонецЕсли;
				
				Если ВыбранныйФайл.ЭтоКаталог() Тогда
					
					Если Рекурсивно Тогда
						НовыйПуть = Строка(ВыбранныйФайл.Путь);
						Если Прав(НовыйПуть, 1) <> "\" Тогда
							НовыйПуть = НовыйПуть + "\";
						КонецЕсли;
						НовыйПуть = НовыйПуть + Строка(ВыбранныйФайл.Имя);
						МассивФайловВКаталоге = ФайловыеФункцииКлиентСервер.НайтиФайлыПсевдо(ПсевдоФайловаяСистема, НовыйПуть);
						
						// Рекурсия
						Если МассивФайловВКаталоге.Количество() <> 0 Тогда
							ОбходФайловДляПроверкиПредельногоРазмера(МассивФайловВКаталоге, МассивСлишкомБольшихФайлов, Рекурсивно, КоличествоСуммарное, ПсевдоФайловаяСистема);
						КонецЕсли;
					КонецЕсли;
				
					Продолжить;
				КонецЕсли;
				
				КоличествоСуммарное = КоличествоСуммарное + 1;
				
				// Размер файла слишком большой
				Если ВыбранныйФайл.Размер() > МаксРазмерФайла Тогда
					МассивСлишкомБольшихФайлов.Добавить(ВыбранныйФайл.ПолноеИмя);
					Продолжить;
				КонецЕсли;
			
			КонецЕсли;
			
		Исключение
			Инфо = ИнформацияОбОшибке();
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						  НСтр("ru = 'Описание=""%1""'"), Инфо.Описание ));
		КонецПопытки;
	КонецЦикла;
	
КонецПроцедуры

// Разыменовать lnk файл
Функция РазыменоватьLnkФайл(ВыбранныйФайл)
	
#Если Не ВебКлиент Тогда
	Если НЕ СтандартныеПодсистемыКлиентПовтИсп.ПараметрыРаботыКлиента().ЭтоБазоваяВерсияКонфигурации Тогда
		ShellApp = Новый COMОбъект("shell.application");
		FolderObj = ShellApp.NameSpace(ВыбранныйФайл.Путь);			// полный (только) путь на lnk-файл
		FolderObjItem = FolderObj.items().item(ВыбранныйФайл.Имя); 	// только имя lnk-файла
		Link = FolderObjItem.GetLink();
		Возврат Новый Файл(Link.path);
	КонецЕсли;
#КонецЕсли
	
	Возврат ВыбранныйФайл;
	
КонецФункции

// Вернет Истина, если можно закрыть форму. 
Функция МожноЗакрытьФормуСФайлами(ОбъектСсылка) Экспорт
	
	МожноЗакрыть = Истина;
	
	Количество = РаботаСФайламиВызовСервера.КоличествоФайловЗанятыхТекущимПользователем(ОбъектСсылка);
	
	Если Количество <> 0 Тогда
		
		Результат = Вопрос(
			НСтр("ru = 'Внимание!
			           |Один или несколько файлов заняты Вами для редактирования. Продолжить?'"),
			РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);
			
		Если Результат = КодВозвратаДиалога.Нет Тогда
			МожноЗакрыть = Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат МожноЗакрыть;
	
КонецФункции
