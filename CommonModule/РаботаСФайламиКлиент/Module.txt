// Можно ли освободить Файл
Функция ВозможностьОсвободитьФайл(ОбъектСсылка, РедактируетТекущийПользователь, Редактирует, СтрокаОшибки = "") Экспорт

	Если РедактируетТекущийПользователь Тогда 
		Возврат Истина;
	ИначеЕсли Редактирует.Пустая() Тогда
		СтрокаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		                           НСтр("ru = 'Нельзя освободить файл ""%1"" т.к. он никем не занят.'"), Строка(ОбъектСсылка));
		Возврат Ложь;
	Иначе
		Если РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ЭтоПолноправныйПользовательИБ Тогда
			Возврат Истина;
		КонецЕсли;
		
		СтрокаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		                           НСтр("ru = 'Нельзя освободить файл ""%1"" т.к. он занят пользователем ""%2"".'"),
		                           Строка(ОбъектСсылка),
		                           Строка(Редактирует));
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции // ВозможностьОсвободитьФайл()

// Пометка файла как занятого для редактирования - по ссылке
// (без ПолучитьДанныеФайла - для минимизации числа вызовов сервера)
Процедура ЗанятьФайлПоСсылке(ОбъектСсылка, УникальныйИдентификатор = Неопределено) Экспорт
	
	Перем ДанныеФайла;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	СтрокаОшибки = "";
	Если НЕ РаботаСФайлами.ПолучитьДанныеФайлаИЗанятьФайл(ОбъектСсылка, ДанныеФайла, СтрокаОшибки, УникальныйИдентификатор) Тогда
		// Если занять нельзя, то сообщаем об ошибке
		Предупреждение(СтрокаОшибки);
		Возврат;
	КонецЕсли;	
	
	Если РасширениеПодключено Тогда
		НаЧтение = Ложь;
		ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
		ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		
	КонецЕсли;
	
	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Редактирование файла'"),
		ДанныеФайла.НавигационнаяСсылка,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		    НСтр("ru = 'Файл ""%1"" занят для редактирования.'"), Строка(ДанныеФайла.Ссылка)),
			БиблиотекаКартинок.Информация32);
	
КонецПроцедуры //ЗанятьФайлПоСсылке

// Пометка файлов как занятых для редактирования - по массиву ссылок
//
Процедура ЗанятьФайлыПоСсылкам(Знач МассивФайлов) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Получение массива данных файлов
	ДанныеФайлов = Новый Массив;
	РаботаСФайлами.ПолучитьДанныеДляМассиваФайлов(МассивФайлов, ДанныеФайлов);
	ВГраницаМассива  = ДанныеФайлов.ВГраница();
	
	Для Инд = 0 По ВГраницаМассива Цикл
		ДанныеФайла = ДанныеФайлов[ВГраницаМассива - Инд];
		
		СтрокаОшибки = "";
		Если НЕ РаботаСФайламиКлиентСервер.МожноЛиЗанятьФайл(ДанныеФайла, СтрокаОшибки) ИЛИ Не ДанныеФайла.Редактирует.Пустая() Тогда // занять невозможно
			ДанныеФайлов.Удалить(ВГраницаМассива - Инд);
		КонецЕсли;	
	КонецЦикла;	
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	// Занять файлы
	КоличествоЗанятых = 0;
	
	Для Каждого ДанныеФайла Из ДанныеФайлов Цикл
		
		Если Не РаботаСФайлами.ЗанятьФайл(ДанныеФайла) Тогда 
			Продолжить;
		КонецЕсли;	
		
		Если РасширениеПодключено Тогда
			НаЧтение = Ложь;
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		КонецЕсли;
		
		КоличествоЗанятых = КоличествоЗанятых + 1;
	КонецЦикла;
	
	ПоказатьОповещениеПользователя(  
		НСтр("ru = 'Занять файлы'"),
		,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Файлы (%1 из %2) заняты для редактирования.'"), 
			КоличествоЗанятых, МассивФайлов.Количество()),
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры //ЗанятьФайлПоСсылкам

// Пометка файла как занятого для редактирования
Процедура ЗанятьФайл(ДанныеФайла)
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	СтрокаОшибки = "";
	Если РаботаСФайламиКлиентСервер.МожноЛиЗанятьФайл(ДанныеФайла, СтрокаОшибки) Тогда
		
		РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
		СтрокаОшибки = "";
		Если Не РаботаСФайлами.ЗанятьФайл(ДанныеФайла, СтрокаОшибки) Тогда 
			Предупреждение(СтрокаОшибки);
			Возврат;
		КонецЕсли;	
		
		Если РасширениеПодключено Тогда
			НаЧтение = Ложь;
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		КонецЕсли;

		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Редактирование файла'"),
			ДанныеФайла.НавигационнаяСсылка,
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			  НСтр("ru = 'Файл ""%1"" занят для редактирования.'"), Строка(ДанныеФайла.Ссылка)),
			БиблиотекаКартинок.Информация32);
		
	Иначе
		Предупреждение(СтрокаОшибки);
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

// Процедура предназначена для открытия Файла в режиме редактирования - принимает ссылку на Файл
// по ссылке (без ПолучитьДанныеФайла - для минимизации числа вызовов сервера)
Процедура РедактироватьФайлПоСсылке(ОбъектСсылка, УникальныйИдентификатор = Неопределено, РабочийКаталогВладельца = Неопределено) Экспорт
	Перем ДанныеФайла;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	СтрокаОшибки = "";
	Если НЕ РаботаСФайлами.ПолучитьДанныеФайлаДляОткрытияИЗанятьФайл(ОбъектСсылка, ДанныеФайла, СтрокаОшибки, УникальныйИдентификатор, РабочийКаталогВладельца) Тогда
		// Если занять нельзя, то сообщаем об ошибке
		Предупреждение(СтрокаОшибки);
		Возврат;
	КонецЕсли;
	
	Если РасширениеПодключено Тогда
		НаЧтение = Ложь;
		ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
		ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
	КонецЕсли;

	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Редактирование файла'"),
		ДанныеФайла.НавигационнаяСсылка,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Файл ""%1"" занят для редактирования.'"), Строка(ДанныеФайла.Ссылка)),
			БиблиотекаКартинок.Информация32);
	
	// Если Файл без файла, то открываем карточку
	Если ДанныеФайла.Версия.Пустая() Тогда 
		ОткрытьЗначение(ДанныеФайла.Ссылка);
		Возврат;
	КонецЕсли;
	
	Если РасширениеПодключено Тогда
		ПолноеИмяФайла = "";
		Результат = ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла, УникальныйИдентификатор);
		Если Результат Тогда
			ОткрытьФайлПриложением(ДанныеФайла, ПолноеИмяФайла);
		КонецЕсли;
	Иначе
		ПоказатьНапоминаниеПриРедактировании();
		ИмяФайла = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		ПолучитьФайл(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии, ИмяФайла, Истина);		
		
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии) Тогда
			УдалитьИзВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры // РедактироватьФайлПоСсылке()

// Покажет напоминание - если стоит настройка
Процедура ПоказатьНапоминаниеПриРедактировании()
	Если РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПоказыватьПодсказкиПриРедактированииФайлов = Истина Тогда
		
		РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
		Если НЕ РасширениеПодключено Тогда
			Форма = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуНапоминанияПриРедактировании();

			Форма.БольшеНеПоказывать = Ложь;
			Форма.ОткрытьМодально();
			
			Если Форма.БольшеНеПоказывать = Истина Тогда
				РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПоказыватьПодсказкиПриРедактированииФайлов = Ложь;
				ОбщегоНазначения.ХранилищеОбщихНастроекСохранить("НастройкиПрограммы", "ПоказыватьПодсказкиПриРедактированииФайлов", РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПоказыватьПодсказкиПриРедактированииФайлов);
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры // ПоказатьНапоминаниеПриРедактировании()

// Покажет напоминание - если стоит настройка
Процедура ПоказатьНапоминаниеПередПоместитьФайл()
	Если РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПоказыватьПодсказкиПриРедактированииФайлов = Истина Тогда
		
		РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
		Если НЕ РасширениеПодключено Тогда
			// Кешируем форму на клиенте
			Форма = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуНапоминанияПередПоместитьФайл();
			Форма.БольшеНеПоказывать = Ложь;
			Форма.ОткрытьМодально();
			
			Если Форма.БольшеНеПоказывать = Истина Тогда
				РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПоказыватьПодсказкиПриРедактированииФайлов = Ложь;
				ОбщегоНазначения.ХранилищеОбщихНастроекСохранить("НастройкиПрограммы", "ПоказыватьПодсказкиПриРедактированииФайлов", РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПоказыватьПодсказкиПриРедактированииФайлов);
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры // ПоказатьНапоминаниеПередПоместитьФайл()

// Процедура предназначена для открытия Файла в режиме редактирования
Процедура РедактироватьФайл(ДанныеФайла, УникальныйИдентификатор = Неопределено) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	СтрокаОшибки = "";
	Если НЕ РаботаСФайламиКлиентСервер.МожноЛиЗанятьФайл(ДанныеФайла, СтрокаОшибки) Тогда
		Предупреждение(СтрокаОшибки);
		Возврат;
	КонецЕсли;	
	
	// Если Файл никем не занят - займем Файл
	Если ДанныеФайла.Редактирует.Пустая() Тогда
		ЗанятьФайл(ДанныеФайла);
	КонецЕсли;
	
	// Если Файл без файла нужно в таких случаях открывать карточку
	Если ДанныеФайла.Версия.Пустая() Тогда 
		ОткрытьЗначение(ДанныеФайла.Ссылка);
		Возврат;
	КонецЕсли;
	
	Если РасширениеПодключено Тогда
		ПолноеИмяФайла = "";
		Результат = ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла, УникальныйИдентификатор);
		Если Результат Тогда
			ОткрытьФайлПриложением(ДанныеФайла, ПолноеИмяФайла);
		КонецЕсли;
	Иначе
		ПоказатьНапоминаниеПриРедактировании();
		ИмяФайла = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		ПолучитьФайл(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии, ИмяФайла, Истина);
		
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии) Тогда
			УдалитьИзВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры // РедактироватьФайл()

// Процедура открытия Файла
Процедура ОткрытьФайл(ДанныеФайла, УникальныйИдентификатор = Неопределено) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Если Файл без файла нужно в таких случаях открывать карточку
	Если ДанныеФайла.Версия.Пустая() Тогда 
		ОткрытьЗначение(ДанныеФайла.Ссылка);
		Возврат;
	КонецЕсли;
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	Если РасширениеПодключено Тогда
		ПолноеИмяФайла = "";
		Результат = ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла, УникальныйИдентификатор);
		Если Результат Тогда
			ОткрытьФайлПриложением(ДанныеФайла, ПолноеИмяФайла);
		КонецЕсли;
	Иначе
		Если ДанныеФайла.РедактируетТекущийПользователь Тогда 
			ПоказатьНапоминаниеПриРедактировании();
		КонецЕсли;
		ИмяФайла = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		ПолучитьФайл(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии, ИмяФайла, Истина);
		
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии) Тогда
			УдалитьИзВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры // ОткрытьФайл()

// Процедура предназначена для открытия версии Файла
Процедура ОткрытьВерсиюФайла(ДанныеФайла, УникальныйИдентификатор = Неопределено) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	Если РасширениеПодключено Тогда
		ПолноеИмяФайла = "";
		Результат = ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла, УникальныйИдентификатор);
		Если Результат Тогда
			ОткрытьФайлПриложением(ДанныеФайла, ПолноеИмяФайла);
		КонецЕсли;
	Иначе
		Адрес = РаботаСФайлами.ПолучитьНавигационнуюСсылкуДляОткрытия(ДанныеФайла.Версия, УникальныйИдентификатор);
		
		ИмяФайла = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		ПолучитьФайл(Адрес, ИмяФайла, Истина);		
		
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(Адрес) Тогда
			УдалитьИзВременногоХранилища(Адрес);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры // ОткрытьВерсиюФайла()


// На основе переданного пути к файлу на диске создает Файл его и открывает карточку
Процедура СоздатьДокументНаОсновеФайла(ПолноеИмяФайла, ВладелецФайла, ФормаВладелец, 
	НеОткрыватьКарточкуПослеСозданияИзФайла = Неопределено, ИмяСоздаваемогоФайла = Неопределено) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Здесь создаем Файл ...
	Файл = Новый Файл(ПолноеИмяФайла);
	
	ЗапретЗагрузкиФайловПоРасширению = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ЗапретЗагрузкиФайловПоРасширению;
	СписокЗапрещенныхРасширений = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().СписокЗапрещенныхРасширений;
	РасширениеФайла = Файл.Расширение;
	Если Не РаботаСФайламиКлиентСервер.РасширениеФайлаРазрешеноДляЗагрузки(ЗапретЗагрузкиФайловПоРасширению, СписокЗапрещенныхРасширений, РасширениеФайла) Тогда
		ВызватьИсключение
			   СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				 НСтр("ru = 'Загрузка файлов с расширением ""%1"" запрещена. Обратитесь к администратору системы.'"),
				 РасширениеФайла);
	КонецЕсли;	
	
	МаксРазмерФайла = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().МаксимальныйРазмерФайла;
	
	РазмерВМб = Файл.Размер() / (1024 * 1024);
	РазмерВМбМакс = МаксРазмерФайла / (1024 * 1024);
	
	Если Файл.Размер() > МаксРазмерФайла Тогда
		
		ОбновитьПовторноИспользуемыеЗначения();
		
		ВызватьИсключение
			   СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				 НСтр("ru = 'Размер файла ""%1"" (%2 Мб) превышает максимально допустимый размер файла (%3 Мб).'"),
				 Файл.Имя, 
				 ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")), 
				 ?(РазмерВМбМакс >= 1, Формат(РазмерВМбМакс, "ЧДЦ=0"), Формат(РазмерВМбМакс, "ЧДЦ=1; ЧН=0")));
	КонецЕсли;
	
	АдресВременногоХранилищаТекста = ФайловыеФункцииКлиент.ИзвлечьТекстВоВременноеХранилище(
		Файл.ПолноеИмя, 
		ФормаВладелец.УникальныйИдентификатор);
	
	ВремяИзменения = Файл.ПолучитьВремяИзменения();
	ВремяИзмененияУниверсальное = Файл.ПолучитьУниверсальноеВремяИзменения();
	
	ИмяСоздания = Файл.ИмяБезРасширения;
	Если ИмяСоздаваемогоФайла <> Неопределено Тогда
		ИмяСоздания = ИмяСоздаваемогоФайла;
	КонецЕсли;	
	
	ИмяФайла = ИмяСоздания + Файл.Расширение;
	РазмерВМб = Файл.Размер() / (1024 * 1024);
	
	ТекстПояснения =
	СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Идет сохранение файла ""%1"" (%2 Мб).
		|Пожалуйста, подождите...'"),
		ИмяФайла,
		?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
	
	Состояние(ТекстПояснения);
	
	
	// Поместим Файл в ВременноеХранилище
	АдресВременногоХранилищаФайла = "";
	
	ПомещаемыеФайлы = Новый Массив;
	Описание = Новый ОписаниеПередаваемогоФайла(Файл.ПолноеИмя, "");
	ПомещаемыеФайлы.Добавить(Описание);
	
	ПомещенныеФайлы = Новый Массив;

	Если НЕ ПоместитьФайлы(ПомещаемыеФайлы, ПомещенныеФайлы, , Ложь, ФормаВладелец.УникальныйИдентификатор) Тогда		
		ВызватьИсключение
		  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Ошибка при помещении файла в хранилище: %1'"), Файл.ПолноеИмя);
	КонецЕсли;
	
	Если ПомещенныеФайлы.Количество() = 1 Тогда
		АдресВременногоХранилищаФайла = ПомещенныеФайлы[0].Хранение;
	КонецЕсли;
	
	// Создадим карточку Файла в БД
	Док = РаботаСФайлами.СоздатьФайлСВерсией(
		ВладелецФайла,
		ИмяСоздания,
		ФайловыеФункцииКлиентСервер.РасширениеБезТочки(Файл.Расширение),
		ВремяИзменения,
		ВремяИзмененияУниверсальное,
		Файл.Размер(),
		АдресВременногоХранилищаФайла,
		АдресВременногоХранилищаТекста,
		Ложь); // это не веб клиент

	Состояние();
	
	ПараметрыОповещения = Новый Структура("Владелец, Файл", ВладелецФайла, Док);
	Оповестить("СозданФайл", ПараметрыОповещения);
	
	НавигационнаяСсылка = ПолучитьНавигационнуюСсылку(Док);
	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Создание:'"),
		НавигационнаяСсылка,
		Док,
		БиблиотекаКартинок.Информация32);
	
	Параметры = Новый Структура("Ключ, КарточкаОткрытаПослеСозданияФайла, НовыйФайл", Док, Истина, Истина);
	
	Если НеОткрыватьКарточкуПослеСозданияИзФайла <> Истина Тогда
		ОткрытьФорму("Справочник.Файлы.ФормаОбъекта", Параметры, ФормаВладелец);
	КонецЕсли;
КонецПроцедуры	

// Процедура создания нового Файла
// Параметры:
//	РежимСоздания - как создавать новый Файл
//		1 - создать из шаблона
//		2 - создать из файла
//		3 - создать пустую карточку
Процедура СоздатьФайл(РежимСоздания, ВладелецФайла, ФормаВладелец, НеОткрыватьКарточкуПослеСозданияИзФайла = Неопределено) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	Если РежимСоздания = 1 Тогда
		
		// Создание из шаблона
		ПараметрыОткрытияФормы = Новый Структура("ВыборШаблона, ТекущаяСтрока", 
			Истина, ПредопределенноеЗначение("Справочник.ПапкиФайлов.Шаблоны"));
		Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.ФормаВыбора", ПараметрыОткрытияФормы);
		
		Если Результат = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		Параметры = Новый Структура("ФайлОснование, ВладелецФайла, РежимСоздания", 
			Результат, ВладелецФайла, "ИзШаблона");
		ОткрытьФорму("Справочник.Файлы.ФормаОбъекта", Параметры, ФормаВладелец);
		
	ИначеЕсли РежимСоздания = 2 Тогда
		
		// Создание из файла
		ПолноеИмяФайла = "";
		
		РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
		Если РасширениеПодключено Тогда
			ВыборФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
			ВыборФайла.МножественныйВыбор = Ложь;
			ВыборФайла.Заголовок = НСтр("ru = 'Выбор файла'");
			ВыборФайла.Фильтр = НСтр("ru = 'Все файлы (*.*)|*.*'");
			
			РабочийКаталог = РаботаСФайлами.ПолучитьРабочийКаталог(ВладелецФайла);
			ВыборФайла.Каталог = РабочийКаталог;

			Результат = ВыборФайла.Выбрать();
			ПолноеИмяФайла = ВыборФайла.ПолноеИмяФайла;
		
			Если НЕ Результат Тогда
				Возврат;
			КонецЕсли;
			
			СоздатьДокументНаОсновеФайла(ПолноеИмяФайла, ВладелецФайла, ФормаВладелец, НеОткрыватьКарточкуПослеСозданияИзФайла);
				
		Иначе 
			// Если веб-клиент
			ВремяИзменения = ТекущаяДата(); // Т.к. не можем получить дату модификации файла на диске
			ВремяИзмененияУниверсальное = УниверсальноеВремя(ТекущаяДата());
			Размер = 0;						// Т.к. не можем получить размер файла на диске
			ИмяБезРасширения = "";
			Расширение = "";
			АдресВременногоХранилищаТекста = "";

			// Поместим Файл в ВременноеХранилище
			АдресВременногоХранилищаФайла = "";
			ИмяФайла = "";
			Если НЕ ПоместитьФайл(АдресВременногоХранилищаФайла, ИмяФайла, ИмяФайла, Истина, ФормаВладелец.УникальныйИдентификатор) Тогда
				Возврат;
			КонецЕсли;

			СтрокиПути = РазложитьСтрокуПоТочкамИСлэшам(ИмяФайла);
			Если СтрокиПути.Количество() >= 2 Тогда
				Расширение = СтрокиПути[СтрокиПути.Количество()-1];
				ИмяБезРасширения = СтрокиПути[СтрокиПути.Количество()-2];
			Иначе
				ВызватьИсключение
				  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				    НСтр("ru = 'Ошибка при помещении файла в хранилище: %1'"),ИмяФайла);
			КонецЕсли;
			
			// Создадим карточку файла в БД
			Док = РаботаСФайлами.СоздатьФайлСВерсией(
				ВладелецФайла,
				ИмяБезРасширения,
				ФайловыеФункцииКлиентСервер.РасширениеБезТочки(Расширение),
				ВремяИзменения,
				ВремяИзмененияУниверсальное,
				Размер,
				АдресВременногоХранилищаФайла,
				АдресВременногоХранилищаТекста,
				Истина); // это веб клиент
			
			Если НеОткрыватьКарточкуПослеСозданияИзФайла <> Истина Тогда
				Параметры = Новый Структура("Ключ, НовыйФайл", Док, Истина);
				ОткрытьФорму("Справочник.Файлы.ФормаОбъекта", Параметры, ФормаВладелец);
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли РежимСоздания = 3 Тогда
		// со сканера
		РаботаСоСканеромКлиент.СканироватьИПоказатьДиалогПросмотра(
			ВладелецФайла, 
			ФормаВладелец.УникальныйИдентификатор, 
			ФормаВладелец, 
			НеОткрыватьКарточкуПослеСозданияИзФайла);
	Иначе
		ВызватьИсключение
		  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		    НСтр("ru = 'Неверный режим создания файла: %1'"), РежимСоздания);
	КонецЕсли;
	
КонецПроцедуры // СоздатьФайл()

// Закончить редактирование - по массиву ссылок
//
Функция ЗакончитьРедактированиеПоСсылкам(Знач МассивФайлов, ИдентификаторФормы) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Получение массива данных файлов
	ДанныеФайлов = Новый Массив;
	РаботаСФайлами.ПолучитьДанныеДляМассиваФайлов(МассивФайлов, ДанныеФайлов);
	ВГраницаМассива  = ДанныеФайлов.ВГраница();
	
	Для Инд = 0 По ВГраницаМассива Цикл
		ДанныеФайла = ДанныеФайлов[ВГраницаМассива - Инд];
		
		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует, СтрокаОшибки) Тогда
			ДанныеФайлов.Удалить(ВГраницаМассива - Инд);
		КонецЕсли;
		
	КонецЦикла;	
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	
	ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
	
	ФормаВозврата.Параметры.ФайлСсылка = Неопределено;
	ФормаВозврата.КомментарийКВерсии = "";

	ФормаВозврата.Файл = Неопределено;

	ФормаВозврата.СоздатьНовуюВерсию = Истина;
	ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Истина;

	ВозвратМассив = Новый Массив;
	
	Результат = ФормаВозврата.ОткрытьМодально();
	Если ТипЗнч(Результат) <> Тип("Структура") Тогда
		Возврат ВозвратМассив;
	КонецЕсли;	
	
	КодВозврата = Результат.КодВозврата;
	Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
		Возврат ВозвратМассив;
	КонецЕсли;	
	
	СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
	КомментарийКВерсии = Результат.КомментарийКВерсии;
	
	ПрименитьКоВсем = Ложь;
	ОсвобождатьФайлы = Истина;
	
	// Занять файлы
	Для Каждого Данные Из ДанныеФайлов Цикл
		
		ПоказыватьОповещение = Ложь;
		
		Если ЗакончитьРедактирование(
					Данные.Ссылка, 
					ИдентификаторФормы, 
					Данные.ХранитьВерсии,
					Данные.РедактируетТекущийПользователь, 
					Данные.Редактирует,
					Данные.АвторТекущейВерсии,
					"",
					СоздатьНовуюВерсию,
					КомментарийКВерсии,
					ПоказыватьОповещение,
					ПрименитьКоВсем,
					ОсвобождатьФайлы) Тогда
					
			ВозвратМассив.Добавить(Данные.Ссылка);
		КонецЕсли;	
		
	КонецЦикла;
	
	ПоказатьОповещениеПользователя(  
		НСтр("ru = 'Закончить редактирование файлов'"),
		,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Закончено редактирование файлов (%1 из %2).'"), 
			ВозвратМассив.Количество(), МассивФайлов.Количество()),
		БиблиотекаКартинок.Информация32);
	
	Возврат ВозвратМассив;
	
КонецФункции //ЗакончитьРедактированиеПоСсылкам

// Закончить редактирование Файла и поместить его на сервер
//
Функция ЗакончитьРедактирование(ОбъектСсылка, ИдентификаторФормы, Знач ХранитьВерсии = Неопределено,
			Знач РедактируетТекущийПользователь = Неопределено, 
			Знач Редактирует = Неопределено,
			Знач АвторТекущейВерсии = Неопределено,
			ПереданныйПолныйПутьКФайлу = "",
			СоздатьНовуюВерсию = Неопределено,
			КомментарийКВерсии = Неопределено,
			ПоказыватьОповещение = Истина,
			ПрименитьКоВсем = Ложь,
			ОсвобождатьФайлы = Истина) Экспорт
	Перем ДанныеФайла;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	РасширениеПодключеноКрипто = ПодключитьРасширениеРаботыСКриптографией();
	
	Если НЕ РасширениеПодключено Тогда // веб клиент и нет расширения работы с файлами

		Если ХранитьВерсии = Неопределено Тогда
			ДанныеФайла 				= РаботаСФайлами.ПолучитьДанныеФайла(ОбъектСсылка);
			ХранитьВерсии 					= ДанныеФайла.ХранитьВерсии;
			РедактируетТекущийПользователь 	= ДанныеФайла.РедактируетТекущийПользователь;
			Редактирует 					= ДанныеФайла.Редактирует;
			АвторТекущейВерсии				= ДанныеФайла.АвторТекущейВерсии;
		КонецЕсли;

		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ОбъектСсылка, РедактируетТекущийПользователь, Редактирует, СтрокаОшибки) Тогда
			Предупреждение(СтрокаОшибки);
			Возврат Ложь;
		КонецЕсли;
		
		ПолныйПутьКФайлу = "";

		Если СоздатьНовуюВерсию = Неопределено Тогда
			ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
			
			ФормаВозврата.Параметры.ФайлСсылка = ОбъектСсылка;
			ФормаВозврата.КомментарийКВерсии = "";

			ФормаВозврата.Файл = ОбъектСсылка;

			Если ХранитьВерсии Тогда
				ФормаВозврата.СоздатьНовуюВерсию = Истина;
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если АвторТекущейВерсии <> Редактирует Тогда
					ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Ложь;
				Иначе
					ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Истина;
				КонецЕсли;			
			Иначе
				ФормаВозврата.СоздатьНовуюВерсию = Ложь;
				ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Ложь;
			КонецЕсли;	

			
			Результат = ФормаВозврата.ОткрытьМодально();
			Если ТипЗнч(Результат) <> Тип("Структура") Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			КодВозврата = Результат.КодВозврата;
			Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
			КомментарийКВерсии = Результат.КомментарийКВерсии;
			
		Иначе //  СоздатьНовуюВерсию и КомментарийКВерсии переданы извне
			
			Если ХранитьВерсии Тогда
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если АвторТекущейВерсии <> Редактирует Тогда
					СоздатьНовуюВерсию = Истина;
				КонецЕсли;			
				
			Иначе
				СоздатьНовуюВерсию = Ложь;
			КонецЕсли;	
			
		КонецЕсли;
		
		Интерактивно = Истина;
		
		Пока Истина Цикл
			Попытка
				АдресВременногоХранилища = "";	
				ВыбранныйПутьКФайлу = "";
				ПоказатьНапоминаниеПередПоместитьФайл();
				Если ПоместитьФайл(АдресВременногоХранилища, ПолныйПутьКФайлу, ВыбранныйПутьКФайлу, Интерактивно, ИдентификаторФормы) Тогда
					
					АдресВременногоХранилищаТекста = "";
					ИмяБезРасширения = "";
					Расширение = "";
					
					ЭтоВебКлиент = Истина;
					
					ТекстНеИзвлеченНаКлиенте = Ложь;
					#Если ВебКлиент Тогда
						ТекстНеИзвлеченНаКлиенте = Истина;
					#КонецЕсли	
					
					ВремяИзменения = ТекущаяДата(); // Т.к. не можем получить дату модификации файла на диске
					ВремяИзмененияУниверсальное = УниверсальноеВремя(ТекущаяДата());
					Размер = 0;						// Т.к. не можем получить размер файла на диске
					
					СтрокиПути = РазложитьСтрокуПоТочкамИСлэшам(ВыбранныйПутьКФайлу);
					Если СтрокиПути.Количество() >= 2 Тогда
						Расширение = СтрокиПути[СтрокиПути.Количество()-1];
						ИмяБезРасширения = СтрокиПути[СтрокиПути.Количество()-2];
					КонецЕсли;

					РаботаСФайлами.ПолучитьДанныеФайлаИОпубликоватьИОсвободитьФайл(
						ОбъектСсылка,
						ДанныеФайла,
						СоздатьНовуюВерсию,
						АдресВременногоХранилища,
						КомментарийКВерсии,
						ВремяИзменения,
						ВремяИзмененияУниверсальное,
						Размер,
						ИмяБезРасширения,
						Расширение,
						ПолныйПутьКФайлу,
						АдресВременногоХранилищаТекста,
						ЭтоВебКлиент,
						ТекстНеИзвлеченНаКлиенте,
						ИдентификаторФормы);
					
					НоваяВерсия = ДанныеФайла.ТекущаяВерсия;
					
					Если ПоказыватьОповещение Тогда
						ПоказатьОповещениеПользователя(
							НСтр("ru = 'Редактирование закончено'"),
							ДанныеФайла.НавигационнаяСсылка,
							СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							    НСтр("ru = 'Файл %1 обновлен и освобожден.'"), Строка(ДанныеФайла.Ссылка)),
							БиблиотекаКартинок.Информация32);
					КонецЕсли;	
						
					Возврат Истина;
				Иначе
					Возврат Ложь;
				КонецЕсли;
			Исключение
				
				ОшибкаИнфо = ИнформацияОбОшибке();
				
				Если ОшибкаИнфо.Причина = Неопределено Тогда
					СообщениеОбОшибке =ОшибкаИнфо.Описание;
				Иначе
					СообщениеОбОшибке = ОшибкаИнфо.Причина.Описание;
				КонецЕсли;

				ТекстВопроса =
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось вернуть файл ""%1"" в информационную базу по причине: ""%2""
							 |Повторить операцию?'"),
				Строка(ОбъектСсылка), СообщениеОбОшибке);
				КодВозврата = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ПовторитьОтмена);
				
				Если КодВозврата = КодВозвратаДиалога.Отмена Тогда
					Возврат Ложь;
				КонецЕсли;
				
			КонецПопытки;
		КонецЦикла;

	Иначе // далее код для тонкого (или толстого) клиента (или веб с подключенным расширением)
		ДанныеФайла = РаботаСФайлами.ПолучитьДанныеФайлаИРабочийКаталог(ОбъектСсылка);
	
		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует, СтрокаОшибки) Тогда
			Предупреждение(СтрокаОшибки);
			Возврат Ложь;
		КонецЕсли;
		
		ПолныйПутьКФайлу = ПереданныйПолныйПутьКФайлу;
		Если ПолныйПутьКФайлу = "" Тогда
			ПолныйПутьКФайлу = ФайловыеФункцииКлиент.ПолучитьПолныйПутьКФайлуВРабочемКаталоге(ДанныеФайла);
		КонецЕсли;
		
		// Проверяем наличие файла на диске
		ФайлНовойВерсии = Новый Файл(ПолныйПутьКФайлу);
		Если НЕ ФайлНовойВерсии.Существует() Тогда
			
			Если ПрименитьКоВсем = Ложь Тогда
			
				СтрокаПредупреждения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				    НСтр("ru = 'Не удалось загрузить файл ""%1"" в информационную базу, т.к. он не найден на локальном компьютере'"),
				    Строка(ДанныеФайла.Ссылка));
					
				Если НЕ ПустаяСтрока(ПолныйПутьКФайлу) Тогда
					СтрокаПредупреждения = СтрокаПредупреждения + " (" + ПолныйПутьКФайлу + ").";	
				Иначе
					СтрокаПредупреждения = СтрокаПредупреждения + ".";	
				КонецЕсли;
				
				СтрокаПредупреждения = СтрокаПредупреждения + Символы.ПС + "Освободить файл?";
					
				ПараметрыФормы = 
				Новый Структура("Заголовок, Информация", 
					НСтр("ru = 'Закончить редактирование'"), СтрокаПредупреждения);
					
				Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.ФормаВопросаЗакончитьРедактирование", ПараметрыФормы);
				
				Если ТипЗнч(Результат) <> Тип("Структура") Тогда
					ОсвобождатьФайлы = Ложь;
				Иначе
					КодВозврата = Результат.КодВозврата;
					
					Если КодВозврата = КодВозвратаДиалога.Да Тогда
						ПрименитьКоВсем = Результат.ПрименитьКоВсем;
						ОсвобождатьФайлы = Истина;
					ИначеЕсли КодВозврата = КодВозвратаДиалога.Нет Тогда
						ПрименитьКоВсем = Результат.ПрименитьКоВсем;
						ОсвобождатьФайлы = Ложь; 
					КонецЕсли;
				КонецЕсли;
				
			КонецЕсли;
			
			Если ОсвобождатьФайлы Тогда
				ОсвободитьФайлБезВопроса(ДанныеФайла, ИдентификаторФормы);
				Возврат Истина;
			КонецЕсли;
			
			Возврат Ложь;
			
		КонецЕсли;
	
		Попытка
			ТолькоЧтение = ФайлНовойВерсии.ПолучитьТолькоЧтение();
			ФайлНовойВерсии.УстановитьТолькоЧтение(НЕ ТолькоЧтение);
			ФайлНовойВерсии.УстановитьТолькоЧтение(ТолькоЧтение);
		Исключение
			
			Предупреждение(
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось вернуть файл ""%1"" в информационную базу, т.к. он заблокирован другой программой'"),
					Строка(ДанныеФайла.Ссылка)));

		КонецПопытки;
			
		// Запрашиваем комментарий и признак хранения версии
		Если СоздатьНовуюВерсию = Неопределено Тогда
			
			ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
			
			ФормаВозврата.Параметры.ФайлСсылка = ДанныеФайла.Ссылка;
			ФормаВозврата.КомментарийКВерсии = "";
			
			ФормаВозврата.Файл = ДанныеФайла.Ссылка;

			Если ДанныеФайла.ХранитьВерсии Тогда
				ФормаВозврата.СоздатьНовуюВерсию = Истина;
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если ДанныеФайла.АвторТекущейВерсии <> ДанныеФайла.Редактирует Тогда
					ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Ложь;
				Иначе
					ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Истина;
				КонецЕсли;			
			Иначе
				ФормаВозврата.СоздатьНовуюВерсию = Ложь;
				ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Ложь;
			КонецЕсли;	

			Результат = ФормаВозврата.ОткрытьМодально();
			Если ТипЗнч(Результат) <> Тип("Структура") Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			КодВозврата = Результат.КодВозврата;
			Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
				Возврат Ложь;
			КонецЕсли;	
			
			СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
			КомментарийКВерсии = Результат.КомментарийКВерсии;
				
		Иначе //  СоздатьНовуюВерсию и КомментарийКВерсии переданы извне
			
			Если ДанныеФайла.ХранитьВерсии Тогда
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если ДанныеФайла.АвторТекущейВерсии <> ДанныеФайла.Редактирует Тогда
					СоздатьНовуюВерсию = Истина;
				КонецЕсли;			
				
			Иначе
				СоздатьНовуюВерсию = Ложь;
			КонецЕсли;	
			
		КонецЕсли;
		
		СтараяВерсия = ДанныеФайла.ТекущаяВерсия;
		Интерактивно = Ложь;
		
		РазмерВМб = ФайлНовойВерсии.Размер() / (1024 * 1024);
		ВремяИзменения = ФайлНовойВерсии.ПолучитьВремяИзменения();
		ВремяИзмененияУниверсальное = ФайлНовойВерсии.ПолучитьУниверсальноеВремяИзменения();
		Размер = ФайлНовойВерсии.Размер();
		
		// Файл с признаком шифрован - при окончании редактирования снова шифруем для тех же сертификатов
		Если ДанныеФайла.Зашифрован Тогда
			
			МассивСертификатов = Новый Массив;
			
			Для Каждого СтруктураСертификата Из ДанныеФайла.МассивСертификатовШифрования Цикл
				
				Отпечаток = СтруктураСертификата.Отпечаток;
				
				Сертификат = ЭлектронноЦифроваяПодписьКлиент.ПолучитьСертификатПоОтпечатку(Отпечаток);
				Если Сертификат = Неопределено Тогда
					Сообщение = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Отсутствует сертификат ""%1""'"), 
						СтруктураСертификата.Представление);
					Предупреждение(Сообщение);
					Возврат Ложь;
				КонецЕсли;
				
				МассивСертификатов.Добавить(Сертификат);
				
			КонецЦикла;	
			
			МенеджерКриптографии = ЭлектронноЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
			
			ИмяФайлаСПутемШифрованное = ПолныйПутьКФайлу + ".crp";
			МенеджерКриптографии.Зашифровать(ПолныйПутьКФайлу, ИмяФайлаСПутемШифрованное, МассивСертификатов);
			УдалитьФайл(ПолныйПутьКФайлу);
			ПереместитьФайл(ИмяФайлаСПутемШифрованное, ПолныйПутьКФайлу);
			
		КонецЕсли;	
		
		Пока Истина Цикл
			Попытка
				АдресВременногоХранилища = "";
				ВыбранныйПутьКФайлу = "";
				
				ИмяФайла = ФайлНовойВерсии.Имя;
				
				ТекстПояснения =
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				    НСтр("ru = 'Выполняется передача файла ""%1"" (%2 Мб)...
					|Пожалуйста, подождите.'"),
				    ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
				
				Состояние(ТекстПояснения);
				
				ПомещаемыеФайлы = Новый Массив;
				Описание = Новый ОписаниеПередаваемогоФайла(ПолныйПутьКФайлу, "");
				ПомещаемыеФайлы.Добавить(Описание);
				
				ПомещенныеФайлы = Новый Массив;
				
				Если ПоместитьФайлы(ПомещаемыеФайлы, ПомещенныеФайлы, , Интерактивно, ИдентификаторФормы) Тогда
					Состояние();
					
					Если ПомещенныеФайлы.Количество() = 1 Тогда
						АдресВременногоХранилища = ПомещенныеФайлы[0].Хранение;
					КонецЕсли;
					
					ЭтоВебКлиент = Ложь;
					
					ТекстНеИзвлеченНаКлиенте = Ложь;
					#Если ВебКлиент Тогда
						ТекстНеИзвлеченНаКлиенте = Истина;
					#КонецЕсли	
					
					ИмяБезРасширения = ФайлНовойВерсии.ИмяБезРасширения;
					Расширение = ФайлНовойВерсии.Расширение;

					АдресВременногоХранилищаТекста = ФайловыеФункцииКлиент.ИзвлечьТекстВоВременноеХранилище(
						ПолныйПутьКФайлу, ИдентификаторФормы);
						
					ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";	

					НеМенятьЗаписьВРабочемКаталоге = Ложь;
					Если ПереданныйПолныйПутьКФайлу <> "" Тогда
						НеМенятьЗаписьВРабочемКаталоге = Истина;
					КонецЕсли;
					
					РаботаСФайлами.ОпубликоватьИОсвободитьФайл(
						ДанныеФайла, 
						СоздатьНовуюВерсию,
						АдресВременногоХранилища,
						КомментарийКВерсии,
						ВремяИзменения,
						ВремяИзмененияУниверсальное,
						Размер,
						ИмяБезРасширения,
						Расширение,
						ПолныйПутьКФайлу,
						АдресВременногоХранилищаТекста,
						ЭтоВебКлиент,
						ТекстНеИзвлеченНаКлиенте,
						ВРабочемКаталогеВладельца,
						НеМенятьЗаписьВРабочемКаталоге,
						ИдентификаторФормы);
					
					НоваяВерсия = ДанныеФайла.ТекущаяВерсия;
					
					Если ПереданныйПолныйПутьКФайлу = "" Тогда
						УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования;
						Если УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования = Неопределено Тогда
							УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования = Ложь;
						КонецЕсли;
						
						Если ДанныеФайла.РабочийКаталогВладельца <> "" Тогда
							УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования = Ложь;
						КонецЕсли;
						
						Если УдалятьФайлИзЛокальногоКэшаФайловПриЗавершенииРедактирования Тогда
							ФайловыеФункцииКлиент.УдалитьФайлИзРабочегоКаталога(СтараяВерсия);
						Иначе
							Файл = Новый Файл(ПолныйПутьКФайлу);
							Файл.УстановитьТолькоЧтение(Истина);	
						КонецЕсли;
					КонецЕсли;
					
					Если ПоказыватьОповещение Тогда
						ПоказатьОповещениеПользователя(
							НСтр("ru = 'Редактирование закончено'"),
							ДанныеФайла.НавигационнаяСсылка,
							СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								НСтр("ru = 'Файл %1 обновлен и освобожден.'"),
									Строка(ДанныеФайла.Ссылка)),
								БиблиотекаКартинок.Информация32);
					КонецЕсли;		
					
					// удаляем зашифрованный файл из кеша
					Если ДанныеФайла.Зашифрован Тогда
						УдалитьФайл(ПолныйПутьКФайлу);	
					КонецЕсли;	
					
					Возврат Истина;
				Иначе
					Состояние();
					Возврат Ложь;
				КонецЕсли;

			Исключение

				ОшибкаИнфо = ИнформацияОбОшибке();
				
				Если ОшибкаИнфо.Причина = Неопределено Тогда
					СообщениеОбОшибке =ОшибкаИнфо.Описание;
				Иначе
					СообщениеОбОшибке = ОшибкаИнфо.Причина.Описание;
				КонецЕсли;

				ТекстВопроса = "";
							 
				ТекстВопроса =
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось вернуть файл ""%1"" в информационную базу по причине: ""%2""
							 |Повторить операцию?'"),
							 Строка(ДанныеФайла.Ссылка), СообщениеОбОшибке);
				
				КодВозврата = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ПовторитьОтмена);
				
				Если КодВозврата = КодВозвратаДиалога.Отмена Тогда
					Возврат Ложь;
				КонецЕсли;
				
			КонецПопытки;
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

// Процедура предназначена для освобождения файла. При этом не происходит
// обновления файла, а просто очищается его текущий держатель. Выполняется по массиву ссылок
Процедура ОсвободитьФайлыПоСсылкам(Знач МассивФайлов) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Получение массива данных файлов
	ДанныеФайлов = Новый Массив;
	РаботаСФайлами.ПолучитьДанныеДляМассиваФайлов(МассивФайлов, ДанныеФайлов);
	ВГраницаМассива  = ДанныеФайлов.ВГраница();
	
	Для Инд = 0 По ВГраницаМассива Цикл
		ДанныеФайла = ДанныеФайлов[ВГраницаМассива - Инд];
		
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует, СтрокаОшибки) Тогда
			ДанныеФайлов.Удалить(ВГраницаМассива - Инд);
		КонецЕсли;
		
	КонецЦикла;	
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	Результат = Вопрос(
	  НСтр("ru = 'Отмена редактирования файлов может привести к потере Ваших изменений.
				   |Продолжить?'"),
	РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);
	
	Если Результат <> КодВозвратаДиалога.Да Тогда
		Возврат;
	КонецЕсли;	
	
	// Занять файлы
	Для Каждого ДанныеФайла Из ДанныеФайлов Цикл
		
		НеЗадаватьВопрос = Истина;
		
		ОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.ХранитьВерсии,
			ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует,
			Неопределено, НеЗадаватьВопрос);
	
	КонецЦикла;
	
	ПоказатьОповещениеПользователя(  
		НСтр("ru = 'Отменить редактирование файлов'"),
		,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Отменено редактирование файлов (%1 из %2).'"), 
			ДанныеФайлов.Количество(), МассивФайлов.Количество()),
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры //ОсвободитьФайлыПоСсылкам

// Процедура предназначена для освобождения файла. При этом не происходит
// обновления файла, а просто очищается его текущий держатель.
Процедура ОсвободитьФайл(ОбъектСсылка, Знач ХранитьВерсии = Неопределено,
	Знач РедактируетТекущийПользователь = Неопределено, Знач Редактирует = Неопределено,
	УникальныйИдентификатор = Неопределено,
	НеЗадаватьВопрос = Ложь) Экспорт
	
	Перем ДанныеФайла;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();	
	
	Если ХранитьВерсии = Неопределено Тогда
		ДанныеФайла                 = РаботаСФайлами.ПолучитьДанныеФайла(ОбъектСсылка);
		ХранитьВерсии                   = ДанныеФайла.ХранитьВерсии;
		РедактируетТекущийПользователь  = ДанныеФайла.РедактируетТекущийПользователь;
		Редактирует                     = ДанныеФайла.Редактирует;
	КонецЕсли;

	СтрокаОшибки = "";
	Если НЕ ВозможностьОсвободитьФайл(ОбъектСсылка, РедактируетТекущийПользователь, Редактирует, СтрокаОшибки) Тогда
		Предупреждение(СтрокаОшибки);
		Возврат;
	КонецЕсли;
	
	ПродолжитьРаботу = Истина;
	
	Если НеЗадаватьВопрос = Ложь Тогда
		
		Результат = Вопрос(
		  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		    НСтр("ru = 'Отмена редактирования файла ""%1"" может привести к потере Ваших изменений.
		               |Продолжить?'"), Строка(ОбъектСсылка)),
		РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);
		
		Если Результат <> КодВозвратаДиалога.Да Тогда
			ПродолжитьРаботу = Ложь;
		КонецЕсли;	
		
	КонецЕсли;	
	
	Если ПродолжитьРаботу Тогда
		
		РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
		
		РаботаСФайлами.ПолучитьДанныеФайлаИОсвободитьФайл(ОбъектСсылка, ДанныеФайла, УникальныйИдентификатор);
		
		Если РасширениеПодключено Тогда
			НаЧтение = Истина;
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		КонецЕсли;
		
		Если Не НеЗадаватьВопрос Тогда
			ПоказатьОповещениеПользователя(
				НСтр("ru = 'Файл освобожден'"),
				ДанныеФайла.НавигационнаяСсылка,
				ДанныеФайла.ПолноеНаименованиеВерсии,
				БиблиотекаКартинок.Информация32);
		КонецЕсли;	
		
	КонецЕсли;
	
КонецПроцедуры // ОсвободитьФайл()

// Процедура предназначена для освобождения файла. При этом не происходит
// обновления файла, а просто очищается его текущий держатель.
Процедура ОсвободитьФайлБезВопроса(ДанныеФайла, УникальныйИдентификатор = Неопределено) Экспорт
	
	РаботаСФайлами.ОсвободитьФайл(ДанныеФайла, УникальныйИдентификатор);
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	Если РасширениеПодключено Тогда
		НаЧтение = Истина;
		ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
		ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
	КонецЕсли;
	
	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Файл освобожден'"),
		ДанныеФайла.НавигационнаяСсылка,
		ДанныеФайла.ПолноеНаименованиеВерсии,
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры // ОсвободитьФайл()

// Процедура освобождает файлы по массиву ссылок
//
Процедура ОсвободитьФайлы(ОбъектыСсылка) Экспорт
	
	СписокНевозможноОсвободить = Новый СписокЗначений;

	// Получение массива данных Файлов
	ДанныеФайлов = РаботаСФайлами.ПолучитьДанныеФайла(ОбъектыСсылка);
	ВГраницаМассива  = ДанныеФайлов.ВГраница();	
	
	Для Инд = 0 По ВГраницаМассива Цикл
		ДанныеФайла = ДанныеФайлов[ВГраницаМассива - Инд];
		
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(
				ДанныеФайла.Ссылка, 
				ДанныеФайла.РедактируетТекущийПользователь, 
				ДанныеФайла.Редактирует, 
				СтрокаОшибки) Тогда // освободить невозможно
			
			СписокНевозможноОсвободить.Добавить(ДанныеФайла.Ссылка, СтрокаОшибки);
			ДанныеФайлов.Удалить(ВГраницаМассива - Инд);
		КонецЕсли;
	КонецЦикла;
	
	// Если освободить нельзя, то выдаем диалог
	Если СписокНевозможноОсвободить.Количество() > 0 Тогда 
		Если НЕ ДиалогВопросаСоСписком(
				СписокНевозможноОсвободить, 
				НСтр("ru = 'Освободить остальные файлы?'"),
				НСтр("ru = 'При попытке освободить файлы возникли следующие ошибки:'"),
				НСтр("ru = 'Освободить файлы'")) Тогда
			Возврат;
		КонецЕсли;
	Иначе
		Ответ = Вопрос(
		НСтр("ru = 'Освобождение файлов может привести к потере Ваших изменений.
		           |Освободить файлы?'"),
		РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);

		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	// Освободить файлы
	Для Каждого ДанныеФайла Из ДанныеФайлов Цикл
		
		РаботаСФайлами.ОсвободитьФайл(ДанныеФайла);
		
		Если РасширениеПодключено Тогда
			НаЧтение = Истина;
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		КонецЕсли;
		
		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Файл освобожден'"),
			ДанныеФайла.НавигационнаяСсылка,
			ДанныеФайла.ПолноеНаименованиеВерсии,
			БиблиотекаКартинок.Информация32);
		
	КонецЦикла;
	
КонецПроцедуры

// Процедура выполняет перенос файлов в другую папку - по массиву ссылок
//
Процедура ПеренестиФайлыВПапку(ОбъектыСсылка, Папка) Экспорт
	
	// Получение массива данных Файлов
	ДанныеФайлов = РаботаСФайлами.ПолучитьДанныеФайла(ОбъектыСсылка);

	Для Каждого ДанныеФайла Из ДанныеФайлов Цикл
		
		РаботаСФайлами.ПеренестиФайл(ДанныеФайла, Папка);
		
		ПоказатьОповещениеПользователя(
		НСтр("ru = 'Перенос файла'"),
		ДанныеФайла.НавигационнаяСсылка,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		    НСтр("ru = 'Файл ""%1"" перенесен в папку %2.'"), Строка(ДанныеФайла.Ссылка), Строка(Папка)),
			БиблиотекаКартинок.Информация32);

	КонецЦикла;	
		
КонецПроцедуры	

// Функция раскладывает строку в массив строк, используя "./\" как разделитель
Функция РазложитьСтрокуПоТочкамИСлэшам(Знач Представление)
	Перем ТекущаяПозиция;

	Фрагменты = Новый Массив;
	
	НачальнаяПозиция = 1;
	
	Для ТекущаяПозиция = 1 По СтрДлина(Представление) Цикл
		ТекущийСимвол = Сред(Представление, ТекущаяПозиция, 1);
		Если ТекущийСимвол = "." Или ТекущийСимвол = "/" Или ТекущийСимвол = "\" Тогда
			ТекущийФрагмент = Сред(Представление, НачальнаяПозиция, ТекущаяПозиция - НачальнаяПозиция);
			НачальнаяПозиция = ТекущаяПозиция + 1;
			Фрагменты.Добавить(ТекущийФрагмент);
		КонецЕсли;	
	КонецЦикла;	
	
	Если НачальнаяПозиция <> ТекущаяПозиция Тогда
		ТекущийФрагмент = Сред(Представление, НачальнаяПозиция, ТекущаяПозиция - НачальнаяПозиция);
		Фрагменты.Добавить(ТекущийФрагмент);
	КонецЕсли;	
		
	Возврат Фрагменты;
КонецФункции

// Опубликовать - по массиву ссылок
//
Процедура ОпубликоватьФайлыПоСсылкам(Знач МассивФайлов, ИдентификаторФормы) Экспорт
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	// Получение массива данных файлов
	ДанныеФайлов = Новый Массив;
	РаботаСФайлами.ПолучитьДанныеДляМассиваФайлов(МассивФайлов, ДанныеФайлов);
	ВГраницаМассива  = ДанныеФайлов.ВГраница();
	
	Для Инд = 0 По ВГраницаМассива Цикл
		ДанныеФайла = ДанныеФайлов[ВГраницаМассива - Инд];
		
		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует, СтрокаОшибки) Тогда
			ДанныеФайлов.Удалить(ВГраницаМассива - Инд);
		КонецЕсли;
		
	КонецЦикла;	
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	
	ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
	
	ФормаВозврата.Параметры.ФайлСсылка = Неопределено;
	ФормаВозврата.КомментарийКВерсии = "";

	ФормаВозврата.Файл = Неопределено;

	ФормаВозврата.СоздатьНовуюВерсию = Истина;
	ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Истина;

	Результат = ФормаВозврата.ОткрытьМодально();
	Если ТипЗнч(Результат) <> Тип("Структура") Тогда
		Возврат;
	КонецЕсли;	
	
	КодВозврата = Результат.КодВозврата;
	Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;	
	
	СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
	КомментарийКВерсии = Результат.КомментарийКВерсии;
	
	Для Каждого Данные Из ДанныеФайлов Цикл
		
		ПоказыватьОповещение = Ложь;
		
		ОпубликоватьФайл(
					Данные.Ссылка, 
					ИдентификаторФормы, 
					Данные.ХранитьВерсии,
					Данные.РедактируетТекущийПользователь, 
					Данные.Редактирует,
					Данные.АвторТекущейВерсии,
					"",
					СоздатьНовуюВерсию,
					КомментарийКВерсии,
					ПоказыватьОповещение);
	КонецЦикла;
	
	ПоказатьОповещениеПользователя(  
		НСтр("ru = 'Сохранить изменения файлов'"),
		,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Сохранены изменения файлов (%1 из %2).'"), 
			ДанныеФайлов.Количество(), МассивФайлов.Количество()),
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры //ОпубликоватьФайлыПоСсылкам

// Процедура предназначена для опубликования файла без его освобождения
//
// Параметры:
//
Процедура ОпубликоватьФайл(ОбъектСсылка, ИдентификаторФормы, Знач ХранитьВерсии = Неопределено,
			Знач РедактируетТекущийПользователь = Неопределено, 
			Знач Редактирует = Неопределено,
			Знач АвторТекущейВерсии = Неопределено,
			ПереданныйПолныйПутьКФайлу = "",
			СоздатьНовуюВерсию = Неопределено,
			КомментарийКВерсии = Неопределено,
			ПоказыватьОповещение = Истина) Экспорт
			
	Перем ДанныеФайла;
	Перем АдресВременногоХранилища;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();	

	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	РасширениеПодключеноКрипто = ПодключитьРасширениеРаботыСКриптографией();
	
	Если НЕ РасширениеПодключено Тогда // веб клиент и нет расширения работы с файлами

		Если ХранитьВерсии = Неопределено Тогда
			ДанныеФайла 				= РаботаСФайлами.ПолучитьДанныеФайла(ОбъектСсылка);
			ХранитьВерсии 					= ДанныеФайла.ХранитьВерсии;
			РедактируетТекущийПользователь 	= ДанныеФайла.РедактируетТекущийПользователь;
			Редактирует 					= ДанныеФайла.Редактирует;
			АвторТекущейВерсии				= ДанныеФайла.АвторТекущейВерсии;
		КонецЕсли;

		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ОбъектСсылка, РедактируетТекущийПользователь, Редактирует, СтрокаОшибки) Тогда
			Предупреждение(СтрокаОшибки);
			Возврат;
		КонецЕсли;
		
		ПолныйПутьКФайлу = "";

		Если СоздатьНовуюВерсию = Неопределено Тогда
			
			// Запрашиваем комментарий и признак хранения версии
			ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
			
			ФормаВозврата.Параметры.ФайлСсылка = ОбъектСсылка;
			ФормаВозврата.КомментарийКВерсии = "";

			ФормаВозврата.Файл = ОбъектСсылка;

			Если ХранитьВерсии Тогда
				ФормаВозврата.СоздатьНовуюВерсию = Истина;
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если АвторТекущейВерсии <> Редактирует Тогда
					ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Ложь;
				Иначе
					ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Истина;
				КонецЕсли;			
			Иначе
				ФормаВозврата.СоздатьНовуюВерсию = Ложь;
				ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Ложь;
			КонецЕсли;	

			Результат = ФормаВозврата.ОткрытьМодально();
			Если ТипЗнч(Результат) <> Тип("Структура") Тогда
				Возврат;
			КонецЕсли;	
			
			КодВозврата = Результат.КодВозврата;
			Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
				Возврат;
			КонецЕсли;	
			
			СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
			КомментарийКВерсии = Результат.КомментарийКВерсии;
			
		Иначе //  СоздатьНовуюВерсию и КомментарийКВерсии переданы извне
			
			Если ХранитьВерсии Тогда
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если АвторТекущейВерсии <> Редактирует Тогда
					СоздатьНовуюВерсию = Истина;
				КонецЕсли;			
				
			Иначе
				СоздатьНовуюВерсию = Ложь;
			КонецЕсли;	
			
		КонецЕсли;
		
		Интерактивно = Истина;
		
		ВыбранныйПутьКФайлу = "";
		ПоказатьНапоминаниеПередПоместитьФайл();
		Если ПоместитьФайл(АдресВременногоХранилища, ПолныйПутьКФайлу, ВыбранныйПутьКФайлу, Интерактивно, ИдентификаторФормы) Тогда
			
			ИмяБезРасширения = "";
			Расширение = "";
			ВремяИзменения = ТекущаяДата(); // Т.к. не можем получить дату модификации файла на диске
			ВремяИзмененияУниверсальное = УниверсальноеВремя(ТекущаяДата());
			РазмерФайла = 0;				// Т.к. не можем получить размер файла на диске
			
			ОтносительныйПутьКФайлу = "";
			АдресВременногоХранилищаТекста = "";

			СтрокиПути = РазложитьСтрокуПоТочкамИСлэшам(ВыбранныйПутьКФайлу);
			Если СтрокиПути.Количество() >= 2 Тогда
				Расширение = СтрокиПути[СтрокиПути.Количество()-1];
				ИмяБезРасширения = СтрокиПути[СтрокиПути.Количество()-2];
			КонецЕсли;

			ЭтоВебКлиент = Истина;
			
			ТекстНеИзвлеченНаКлиенте = Ложь;
			#Если ВебКлиент Тогда
				ТекстНеИзвлеченНаКлиенте = Истина;
			#КонецЕсли	
			
			ВРабочемКаталогеВладельца = Ложь;
			
			РаботаСФайлами.ПолучитьДанныеФайлаИОпубликоватьФайл(
				ОбъектСсылка, 
				ДанныеФайла,
				СоздатьНовуюВерсию,
				АдресВременногоХранилища,
				КомментарийКВерсии,
				ВремяИзменения,
				ВремяИзмененияУниверсальное,
				РазмерФайла,
				ИмяБезРасширения,
				Расширение,
				ОтносительныйПутьКФайлу,
				ПолныйПутьКФайлу,
				АдресВременногоХранилищаТекста,
				ЭтоВебКлиент,
				ТекстНеИзвлеченНаКлиенте,
				ВРабочемКаталогеВладельца,
				ИдентификаторФормы);
				
			Если ПоказыватьОповещение Тогда
				ПоказатьОповещениеПользователя(
					НСтр("ru = 'Новая версия сохранена'"),
					ДанныеФайла.НавигационнаяСсылка,
					ДанныеФайла.ПолноеНаименованиеВерсии,
					БиблиотекаКартинок.Информация32);
			КонецЕсли;	
		
		КонецЕсли;

	Иначе // далее код для тонкого (или толстого) клиента (или веб с подключенным расширением)

		ДанныеФайла = РаботаСФайлами.ПолучитьДанныеФайлаИРабочийКаталог(ОбъектСсылка);
		
		ХранитьВерсии = ДанныеФайла.ХранитьВерсии;
	
		// Проверяем возможность освобождения
		СтрокаОшибки = "";
		Если НЕ ВозможностьОсвободитьФайл(ДанныеФайла.Ссылка, ДанныеФайла.РедактируетТекущийПользователь, ДанныеФайла.Редактирует, СтрокаОшибки) Тогда
			Предупреждение(СтрокаОшибки);
			Возврат;
		КонецЕсли;

		ПолныйПутьКФайлу = ПереданныйПолныйПутьКФайлу;
		Если ПолныйПутьКФайлу = "" Тогда
			ПолныйПутьКФайлу = ФайловыеФункцииКлиент.ПолучитьПолныйПутьКФайлуВРабочемКаталоге(ДанныеФайла);
		КонецЕсли;
		
		НеМенятьЗаписьВРабочемКаталоге = Ложь;
		Если ПереданныйПолныйПутьКФайлу <> "" Тогда
			НеМенятьЗаписьВРабочемКаталоге = Истина;
		КонецЕсли;
		
		// Проверяем наличие файла на диске
		ФайлНовойВерсии = Новый Файл(ПолныйПутьКФайлу);
		Если НЕ ФайлНовойВерсии.Существует() Тогда
			
			СтрокаПредупреждения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			    НСтр("ru = 'Не удалось загрузить файл ""%1"" в информационную базу, т.к. он не найден на локальном компьютере'"),
			    Строка(ДанныеФайла.Ссылка));
			Если НЕ ПустаяСтрока(ПолныйПутьКФайлу) Тогда
				СтрокаПредупреждения = СтрокаПредупреждения + " (" + ПолныйПутьКФайлу + ").";	
			Иначе
				СтрокаПредупреждения = СтрокаПредупреждения + ".";	
			КонецЕсли;
			
			СтрокаПредупреждения = СтрокаПредупреждения + Символы.ПС + "Освободить файл?";
			                                                        			
			КодВозврата = Вопрос(СтрокаПредупреждения, РежимДиалогаВопрос.ДаНет);
			
			Если КодВозврата = КодВозвратаДиалога.Да Тогда
				ОсвободитьФайлБезВопроса(ДанныеФайла, ИдентификаторФормы);
			КонецЕсли;
				
			Возврат;
			
		КонецЕсли;
		
		// Запрашиваем комментарий и признак хранения версии
		Если СоздатьНовуюВерсию = Неопределено Тогда

			ФормаВозврата = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВозвратаФайла();
			ФормаВозврата.Параметры.ФайлСсылка = ДанныеФайла.Ссылка;
			ФормаВозврата.КомментарийКВерсии = "";

			ФормаВозврата.Файл = ДанныеФайла.Ссылка;

			Если ДанныеФайла.ХранитьВерсии Тогда
				ФормаВозврата.СоздатьНовуюВерсию = Истина;
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если ДанныеФайла.АвторТекущейВерсии <> ДанныеФайла.Редактирует Тогда
					ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Ложь;
				Иначе
					ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Истина;
				КонецЕсли;			
			Иначе
				ФормаВозврата.СоздатьНовуюВерсию = Ложь;
				ФормаВозврата.Элементы.СоздатьНовуюВерсию.Доступность = Ложь;
			КонецЕсли;	
			
			Результат = ФормаВозврата.ОткрытьМодально();
			Если ТипЗнч(Результат) <> Тип("Структура") Тогда
				Возврат;
			КонецЕсли;	
			
			КодВозврата = Результат.КодВозврата;
			Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
				Возврат;
			КонецЕсли;	
			
			СоздатьНовуюВерсию = Результат.СоздатьНовуюВерсию;
			КомментарийКВерсии = Результат.КомментарийКВерсии;
			
		Иначе //  СоздатьНовуюВерсию и КомментарийКВерсии переданы извне
			
			Если ХранитьВерсии Тогда
				
				// Если автор текущей версии - не текущий пользователь - то галочку «Не создавать новую версию» делаем недоступной
				Если АвторТекущейВерсии <> Редактирует Тогда
					СоздатьНовуюВерсию = Истина;
				КонецЕсли;			
				
			Иначе
				СоздатьНовуюВерсию = Ложь;
			КонецЕсли;	
			
		КонецЕсли;
			
		Интерактивно = Ложь;
		ВыбранныйПутьКФайлу = "";
		
		ИмяФайлаСПутемВременное = "";
		
		РазмерВМб = ФайлНовойВерсии.Размер() / (1024 * 1024);
		ВремяИзменения = ФайлНовойВерсии.ПолучитьВремяИзменения();
		ВремяИзмененияУниверсальное = ФайлНовойВерсии.ПолучитьУниверсальноеВремяИзменения();
		РазмерФайла = ФайлНовойВерсии.Размер();
		
		// Файл с признаком шифрован - при публикации снова шифруем для тех же сертификатов
		Если ДанныеФайла.Зашифрован Тогда
			
			МассивСертификатов = Новый Массив;
			
			Для Каждого СтруктураСертификата Из ДанныеФайла.МассивСертификатовШифрования Цикл
				
				Отпечаток = СтруктураСертификата.Отпечаток;
				
				Сертификат = ЭлектронноЦифроваяПодписьКлиент.ПолучитьСертификатПоОтпечатку(Отпечаток);
				Если Сертификат = Неопределено Тогда
					Сообщение = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Отсутствует сертификат ""%1""'"), 
						СтруктураСертификата.Представление);
					Предупреждение(Сообщение);
					Возврат;
				КонецЕсли;
				
				МассивСертификатов.Добавить(Сертификат);
				
			КонецЦикла;	
			
			МенеджерКриптографии = ЭлектронноЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
			
			ИмяФайлаСПутемШифрованное = ПолныйПутьКФайлу + ".crp";
			МенеджерКриптографии.Зашифровать(ПолныйПутьКФайлу, ИмяФайлаСПутемШифрованное, МассивСертификатов);
			ИмяФайлаСПутемВременное = ПолныйПутьКФайлу + ".bak";
			ПереместитьФайл(ПолныйПутьКФайлу, ИмяФайлаСПутемВременное);
			ПереместитьФайл(ИмяФайлаСПутемШифрованное, ПолныйПутьКФайлу);
			
		КонецЕсли;	
		
		ИмяФайла = ФайлНовойВерсии.Имя;
		
		ТекстПояснения =
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Выполняется передача файла ""%1"" (%2 Мб)...
				|Пожалуйста, подождите.'"),
		    ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
		
		Состояние(ТекстПояснения);

		ПомещаемыеФайлы = Новый Массив;
		Описание = Новый ОписаниеПередаваемогоФайла(ПолныйПутьКФайлу, "");
		ПомещаемыеФайлы.Добавить(Описание);
		
		ПомещенныеФайлы = Новый Массив;
		
		Если ПоместитьФайлы(ПомещаемыеФайлы, ПомещенныеФайлы, , Интерактивно, ИдентификаторФормы) Тогда
			Состояние();
			
			Если ПомещенныеФайлы.Количество() = 1 Тогда
				АдресВременногоХранилища = ПомещенныеФайлы[0].Хранение;
			КонецЕсли;

			ПроинициализироватьПутьКРабочемуКаталогу();
			ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
			
			ОтносительныйПутьКФайлу = "";
			
			ИмяБезРасширения = ФайлНовойВерсии.ИмяБезРасширения;
			Расширение = ФайлНовойВерсии.Расширение;
			
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			
			Если ДанныеФайла.РабочийКаталогВладельца <> "" Тогда // есть рабочий каталог
				ОтносительныйПутьКФайлу = ПолныйПутьКФайлу;
			Иначе
				Позиция = Найти(ПолныйПутьКФайлу, ИмяКаталога);
				Если Позиция <> 0 Тогда
					ОтносительныйПутьКФайлу = Сред(ПолныйПутьКФайлу, СтрДлина(ИмяКаталога) + 1);
				КонецЕсли;
			КонецЕсли;
			
			АдресВременногоХранилищаТекста = ФайловыеФункцииКлиент.ИзвлечьТекстВоВременноеХранилище(
				ПолныйПутьКФайлу, ИдентификаторФормы);

			ЭтоВебКлиент = Ложь;
			
			ТекстНеИзвлеченНаКлиенте = Ложь;
			#Если ВебКлиент Тогда
				ТекстНеИзвлеченНаКлиенте = Истина;
			#КонецЕсли	
			
			РаботаСФайлами.ОпубликоватьФайл(
				ДанныеФайла.Ссылка, 
				СоздатьНовуюВерсию,
				АдресВременногоХранилища,
				КомментарийКВерсии,
				ВремяИзменения,
				ВремяИзмененияУниверсальное,
				РазмерФайла,
				ИмяБезРасширения,
				Расширение,
				ОтносительныйПутьКФайлу,
				ПолныйПутьКФайлу,
				АдресВременногоХранилищаТекста,
				ЭтоВебКлиент,
				ТекстНеИзвлеченНаКлиенте,
				ВРабочемКаталогеВладельца,
				НеМенятьЗаписьВРабочемКаталоге,
				ИдентификаторФормы);
				
			Если ПоказыватьОповещение Тогда
				ПоказатьОповещениеПользователя(
					НСтр("ru = 'Новая версия сохранена'"),
					ДанныеФайла.НавигационнаяСсылка,
					ДанныеФайла.ПолноеНаименованиеВерсии,
					БиблиотекаКартинок.Информация32);
			КонецЕсли;	
				
			// удаляем зашифрованный файл из кеша
			Если ДанныеФайла.Зашифрован Тогда
				ПереместитьФайл(ИмяФайлаСПутемВременное, ПолныйПутьКФайлу);
			КонецЕсли;	
				
		Иначе
			Состояние();
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры // ОпубликоватьФайл()

// Процедура предназначена для интерактивного создания нового Файла
// В частности, происходит вызов диалога выбора режима создания Файла
// Параметры:
//	ВладелецФайла - определяет группу, в которой создается Элемент, если
//		группа неизвестна в момент вызова этого метода - там будет Неопределено
Процедура СозданиеНовогоФайла(ВладелецФайла, ФормаВладелец, РежимСоздания = 1, НеОткрыватьКарточкуПослеСозданияИзФайла = Неопределено) Экспорт
	Форма = РаботаСФайламиКлиентПовтИсп.ПолучитьФормуВыбораВариантаСозданияНовогоФайла();

	Форма.РежимСоздания = РежимСоздания;
	Результат = Форма.ОткрытьМодально();
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		
		СоздатьФайл(Форма.РежимСоздания, ВладелецФайла, ФормаВладелец, НеОткрыватьКарточкуПослеСозданияИзФайла);
		
	КонецЕсли;
	
КонецПроцедуры // СозданиеНовогоФайла()

// Процедура предназначена для копирования существующего Файла
// Параметры:
//	ФайлОснование - откуда копируется Файл (тип - СправочникСсылка)
Процедура СкопироватьФайл(ВладелецФайла, ФайлОснование) Экспорт
	
	Параметры = Новый Структура("ФайлОснование, ВладелецФайла", ФайлОснование, ВладелецФайла);
	Форма = ОткрытьФорму("Справочник.Файлы.ФормаОбъекта", Параметры);
	
КонецПроцедуры // СкопироватьФайл()

// Находится ли в рабочем каталоге Файл для данной версии
Функция ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ТекущаяВерсия, ИмяФайлаСПутем, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца)
	ИмяФайлаСПутем = "";
	
	// Если это активная версия - берем из ДанныеФайла
	Если ДанныеФайла <> Неопределено И ДанныеФайла.ТекущаяВерсия = ТекущаяВерсия Тогда
		ИмяФайлаСПутем = ДанныеФайла.ИмяФайлаСПутемВРабочемКаталоге;
		ВРабочемКаталогеНаЧтение = ДанныеФайла.ВРабочемКаталогеНаЧтение;
	Иначе
		ВРабочемКаталогеНаЧтение = Истина;
		ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
		// Пытаемся найти такую запись в регистре сведений
		ИмяФайлаСПутем = РаботаСФайлами.ПолучитьИмяФайлаСПутемИзРегистра(ТекущаяВерсия, ИмяКаталога, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	КонецЕсли;
	
	Если ИмяФайлаСПутем <> "" Тогда
		// Тут надо еще на наличие на диске проверять 
		ФайлНаДиске = Новый Файл(ИмяФайлаСПутем);
	    Если ФайлНаДиске.Существует() Тогда
			Возврат Истина;	
		Иначе
			ИмяФайлаСПутем = "";
			// Тут же удалим из регистра - т.к. в регистре есть, а на диске нет
			РаботаСФайлами.УдалитьИзРегистра(ТекущаяВерсия);
	    КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;
КонецФункции

// Освободить место для помещения файла - если место есть, ничего не делает
Процедура ОсвободитьМестоВРабочемКаталоге(РеквизитыВерсии)
	#Если НЕ ВебКлиент Тогда
		МаксРазмер = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().МаксимальныйРазмерЛокальногоКэшаФайлов;
		
		// Если размер РабочийКаталог стоит равным 0, то считать что никакого ограничения нет 
		//  и умолчание в 10 Мб не использовать.
		Если МаксРазмер = 0 Тогда
			Возврат;
		КонецЕсли;
		
		ПроинициализироватьПутьКРабочемуКаталогу();
		ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
		
		МассивФайлов = НайтиФайлы(ИмяКаталога, "*.*");
		
		РазмерФайловВРабочемКаталоге = 0;
		КоличествоСуммарное = 0;
		// Вычисляем полный размер файлов в рабочем каталоге
		ФайловыеФункцииКлиент.ОбходФайловРазмер(ИмяКаталога, МассивФайлов, РазмерФайловВРабочемКаталоге, КоличествоСуммарное);
		
		Размер = РеквизитыВерсии.Размер;
		Если РазмерФайловВРабочемКаталоге + Размер > МаксРазмер Тогда
			ФайловыеФункцииКлиент.ОчиститьРабочийКаталог(РазмерФайловВРабочемКаталоге, Размер, Ложь); // ОчищатьВсе= Ложь
		КонецЕсли;
	#КонецЕсли
КонецПроцедуры

// Получить Файл с сервера и зарегистрировать в локальном кеше
Функция ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ИмяФайлаСПутем, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы = Неопределено)
	
	ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
	
	Если ИмяФайлаСПутем = "" Тогда
		ПроинициализироватьПутьКРабочемуКаталогу();
		ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
		
		// Формирование имени файла с расширением
		ИмяФайла = ДанныеФайла.ПолноеНаименованиеВерсии;
		Если НЕ ПустаяСтрока(ДанныеФайла.Расширение) Тогда 
			ИмяФайла = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ИмяФайла, ДанныеФайла.Расширение);
		КонецЕсли;
		
		ИмяФайлаСПутем = "";
		Если НЕ ПустаяСтрока(ИмяФайла) Тогда
			ИмяФайлаСПутем = ФайловыеФункцииКлиентСервер.ПолучитьУникальноеИмяСПутем(ИмяКаталога, ИмяФайла);
			ИмяФайлаСПутем = ИмяКаталога + ИмяФайлаСПутем;
		КонецЕсли;
		
		Если ПустаяСтрока(ИмяФайла) Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Если ВРабочемКаталогеВладельца = Ложь Тогда
		#Если Не ВебКлиент Тогда // в веб клиенте нельзя определить количество свободного места на диске
			ОсвободитьМестоВРабочемКаталоге(ДанныеФайла);
		#КонецЕсли
	КонецЕсли;		

	РазмерФайла = 0;
	
	
	// Запись Файл в каталог
	Попытка
		
		АдресФайла = ДанныеФайла.НавигационнаяСсылкаТекущейВерсии;
		Если ДанныеФайла.Версия <> ДанныеФайла.ТекущаяВерсия Тогда 
			АдресФайла = РаботаСФайлами.ПолучитьНавигационнуюСсылкуДляОткрытия(ДанныеФайла.Версия, ИдентификаторФормы);
		КонецЕсли;
		
		ИмяФайла = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		РазмерВМб = ДанныеФайла.Размер / (1024 * 1024);
		
		ТекстПояснения =
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		    НСтр("ru = 'Выполняется передача файла ""%1"" (%2 Мб)...
				|Пожалуйста, подождите.'"),
		    ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
		
		Состояние(ТекстПояснения);
		
		ПередаваемыеФайлы = Новый Массив;
		Описание = Новый ОписаниеПередаваемогоФайла(ИмяФайла, АдресФайла);
		ПередаваемыеФайлы.Добавить(Описание);
		
		ФайлНаДискеПоИмени = Новый Файл(ИмяФайлаСПутем);
		ПутьКФайлу = ФайлНаДискеПоИмени.Путь;
		Если Прав(ПутьКФайлу,1) <> "\" Тогда
			ПутьКФайлу = ПутьКФайлу + "\";
		КонецЕсли;
		ИмяФайлаСПутем = ПутьКФайлу + ИмяФайла; // могло смениться расширение
		
		Если НЕ ПолучитьФайлы(ПередаваемыеФайлы,, ПутьКФайлу, Ложь) Тогда
			Возврат Ложь;
		КонецЕсли;
		
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(АдресФайла) Тогда
			УдалитьИзВременногоХранилища(АдресФайла);
		КонецЕсли;
		
		Состояние();
		
		Если ДанныеФайла.Зашифрован Тогда
			
			ПредставленияСертификатов = "";
			Для Каждого СтруктураСертификата Из ДанныеФайла.МассивСертификатовШифрования Цикл
				
				Отпечаток = СтруктураСертификата.Отпечаток;
				
				ТолькоВЛичномХранилище = Истина;
				Сертификат = ЭлектронноЦифроваяПодписьКлиент.ПолучитьСертификатПоОтпечатку(Отпечаток, ТолькоВЛичномХранилище);
				Если Сертификат <> Неопределено Тогда // тут собираем только личные сертификаты - с закрытым ключом
					Если НЕ ПустаяСтрока(ПредставленияСертификатов) Тогда
						ПредставленияСертификатов = ПредставленияСертификатов + Символы.ПС;
					КонецЕсли;
					ПредставленияСертификатов = ПредставленияСертификатов + СтруктураСертификата.Представление;
				КонецЕсли;
				
			КонецЦикла;	
			
			Пароль = "";
			Заголовок = НСтр("ru = 'Введите пароль для расшифровки'");
			ПараметрыФормы = Новый Структура("Заголовок, ПредставленияСертификатов, Файл", 
				Заголовок, ПредставленияСертификатов, ДанныеФайла.Ссылка);
			КодВозврата = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВводПароляСОписаниями", ПараметрыФормы);
			Если ТипЗнч(КодВозврата) = Тип("Строка") Тогда
				Пароль = КодВозврата;
			Иначе
				УдалитьФайлы(ИмяФайлаСПутем);
				ИмяФайлаСПутем = "";
				Возврат Ложь;
			КонецЕсли;
			
			Попытка
				МенеджерКриптографии = ЭлектронноЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
				МенеджерКриптографии.ПарольДоступаКЗакрытомуКлючу = Пароль;
				
				ИмяФайлаСПутемРасшифрованное = ИмяФайлаСПутем + ".dec";
				МенеджерКриптографии.Расшифровать(ИмяФайлаСПутем, ИмяФайлаСПутемРасшифрованное);
				
				УдалитьФайлы(ИмяФайлаСПутем);
				ПереместитьФайл(ИмяФайлаСПутемРасшифрованное, ИмяФайлаСПутем);
			Исключение
				УдалитьФайлы(ИмяФайлаСПутем);
				ВызватьИсключение;
			КонецПопытки;
			
		КонецЕсли;	
		
		// Установим время изменения файла таким, как оно стоит в текущей версии
		ФайлНаДиске = Новый Файл(ИмяФайлаСПутем);
		ФайлНаДиске.УстановитьВремяИзменения(ДатаФайлаВБазе);
		
		РазмерФайла = ФайлНаДиске.Размер(); // Т.к. размер на диске может отличаться от размера в базе (при добавлении из веб клиента)
		
		ФайлНаДиске.УстановитьТолькоЧтение(НаЧтение);
		
	Исключение
		Предупреждение(КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		Возврат Ложь;
	КонецПопытки;
	
	ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	
	РаботаСФайлами.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.Версия, ИмяФайлаСПутем, ИмяКаталога, НаЧтение, РазмерФайла, ВРабочемКаталогеВладельца);	
	
	Возврат Истина;
КонецФункции

// Перерегистрировать В рабочем каталоге с другим флагом НаЧтение
Процедура ПеререгистрироватьВРабочемКаталоге(ТекущаяВерсия, ИмяФайлаСПутем, НаЧтение, ВРабочемКаталогеВладельца)
	ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	
	РаботаСФайлами.ЗанестиИнформациюФайлаВРегистр(ТекущаяВерсия, ИмяФайлаСПутем, ИмяКаталога, НаЧтение, 0, ВРабочемКаталогеВладельца);	
	Файл = Новый Файл(ИмяФайлаСПутем);
	Файл.УстановитьТолькоЧтение(НаЧтение);	
КонецПроцедуры

// При переименовании Файл и ВерсияФайла обновляет информацию в рабочем каталоге (имя файла на диске и в регистре)
Процедура ОбновитьИнформациюВРабочемКаталоге(ТекущаяВерсия, НовоеИмя) Экспорт
	ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	ПолноеИмяФайла = "";
	
	ВРабочемКаталогеНаЧтение = Истина;
	ВРабочемКаталогеВладельца = Ложь;
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(Неопределено, ТекущаяВерсия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	Если ФайлВРабочемКаталоге = Ложь Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		Файл = Новый Файл(ПолноеИмяФайла);
		ТолькоИмя = Файл.Имя;
		РазмерФайла = Файл.Размер();
		ПутьБезИмени = Лев(ПолноеИмяФайла, СтрДлина(ПолноеИмяФайла) - СтрДлина(ТолькоИмя));
		НовоеПолноеИмя = ПутьБезИмени + НовоеИмя + Файл.Расширение;
		ПереместитьФайл(ПолноеИмяФайла, НовоеПолноеИмя);
		
		РаботаСФайлами.УдалитьИзРегистра(ТекущаяВерсия);
		РаботаСФайлами.ЗанестиИнформациюФайлаВРегистр(ТекущаяВерсия, НовоеПолноеИмя, ИмяКаталога, ВРабочемКаталогеНаЧтение, РазмерФайла, ВРабочемКаталогеВладельца);
	Исключение
	КонецПопытки;
	
КонецПроцедуры

// Перерегистрировать В рабочем каталоге с другим флагом НаЧтение - если там вообще есть такой Файл
Процедура ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца)
	// Если Файл без файла - ничего не делаем в рабочем каталоге
	Если ДанныеФайла.Версия.Пустая() Тогда 
		Возврат;
	КонецЕсли;

	ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	ПолноеИмяФайла = "";
	
	ВРабочемКаталогеНаЧтение = Истина;
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ДанныеФайла.ТекущаяВерсия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	Если ФайлВРабочемКаталоге = Ложь Тогда
		Возврат;
	КонецЕсли;
	
	РаботаСФайлами.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.ТекущаяВерсия, ПолноеИмяФайла, ИмяКаталога, НаЧтение, 0, ВРабочемКаталогеВладельца);
	Файл = Новый Файл(ПолноеИмяФайла);
	Файл.УстановитьТолькоЧтение(НаЧтение);	
КонецПроцедуры

// Удаление файла со снятием атрибута readonly
Процедура УдалитьФайл(ПолноеИмяФайла, ЗадаватьВопрос = Неопределено, ШапкаВопроса = Неопределено) Экспорт
	ПодтверждатьПриУдаленииИзЛокальногоКэшаФайлов = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПодтверждатьПриУдаленииИзЛокальногоКэшаФайлов;
	Если ЗадаватьВопрос <> Неопределено Тогда
		ПодтверждатьПриУдаленииИзЛокальногоКэшаФайлов = ЗадаватьВопрос;
	КонецЕсли;		
	
	Если ПодтверждатьПриУдаленииИзЛокальногоКэшаФайлов = Истина Тогда
		ТекстВопроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Удалить файл ""%1"" из основного рабочего каталога?'"), ПолноеИмяФайла);
		
		Если ШапкаВопроса <> Неопределено Тогда
			ТекстВопроса = ШапкаВопроса + Символы.ПС + Символы.ПС + ТекстВопроса;
		КонецЕсли;	
		
		Если Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;	
	
	Файл = Новый Файл(ПолноеИмяФайла);
	Файл.УстановитьТолькоЧтение(Ложь);
	УдалитьФайлы(ПолноеИмяФайла);
КонецПроцедуры

// Получает Файл из информационной базы на чтение на локальный диск - в локальный кэш
// и возвращает путь к этому файлу в параметре
Функция ПолучитьФайлВерсииВЛокальныйКэшФайловНаЧтение(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы = Неопределено)
	
	ПолноеИмяФайла = "";
	НаЧтение = Истина;
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	
	ПроинициализироватьПутьКРабочемуКаталогу();
	
	ВРабочемКаталогеНаЧтение = Истина;
	ВРабочемКаталогеВладельца = Ложь;
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ДанныеФайла.Версия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	Если НЕ ФайлВРабочемКаталоге Тогда
		Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
	КонецЕсли;
	
	// Получаем путь файла в рабочем каталоге - с проверкой на уникальность
	ИмяФайлаСПутем = ПолноеИмяФайла;
	Если ИмяФайлаСПутем = "" Тогда
		Предупреждение(НСтр("ru = 'Ошибка помещения файла в локальный кэш файлов.'"));
		Возврат Ложь;
	КонецЕсли;
	
	// Ниже - уже известно, что Файл в рабочем каталоге есть. 
	// Надо проверить его дату модификации и принять решение что делать дальше
	// - перезаписать, спросить пользователя и т.д.
	
	ФайлВерсии = Новый Файл(ПолноеИмяФайла);
	ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
	РазмерФайлаНаДиске = ФайлВерсии.Размер();
	РазмерФайлаВБазе = ДанныеФайла.Размер;
	
	РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
	Если РазницаДат < 0 Тогда
		РазницаДат = -РазницаДат;
	КонецЕсли;
	
	Если РазницаДат <= 1 Тогда // 1 секунда - допустимая разница (на Win95 может быть такое)
		// Дата одинаковая, но размер отличается - странно, но возможно	
		Если РазмерФайлаВБазе <> 0 И РазмерФайлаНаДиске <> РазмерФайлаВБазе Тогда
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("РазмерФайлаНаСервере",     	РазмерФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("РазмерВРабочемКаталоге",      РазмерФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Сообщение",            		НСтр("ru = 'Размер файла в рабочем каталоге и на сервере отличается. Перезаписать файл в рабочем каталоге?'"));
			
			Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.РазмерФайлаВРабочемКаталогеОтличается", ПараметрыОткрытияФормы);
			
			Если Ответ = КодВозвратаДиалога.Да Тогда // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда // Открыть существующий
				Возврат Истина;
			Иначе  // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			КонецЕсли;
		КонецЕсли;
		
		Возврат Истина; // Все совпадает - и дата, и размер
	ИначеЕсли ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда // В рабочем каталоге более старый
		Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
			
			Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более раннюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять из информационной базы и перезаписать?'");
			ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
			
			Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
			
			Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
				Возврат Истина;
			ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
		Иначе // В рабочем каталоге на чтение
			// Перезапишем ни о чем не спросив
			УдалитьФайл(ПолноеИмяФайла);
			Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
		КонецЕсли;
	ИначеЕсли ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
		ЗанятМной = (ДанныеФайла.Редактирует = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ТекущийПользователь);
		Если (ВРабочемКаталогеНаЧтение = Ложь) И ЗанятМной Тогда // В рабочем каталоге на редактирование и занят текущим пользователем
			Возврат Истина; // Ничего делать не надо
		Иначе // В рабочем каталоге на чтение
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
			
			Сообщение = НСтр("ru = 'Файл на локальном компьютере имеет более позднюю дату, возможно, он был изменен. Открыть существующий или взять с сервера и перезаписать?'");
			ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
			
			Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
			
			Если Результат = КодВозвратаДиалога.Да Тогда  // Открыть существующий
				Возврат Истина;
			ИначеЕсли Результат = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			ИначеЕсли Результат = КодВозвратаДиалога.Нет Тогда  // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;
КонецФункции // ПолучитьФайлВерсииВРабочийКаталог()

// Получает Файл из информационной базы на редактирование на локальный диск - в локальный кэш
// и возвращает путь к этому файлу в параметре
Функция ПолучитьФайлВерсииВЛокальныйКэшФайловНаРедактирование(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы = Неопределено)
	ПолноеИмяФайла = "";
	НаЧтение = Ложь;
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	РазмерФайлаВБазе = ДанныеФайла.Размер;
	
	ПроинициализироватьПутьКРабочемуКаталогу();
	
	ВРабочемКаталогеНаЧтение = Истина;
	ВРабочемКаталогеВладельца = Ложь;
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ДанныеФайла.Версия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	Если ФайлВРабочемКаталоге = Ложь Тогда
		Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
	КонецЕсли;

	// Получаем путь файла в рабочем каталоге - с проверкой на уникальность
	ИмяФайлаСПутем = ПолноеИмяФайла;
	Если ИмяФайлаСПутем = "" Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Ошибка помещения файла в локальный кэш файлов.'"));
		Возврат Ложь;
	КонецЕсли;
	
	// Ниже - уже известно, что Файл в рабочем каталоге есть. 
	// Надо проверить его дату модификации и принять решение что делать дальше
	// - перезаписать, спросить пользователя и т.д.
	
	ФайлВерсии = Новый Файл(ПолноеИмяФайла);
	ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
	РазмерФайлаНаДиске = ФайлВерсии.Размер();
	
	РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
	Если РазницаДат < 0 Тогда
		РазницаДат = -РазницаДат;
	КонецЕсли;
	
	Если РазницаДат <= 1 Тогда // 1 секунда - допустимая разница (на Win95 может быть такое)
		// Дата одинаковая, но размер отличается - странно, но возможно	
		Если РазмерФайлаВБазе <> 0 И РазмерФайлаНаДиске <> РазмерФайлаВБазе Тогда
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("РазмерФайлаНаСервере",     	РазмерФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("РазмерВРабочемКаталоге",      РазмерФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Сообщение",            		НСтр("ru = 'Размер файла в рабочем каталоге и на сервере отличается. Перезаписать файл в рабочем каталоге?'"));
			
			Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.РазмерФайлаВРабочемКаталогеОтличается", ПараметрыОткрытияФормы);
			
			Если Ответ = КодВозвратаДиалога.Да Тогда // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда // Открыть существующий
				Возврат Истина;
			Иначе // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			КонецЕсли;
		КонецЕсли;
		
		// Все совпадает - и дата, и размер
		Если ВРабочемКаталогеНаЧтение = НаЧтение Тогда
			Возврат Истина;
		Иначе
			ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
			ПеререгистрироватьВРабочемКаталоге(ДанныеФайла.Версия, ИмяФайлаСПутем, НаЧтение, ВРабочемКаталогеВладельца);
			Возврат Истина;
		КонецЕсли;
	ИначеЕсли ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда // В рабочем каталоге более старый
		Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
			
			Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более раннюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
			ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
			
			Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
			
			Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
				Возврат Истина;
			ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
		Иначе // В рабочем каталоге на чтение
			// Перезапишем ни о чем не спросив
			УдалитьФайл(ПолноеИмяФайла);
			Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
		КонецЕсли;
	ИначеЕсли ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
		
		Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
			Возврат Истина; // Ничего делать не надо
		Иначе // В рабочем каталоге на чтение
			
			ПараметрыОткрытияФормы = Новый Структура;
			ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
			ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
			ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
			ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
			
			Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более позднюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
			ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
			
			Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
			
			Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
				Возврат Истина;
			ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
				ПолноеИмяФайла = "";
				Возврат Ложь;
			ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
				УдалитьФайл(ПолноеИмяФайла);
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;	
КонецФункции // ПолучитьФайлВерсииВРабочийКаталог()

// Получает Файл из информационной базы на чтение на локальный диск - в рабочий каталог папки
// и возвращает путь к этому файлу в параметре
Функция ПолучитьФайлВерсииВРабочийКаталогНаЧтение(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы = Неопределено)
	
	Перем Версия;
	Перем ДатаПомещения;	
	
	НаЧтение = Истина;
	ВРабочемКаталогеВладельца = Истина;
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	
	ПроинициализироватьПутьКРабочемуКаталогу();
	
	Если ПолноеИмяФайла = "" Тогда
		ПолноеИмяФайла = ДанныеФайла.РабочийКаталогВладельца + ДанныеФайла.ПолноеНаименованиеВерсии + "." + ДанныеФайла.Расширение;
	КонецЕсли;
	
	// находим в рабочем каталоге по пути, а не по ВерсииФайла
	Владелец = Неопределено;
	НомерВерсии = Неопределено;
	ВРегистреНаЧтение = Неопределено;
	ВРегистреКодФайла = Неопределено;
	ВРегистреПапка = Неопределено;
	ФайлЕстьВРегистре = РаботаСФайлами.НайтиВРегистреПоПути(ПолноеИмяФайла, Версия, ДатаПомещения, Владелец, НомерВерсии, 
		ВРегистреНаЧтение, ВРегистреКодФайла, ВРегистреПапка);
		
	Если ФайлЕстьВРегистре Тогда
		// проверить что уже есть Файл по этому пути
		ФайлНаДиске = Новый Файл(ПолноеИмяФайла);
		Если НЕ ФайлНаДиске.Существует() Тогда
			РаботаСФайлами.УдалитьИзРегистра(Версия);
			ФайлЕстьВРегистре = Ложь;
		КонецЕсли;	
	КонецЕсли;
	
	Если НЕ ФайлЕстьВРегистре Тогда // на Файл нет ссылки в регистре
		
		// проверить что уже есть Файл по этому пути
		ФайлНаДиске = Новый Файл(ПолноеИмяФайла);
		Если ФайлНаДиске.Существует() Тогда
			
			ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
			ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
			РазмерФайлаВБазе = ДанныеФайла.Размер;

			ДатаФайлаНаДиске = ФайлНаДиске.ПолучитьВремяИзменения();
			РазмерФайлаНаДиске = ФайлНаДиске.Размер();
			
			РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
			Если РазницаДат < 0 Тогда
				РазницаДат = -РазницаДат;
			КонецЕсли;
			
			// размер и дата модификации одинаковы - используем его - зарегистрируем в кеше
			Если РазницаДат <= 1 И РазмерФайлаВБазе = РазмерФайлаНаДиске Тогда
				ФайлНаДиске.УстановитьТолькоЧтение(НаЧтение);
				ПроинициализироватьПутьКРабочемуКаталогу();
				ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
				РаботаСФайлами.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.Версия, ПолноеИмяФайла, ИмяКаталога, НаЧтение, РазмерФайлаВБазе, ВРабочемКаталогеВладельца);
				Возврат Истина;	// используем находящийся на диске Файл
			КонецЕсли;
			
			Если РазницаДат > 1 Тогда
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ПолноеИмяФайла);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				
				Если ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда
					ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
				Иначе	
					ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
				КонецЕсли;	
				
				Сообщение = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Файл ""%1"" в рабочем каталоге на локальном компьютере уже есть, но его дата изменения отличается от даты в информационной базе. Открыть файл из локального каталога или взять из информационной базы и перезаписать?'"),
					Строка(ДанныеФайла.Ссылка));
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					ФайлНаДиске.УстановитьТолькоЧтение(НаЧтение);
					ПроинициализироватьПутьКРабочемуКаталогу();
					ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
					РаботаСФайлами.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.Версия, ПолноеИмяФайла, ИмяКаталога, НаЧтение, РазмерФайлаВБазе, ВРабочемКаталогеВладельца);
					Возврат Истина;
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена ИЛИ Ответ = Неопределено Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла);
					Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
									  
    		Иначе
				СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				                      НСтр("ru = 'Файл ""%3"" в рабочем каталоге уже есть, но его размер отличается от даты на сервере. 
									  | Размер файла в рабочем каталоге: %1
									  | Размер файла на сервере: %2
									  |Переименуйте его или переместите в другой каталог. '"),
				                      РазмерФайлаНаДиске, РазмерФайлаВБазе, ПолноеИмяФайла);			
									  
				Предупреждение(СтрокаСообщения);
				Возврат Ложь; // отмена операции
								  
			КонецЕсли;					  
		КонецЕсли;	
		
		// на Файл нет ссылки в регистре и файла на диске тоже нет
		Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
	КонецЕсли; // на Файл нет ссылки в регистре	 
	
	
	// Файл по пути в рабочем каталоге имеет ссылку в регистре сведений
	Если Версия <> ДанныеФайла.ТекущаяВерсия Тогда // в раб каталоге лежит Файл не той ВерсииФайла (или вообще другой объект Файл)
		
		Если Владелец = ДанныеФайла.Ссылка И ВРегистреНаЧтение = Истина Тогда // на диске тот же Файл, но другой ВерсииФайла - и при этом на чтение
			Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
		КонецЕсли;
		
		СтрокаСообщения = "";
			
		СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							  НСтр("ru = 'В рабочем каталоге уже есть файл ""%1"", связанный с другим файлом информационной базы. 
							  | Код файла на сервере: %2
							  | Код файла на локальном компьютере: %3 '"),
							  ПолноеИмяФайла,
							  ДанныеФайла.КодФайла, 
							  ВРегистреКодФайла);			
							  
		Если ДанныеФайла.Владелец = ВРегистреПапка Тогда // одна и та же папка
			СтрокаСообщения = СтрокаСообщения + Символы.ПС + НСтр("ru = 'Переименуйте один из файлов в информационной базе.'");
		Иначе
			СтрокаСообщения = СтрокаСообщения + Символы.ПС + НСтр("ru = 'Измените рабочий каталог одной из папок в информационной базе
				| (У двух папок не должно быть одинакового рабочего каталога).'");
		КонецЕсли;	
								  
		Предупреждение(СтрокаСообщения);
		Возврат Ложь;
		
	Иначе // Файл по пути в рабочем каталоге - нужной нам версии и на него есть ссылка в регистре
		
		// Ниже - уже известно, что Файл в рабочем каталоге есть. 
		// Надо проверить его дату модификации и принять решение что делать дальше
		// - перезаписать, спросить пользователя и т.д.
		
		ИмяФайлаСПутем = ПолноеИмяФайла;
		ВРабочемКаталогеНаЧтение = ВРегистреНаЧтение;
	
		ФайлВерсии = Новый Файл(ПолноеИмяФайла);
		ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
		РазмерФайлаНаДиске = ФайлВерсии.Размер();
		РазмерФайлаВБазе = ДанныеФайла.Размер;
		
		РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
		Если РазницаДат < 0 Тогда
			РазницаДат = -РазницаДат;
		КонецЕсли;
		
		Если РазницаДат <= 1 Тогда // 1 секунда - допустимая разница (на Win95 может быть такое)
			// Дата одинаковая, но размер отличается - странно, но возможно	
			Если РазмерФайлаВБазе <> 0 И РазмерФайлаНаДиске <> РазмерФайлаВБазе Тогда
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("РазмерФайлаНаСервере",     	РазмерФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("РазмерВРабочемКаталоге",      РазмерФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Сообщение",            		НСтр("ru = 'Размер файла в рабочем каталоге и на сервере отличается. Перезаписать файл в рабочем каталоге?'"));
				
				Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.РазмерФайлаВРабочемКаталогеОтличается", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда // Открыть существующий
					Возврат Истина;
				Иначе  // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				КонецЕсли;
			КонецЕсли;
			
			Возврат Истина; // Все совпадает - и дата, и размер
		ИначеЕсли ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда // В рабочем каталоге более старый
			Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более раннюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
			Иначе // В рабочем каталоге на чтение
				// Перезапишем ни о чем не спросив
				УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
		ИначеЕсли ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
			ЗанятМной = (ДанныеФайла.Редактирует = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ТекущийПользователь);
			Если (ВРабочемКаталогеНаЧтение = Ложь) И ЗанятМной Тогда // В рабочем каталоге на редактирование и занят текущим пользователем
				Возврат Истина; // Ничего делать не надо
			Иначе // В рабочем каталоге на чтение
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере имеет более позднюю дату, возможно, он был изменен. Открыть существующий или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Результат = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Результат = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Результат = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;
		
		Возврат Ложь;
	КонецЕсли;		
	
	
	Возврат Ложь;
КонецФункции // ПолучитьФайлВерсииВРабочийКаталог()

// Получает Файл из информационной базы на редактирование на локальный диск - в рабочий каталог папки
// и возвращает путь к этому файлу в параметре
Функция ПолучитьФайлВерсииВРабочийКаталогНаРедактирование(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы = Неопределено)
	
	Перем Версия;
	Перем ДатаПомещения;	
	
	НаЧтение = Ложь;
	ВРабочемКаталогеВладельца = Истина;
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	
	ПроинициализироватьПутьКРабочемуКаталогу();
	
	Если ПолноеИмяФайла = "" Тогда
		ПолноеИмяФайла = ДанныеФайла.РабочийКаталогВладельца + ДанныеФайла.ПолноеНаименованиеВерсии + "." + ДанныеФайла.Расширение;
	КонецЕсли;
	
	// находим в рабочем каталоге по пути, а не по ВерсииФайла
	Владелец = Неопределено;
	НомерВерсии = Неопределено;
	ВРегистреНаЧтение = Неопределено;
	ВРегистреКодФайла = Неопределено;
	ВРегистреПапка = Неопределено;
	ФайлЕстьВРегистре = РаботаСФайлами.НайтиВРегистреПоПути(ПолноеИмяФайла, Версия, ДатаПомещения, Владелец, НомерВерсии, 
		ВРегистреНаЧтение, ВРегистреКодФайла, ВРегистреПапка);
	
	Если ФайлЕстьВРегистре Тогда
		// проверить что уже есть Файл по этому пути
		ФайлНаДиске = Новый Файл(ПолноеИмяФайла);
		Если НЕ ФайлНаДиске.Существует() Тогда
			РаботаСФайлами.УдалитьИзРегистра(Версия);
			ФайлЕстьВРегистре = Ложь;
		КонецЕсли;	
	КонецЕсли;
	
	Если НЕ ФайлЕстьВРегистре Тогда // на Файл нет ссылки в регистре
		
		// проверить что уже есть Файл по этому пути
		ФайлНаДиске = Новый Файл(ПолноеИмяФайла);
		Если ФайлНаДиске.Существует() Тогда
			
			ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
			ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
			РазмерФайлаВБазе = ДанныеФайла.Размер;

			ДатаФайлаНаДиске = ФайлНаДиске.ПолучитьВремяИзменения();
			РазмерФайлаНаДиске = ФайлНаДиске.Размер();
			
			РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
			Если РазницаДат < 0 Тогда
				РазницаДат = -РазницаДат;
			КонецЕсли;
			
			// размер и дата модификации одинаковы - используем его - зарегистрируем в кеше
			Если РазницаДат <= 1 И РазмерФайлаВБазе = РазмерФайлаНаДиске Тогда
				ФайлНаДиске.УстановитьТолькоЧтение(НаЧтение);
				ПроинициализироватьПутьКРабочемуКаталогу();
				ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
				
				РаботаСФайлами.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.Версия, ПолноеИмяФайла, ИмяКаталога, НаЧтение, РазмерФайлаВБазе, ВРабочемКаталогеВладельца);
				Возврат Истина;	// используем находящийся на диске Файл
			КонецЕсли;
			
			Если РазницаДат > 1 Тогда
				СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				                      НСтр("ru = 'Файл ""%3"" в рабочем каталоге уже есть, но его дата изменения отличается от даты на сервере. 
									  | Дата изменения файла в рабочем каталоге: %1
									  | Дата изменения файла на сервере: %2
									  |Переименуйте его или переместите в другой каталог. '"),
				                      ДатаФайлаНаДиске, ДатаФайлаВБазе, ПолноеИмяФайла);
									  
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ПолноеИмяФайла);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				
				Если ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда
					ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
				Иначе	
					ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
				КонецЕсли;	
				
				Сообщение = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Файл ""%1"" в рабочем каталоге на локальном компьютере уже есть, но его дата изменения отличается от даты на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'"),
					Строка(ДанныеФайла.Ссылка));
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					ФайлНаДиске.УстановитьТолькоЧтение(НаЧтение);
					ПроинициализироватьПутьКРабочемуКаталогу();
					ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
					
					РаботаСФайлами.ЗанестиИнформациюФайлаВРегистр(ДанныеФайла.Версия, ПолноеИмяФайла, ИмяКаталога, НаЧтение, РазмерФайлаВБазе, ВРабочемКаталогеВладельца);
					Возврат Истина;	// используем находящийся на диске Файл
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена ИЛИ Ответ = Неопределено Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла);
					Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
									  
    		Иначе
				СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				                      НСтр("ru = 'Файл ""%3"" в рабочем каталоге уже есть, но его размер отличается от даты на сервере. 
									  | Размер файла в рабочем каталоге: %1
									  | Размер файла на сервере: %2
									  |Переименуйте его или переместите в другой каталог. '"),
				                      РазмерФайлаНаДиске, РазмерФайлаВБазе, ПолноеИмяФайла);			
									  
				Предупреждение(СтрокаСообщения);
				Возврат Ложь; // отмена операции
									  
			КонецЕсли;					  
		КонецЕсли;	
		
		// на Файл нет ссылки в регистре и файла на диске тоже нет
		Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
	КонецЕсли; // на Файл нет ссылки в регистре	 
	
	
	// Файл по пути в рабочем каталоге имеет ссылку в регистре сведений
	Если Версия <> ДанныеФайла.ТекущаяВерсия Тогда // в раб каталоге лежит Файл не той ВерсииФайла (или вообще другой объект Файл)
		
		Если Владелец = ДанныеФайла.Ссылка И ВРегистреНаЧтение = Истина Тогда // на диске тот же Файл, но другой ВерсииФайла - и при этом на чтение
			Возврат ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
		КонецЕсли;
		
		СтрокаСообщения = "";
			
		СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							  НСтр("ru = 'В рабочем каталоге уже есть файл ""%1"", связанный с другим файлом информационной базы. 
							  | Код файла на сервере: %2
							  | Код файла на локальном компьютере: %3 '"),
							  ПолноеИмяФайла,
							  ДанныеФайла.КодФайла, 
							  ВРегистреКодФайла);			
							  
		Если ДанныеФайла.Владелец = ВРегистреПапка Тогда // одна и та же папка
			СтрокаСообщения = СтрокаСообщения + Символы.ПС + НСтр("ru = 'Переименуйте один из файлов в информационной базе.'");
		Иначе
			СтрокаСообщения = СтрокаСообщения + Символы.ПС + НСтр("ru = 'Измените рабочий каталог одной из папок в информационной базе
				| (У двух папок не должно быть одинакового рабочего каталога).'");
		КонецЕсли;	
								  
		Предупреждение(СтрокаСообщения);
		Возврат Ложь;
		
	Иначе // Файл по пути в рабочем каталоге - нужной нам версии и на него есть ссылка в регистре
		
		// Ниже - уже известно, что Файл в рабочем каталоге есть. 
		// Надо проверить его дату модификации и принять решение что делать дальше
		// - перезаписать, спросить пользователя и т.д.
		
		ИмяФайлаСПутем = ПолноеИмяФайла;
		ВРабочемКаталогеНаЧтение = ВРегистреНаЧтение;
	
		ФайлВерсии = Новый Файл(ПолноеИмяФайла);
		ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
		РазмерФайлаНаДиске = ФайлВерсии.Размер();
		РазмерФайлаВБазе = ДанныеФайла.Размер;
		
		РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
		Если РазницаДат < 0 Тогда
			РазницаДат = -РазницаДат;
		КонецЕсли;
		
		Если РазницаДат <= 1 Тогда // 1 секунда - допустимая разница (на Win95 может быть такое)
			// Дата одинаковая, но размер отличается - странно, но возможно	
			Если РазмерФайлаВБазе <> 0 И РазмерФайлаНаДиске <> РазмерФайлаВБазе Тогда
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("РазмерФайлаНаСервере",     	РазмерФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("РазмерВРабочемКаталоге",      РазмерФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Сообщение",            		НСтр("ru = 'Размер файла в рабочем каталоге и на сервере отличается. Перезаписать файл в рабочем каталоге?'"));
				
				Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.РазмерФайлаВРабочемКаталогеОтличается", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда // Открыть существующий
					Возврат Истина;
				Иначе // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				КонецЕсли;
			КонецЕсли;
			
			// Все совпадает - и дата, и размер
			Если ВРабочемКаталогеНаЧтение = НаЧтение Тогда
				Возврат Истина;
			Иначе
				ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
				ПеререгистрироватьВРабочемКаталоге(ДанныеФайла.Версия, ИмяФайлаСПутем, НаЧтение, ВРабочемКаталогеВладельца);
				Возврат Истина;
			КонецЕсли;
		ИначеЕсли ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда // В рабочем каталоге более старый
			Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более раннюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
			Иначе // В рабочем каталоге на чтение
				// Перезапишем ни о чем не спросив
				УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
				Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
			КонецЕсли;
		ИначеЕсли ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
			
			Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
				Возврат Истина; // Ничего делать не надо
			Иначе // В рабочем каталоге на чтение
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более позднюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
					Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайла, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;
		
		Возврат Ложь;
	КонецЕсли;		
	
	
	Возврат Ложь;
КонецФункции // ПолучитьФайлВерсииВРабочийКаталог()

// Получить Файл из информационной базы на локальный диск и возвращает путь
//к этому файлу в параметре
Функция ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы = Неопределено) Экспорт
	
	ПроинициализироватьПутьКРабочемуКаталогу();
	ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	Если ИмяКаталога = Неопределено ИЛИ ПустаяСтрока(ИмяКаталога) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	РабочийКаталогВладельца = ДанныеФайла.РабочийКаталогВладельца;
	
	НаЧтение = ДанныеФайла.НаЧтение;
	Если (НаЧтение И РабочийКаталогВладельца = "") Или ДанныеФайла.Версия <> ДанныеФайла.ТекущаяВерсия Тогда 
		Возврат ПолучитьФайлВерсииВЛокальныйКэшФайловНаЧтение(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы);
	ИначеЕсли РабочийКаталогВладельца = "" Тогда
		Возврат ПолучитьФайлВерсииВЛокальныйКэшФайловНаРедактирование(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы);
	ИначеЕсли НаЧтение И РабочийКаталогВладельца <> "" Тогда 
		Возврат ПолучитьФайлВерсииВРабочийКаталогНаЧтение(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы);
	ИначеЕсли НаЧтение = Ложь И РабочийКаталогВладельца <> "" Тогда
		Возврат ПолучитьФайлВерсииВРабочийКаталогНаРедактирование(ДанныеФайла, ПолноеИмяФайла, ИдентификаторФормы);
	КонецЕсли;
	
КонецФункции // ПолучитьФайлВерсииВРабочийКаталог()

// Получить Файл с сервера и зарегистрировать в рабочем каталоге
Функция ПолучитьССервераИЗарегистрироватьВРабочемКаталоге(ДанныеФайла, ПолноеИмяФайлаВРабочемКаталоге, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы)
	
	ПолноеИмяФайла = "";
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	
	ПроинициализироватьПутьКРабочемуКаталогу();
	
	ВРабочемКаталогеНаЧтение = Истина;
	ВРабочемКаталогеВладельца = Ложь;
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ДанныеФайла.Версия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	Если ФайлВРабочемКаталоге Тогда
		// Получаем путь файла в рабочем каталоге - с проверкой на уникальность
		ИмяФайлаСПутем = ПолноеИмяФайла;
		Если ИмяФайлаСПутем = "" Тогда
			Предупреждение(НСтр("ru = 'Ошибка помещения файла в рабочий каталог.'"));
			Возврат Ложь;
		КонецЕсли;
		
		// Ниже - уже известно, что Файл в рабочем каталоге есть. 
		// Надо проверить его дату модификации и принять решение что делать дальше
		// - перезаписать, спросить пользователя и т.д.
		
		ФайлВерсии = Новый Файл(ПолноеИмяФайла);
		ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
		РазмерФайлаНаДиске = ФайлВерсии.Размер();
		РазмерФайлаВБазе = ДанныеФайла.Размер;
		
		РазницаДат = ДатаФайлаНаДиске - ДатаФайлаВБазе;
		Если РазницаДат < 0 Тогда
			РазницаДат = -РазницаДат;
		КонецЕсли;
		
		Если РазницаДат <= 1 Тогда // 1 секунда - допустимая разница (на Win95 может быть такое)
			// Дата одинаковая, но размер отличается - странно, но возможно	
			Если РазмерФайлаВБазе <> 0 И РазмерФайлаНаДиске <> РазмерФайлаВБазе Тогда
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("РазмерФайлаНаСервере",     	РазмерФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("РазмерВРабочемКаталоге",      РазмерФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Сообщение",            		НСтр("ru = 'Размер файла в рабочем каталоге и на сервере отличается. Перезаписать файл в рабочем каталоге?'"));
				
				Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.РазмерФайлаВРабочемКаталогеОтличается", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда // Открыть существующий
					Возврат Истина;
				Иначе  // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				КонецЕсли;
			КонецЕсли;
			
			// Все совпадает - и дата, и размер - удаляем и потом получаем в рабочий каталог папки
			УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
			
		ИначеЕсли ДатаФайлаНаДиске < ДатаФайлаВБазе Тогда // В рабочем каталоге более старый
			Если ВРабочемКаталогеНаЧтение = Ложь Тогда // В рабочем каталоге на редактирование
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более старый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере, отмеченный как взятый на редактирование, имеет более раннюю дату изменения, чем на сервере. Открыть файл из локального каталога или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Ответ = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
				КонецЕсли;
			Иначе // В рабочем каталоге на чтение
				// Перезапишем ни о чем не спросив
				УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
			КонецЕсли;
		ИначеЕсли ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
			ЗанятМной = (ДанныеФайла.Редактирует = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ТекущийПользователь);
			Если (ВРабочемКаталогеНаЧтение = Ложь) И ЗанятМной Тогда // В рабочем каталоге на редактирование и занят текущим пользователем
				Возврат Истина; // Ничего делать не надо - т.е. не надо удалять из локал кеш и класть в рабочий каталог - т.к. пропадут изменения
			Иначе // В рабочем каталоге на чтение
				
				ПараметрыОткрытияФормы = Новый Структура;
				ПараметрыОткрытияФормы.Вставить("Файл",                		ИмяФайлаСПутем);
				ПараметрыОткрытияФормы.Вставить("ВремяИзмененияНаСервере",     ДатаФайлаВБазе);
				ПараметрыОткрытияФормы.Вставить("ВРабочемКаталоге",            ДатаФайлаНаДиске);
				ПараметрыОткрытияФормы.Вставить("Заголовок",            		"В рабочем каталоге более новый файл");
				
				Сообщение = НСтр("ru = 'Файл на локальном компьютере имеет более позднюю дату, возможно, он был изменен. Открыть существующий или взять с сервера и перезаписать?'");
				ПараметрыОткрытияФормы.Вставить("Сообщение", Сообщение);
				
				Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВРабочемКаталогеБолееНовыйФайл", ПараметрыОткрытияФормы);
				
				Если Результат = КодВозвратаДиалога.Да Тогда  // Открыть существующий
					Возврат Истина;
				ИначеЕсли Результат = КодВозвратаДиалога.Отмена Тогда // Выйти ничего не делая
					ПолноеИмяФайла = "";
					Возврат Ложь;
				ИначеЕсли Результат = КодВозвратаДиалога.Нет Тогда  // Перезаписать
					УдалитьФайл(ПолноеИмяФайла, Ложь); // в рабочем каталоге настройка подтверждения при удалении не используется
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ПолучитьССервераИЗарегистрироватьВЛокальномКэшеФайлов(ДанныеФайла, ПолноеИмяФайлаВРабочемКаталоге, ДатаФайлаВБазе, НаЧтение, ИдентификаторФормы);
КонецФункции

// Функция предназначена для открытия файла соответствующим приложением
//
Процедура ОткрытьФайлПриложением(ДанныеФайла, ИмяОткрываемогоФайла)
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	Если РасширениеПодключено Тогда
		// Открыть Файл
		Попытка
			
			ЗапуститьПриложение(ИмяОткрываемогоФайла);
			
		Исключение
			
			Инфо = ИнформацияОбОшибке();
			Предупреждение(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			                      НСтр("ru = 'Описание=""%1""'"),
			                      Инфо.Описание));
			
		КонецПопытки;
	КонецЕсли;
КонецПроцедуры // ОткрытьФайл()

// Сохранение на диск Файла
// 
Функция СохранитьКак(ДанныеФайла) Экспорт
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	РасширениеПодключеноКрипто = ПодключитьРасширениеРаботыСКриптографией();
	
	Если РасширениеПодключено Тогда

		// проверим - если файл уже есть в кеше, и он новее чем в базе - дадим диалог с выбором
		ПутьКФайлуВКеше = "";
		Если ДанныеФайла.РедактируетТекущийПользователь Тогда
			ПроинициализироватьПутьКРабочемуКаталогу();
			ВРабочемКаталогеНаЧтение = Истина;
			ВРабочемКаталогеВладельца = Ложь;
			ПолноеИмяФайла = "";
			ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(ДанныеФайла, ДанныеФайла.Версия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
			
			Если ФайлВРабочемКаталоге = Истина Тогда
				
				ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
				ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);

				ФайлВерсии = Новый Файл(ПолноеИмяФайла);
				ДатаФайлаНаДиске = ФайлВерсии.ПолучитьВремяИзменения();
				
				Если ДатаФайлаНаДиске > ДатаФайлаВБазе Тогда // В рабочем каталоге более новый (изменен пользователем со стороны)		
				
					ПараметрыОткрытияФормы = Новый Структура;
					ПараметрыОткрытияФормы.Вставить("Файл",       ПолноеИмяФайла);
					
					Сообщение = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Дата изменения файла ""%1"" на локальном компьютере более поздняя, чем в информационной базе. Возможно, он был изменен.'"), 
						Строка(ДанныеФайла.Ссылка));
					ПараметрыОткрытияФормы.Вставить("Сообщение",  Сообщение);
					
					Ответ = ОткрытьФормуМодально("Справочник.Файлы.Форма.РежимСозданияФайлаДляСохранитьКак", ПараметрыОткрытияФормы);
					
					Если Ответ = КодВозвратаДиалога.Отмена ИЛИ Ответ = Неопределено Тогда
						Возврат "";
					КонецЕсли;	
					
					Если Ответ = 1 Тогда // На основе файла на локальном компьютере
						ПутьКФайлуВКеше = ПолноеИмяФайла;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;	
		
		ПутьВыбора = ДанныеФайла.ПапкаДляСохранитьКак;
		Если ПутьВыбора = Неопределено ИЛИ ПутьВыбора = "" Тогда
			
			ПутьВыбора = "";
		#Если НЕ ВебКлиент Тогда	

			Если СтандартныеПодсистемыКлиентПовтИсп.ПараметрыРаботыКлиента().ЭтоБазоваяВерсияКонфигурации Тогда
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Данная операция не поддерживается в базовой версии.'"));
				Возврат "";
			КонецЕсли;
			
			Оболочка = Новый COMОбъект("MSScriptControl.ScriptControl");
			Оболочка.Language = "vbscript";
			Оболочка.AddCode("
				|Function SpecialFoldersName(Name)
				|set Shell=CreateObject(""WScript.Shell"")
				|SpecialFoldersName=Shell.SpecialFolders(Name)
				|End Function");
			ПутьВыбора = Оболочка.Run("SpecialFoldersName", "MyDocuments");
		#КонецЕсли	
		
		КонецЕсли;

		Пароль = "";
		СохранятьСРасшифровкой = Ложь;
		РасширениеДляЗашифрованныхФайлов = "";
		Если ДанныеФайла.Зашифрован Тогда
			
			ПредставленияСертификатов = "";
			Для Каждого СтруктураСертификата Из ДанныеФайла.МассивСертификатовШифрования Цикл
				
				Отпечаток = СтруктураСертификата.Отпечаток;
				
				ТолькоВЛичномХранилище = Истина;
				Сертификат = ЭлектронноЦифроваяПодписьКлиент.ПолучитьСертификатПоОтпечатку(Отпечаток, ТолькоВЛичномХранилище);
				Если Сертификат <> Неопределено Тогда // тут собираем только личные сертификаты - с закрытым ключом
					Если НЕ ПустаяСтрока(ПредставленияСертификатов) Тогда
						ПредставленияСертификатов = ПредставленияСертификатов + Символы.ПС;
					КонецЕсли;
					ПредставленияСертификатов = ПредставленияСертификатов + СтруктураСертификата.Представление;
				КонецЕсли;
				
			КонецЦикла;	
			
			Заголовок = НСтр("ru = 'Выбор режима сохранения'");
			ПараметрыФормы = Новый Структура("Заголовок, ПредставленияСертификатов", 
				Заголовок, ПредставленияСертификатов);
			КодВозврата = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВыборСохраненияШифрованногоФайла", ПараметрыФормы);
			Если ТипЗнч(КодВозврата) = Тип("Структура") Тогда
				
				Пароль = КодВозврата.Пароль;
				РасширениеДляЗашифрованныхФайлов = КодВозврата.РасширениеДляЗашифрованныхФайлов;
				
				Если КодВозврата.СохранятьСРасшифровкой = 1 Тогда
					СохранятьСРасшифровкой = Истина;
				Иначе
					СохранятьСРасшифровкой = Ложь;
				КонецЕсли;	
				
			Иначе
				Возврат "";
			КонецЕсли;
			
		КонецЕсли;	
		
		ИмяСРасширением = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		Расширение = ДанныеФайла.Расширение;
		
		Если НЕ СохранятьСРасшифровкой Тогда
			ИмяСРасширением = ИмяСРасширением + "." + РасширениеДляЗашифрованныхФайлов;
			Расширение = РасширениеДляЗашифрованныхФайлов;
		КонецЕсли;	
		
		// выбираем путь к файлу на диске
		ВыборФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
		ВыборФайла.МножественныйВыбор = Ложь;
		ВыборФайла.ПолноеИмяФайла = ИмяСРасширением;
		Фильтр = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Все файлы (*.%1)|*.%1'"), Расширение, Расширение);
		ВыборФайла.Фильтр = Фильтр;
		ВыборФайла.Каталог = ПутьВыбора;
		
		Если ВыборФайла.Выбрать() Тогда
			
			АдресФайла = ДанныеФайла.НавигационнаяСсылкаТекущейВерсии;
			
			ИмяФайла = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
			РазмерВМб = ДанныеФайла.Размер / (1024 * 1024);
			
			ТекстПояснения =
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Выполняется сохранение файла ""%1"" (%2 Мб)...
					|Пожалуйста, подождите.'"),
				ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
				
			Состояние(ТекстПояснения);	
			
			Файл = Новый Файл(ВыборФайла.ПолноеИмяФайла);
			Если Файл.Существует() Тогда
				Если ПутьКФайлуВКеше <> ВыборФайла.ПолноеИмяФайла Тогда
					Файл.УстановитьТолькоЧтение(Ложь);
					УдалитьФайлы(ВыборФайла.ПолноеИмяФайла);
				КонецЕсли;
			КонецЕсли;
			
			Если ПутьКФайлуВКеше = "" Тогда
				
				ПередаваемыеФайлы = Новый Массив;
				Описание = Новый ОписаниеПередаваемогоФайла(ВыборФайла.ПолноеИмяФайла, АдресФайла);
				ПередаваемыеФайлы.Добавить(Описание);
				
				ПутьКФайлу = Файл.Путь;
				Если Прав(ПутьКФайлу,1) <> "\" Тогда
					ПутьКФайлу = ПутьКФайлу + "\";
				КонецЕсли;
				
				// Сохраним Файл из БД на диск
				Если ПолучитьФайлы(ПередаваемыеФайлы,, ПутьКФайлу, Ложь) Тогда
					
					// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
					Если ЭтоАдресВременногоХранилища(АдресФайла) Тогда
						УдалитьИзВременногоХранилища(АдресФайла);
					КонецЕсли;
					
					Если СохранятьСРасшифровкой Тогда
						ИмяФайлаСПутем = ВыборФайла.ПолноеИмяФайла;
						
						Попытка
							МенеджерКриптографии = ЭлектронноЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
							МенеджерКриптографии.ПарольДоступаКЗакрытомуКлючу = Пароль;
							
							ИмяФайлаСПутемРасшифрованное = ИмяФайлаСПутем + ".dec";
							МенеджерКриптографии.Расшифровать(ИмяФайлаСПутем, ИмяФайлаСПутемРасшифрованное);
							
							УдалитьФайлы(ИмяФайлаСПутем);
							ПереместитьФайл(ИмяФайлаСПутемРасшифрованное, ИмяФайлаСПутем);
						Исключение
							УдалитьФайлы(ИмяФайлаСПутем);
							ВызватьИсключение;
						КонецПопытки;
					КонецЕсли;
					
					
					НовыйФайл = Новый Файл(ВыборФайла.ПолноеИмяФайла);
					
					ДатаСоздаваемогоФайлаНаДиске = ДанныеФайла.ДатаМодификацииУниверсальная;
					ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаСоздаваемогоФайлаНаДиске);
					
					НовыйФайл.УстановитьВремяИзменения(ДатаСоздаваемогоФайлаНаДиске);

					Состояние(НСтр("ru = 'Файл успешно сохранен'"), , ВыборФайла.ПолноеИмяФайла);
				КонецЕсли;
			Иначе
				Если ПутьКФайлуВКеше <> ВыборФайла.ПолноеИмяФайла Тогда
					КопироватьФайл(ПутьКФайлуВКеше, ВыборФайла.ПолноеИмяФайла);
				КонецЕсли;
				Состояние(НСтр("ru = 'Файл успешно сохранен'"), , ВыборФайла.ПолноеИмяФайла);
			КонецЕсли;
			
			ПутьВыбораПрежний = ПутьВыбора;
			Файл = Новый Файл(ВыборФайла.ПолноеИмяФайла);
			ПутьВыбора = Файл.Путь;
			Если ПутьВыбораПрежний <> ПутьВыбора Тогда
				ОбщегоНазначения.ХранилищеОбщихНастроекСохранить("НастройкиПрограммы", "ПапкаДляСохранитьКак",  ПутьВыбора);
			КонецЕсли;
			
			Возврат ВыборФайла.ПолноеИмяФайла;
		КонецЕсли;
		
	Иначе  // веб клиент
		АдресФайла = ДанныеФайла.НавигационнаяСсылкаТекущейВерсии;
		
		ИмяФайла = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		РазмерВМб = ДанныеФайла.Размер / (1024 * 1024);
		
		ТекстПояснения =
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Выполняется сохранение файла ""%1"" (%2 Мб)...
				|Пожалуйста, подождите.'"),
			ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
			
		Состояние(ТекстПояснения);	
		
		// Сохраним Файл из БД на диск
		ПолучитьФайл(АдресФайла, ИмяФайла, Истина);
			
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(АдресФайла) Тогда
			УдалитьИзВременногоХранилища(АдресФайла);
		КонецЕсли;
	КонецЕсли;	
	
	Возврат "";
КонецФункции

// открыть Windows проводник, выбрав в нем указанный файл
Функция ОткрытьПроводникСФайлом(Знач ПолноеИмяФайла) Экспорт
	#Если НЕ ВебКлиент Тогда
		Если ПолноеИмяФайла <> "" Тогда
			ФайлНаДиске = Новый Файл(ПолноеИмяФайла);
			Если ФайлНаДиске.Существует() Тогда
				
				Если Лев(ПолноеИмяФайла, 0) <> """" Тогда
					ПолноеИмяФайла = """" + ПолноеИмяФайла + """";
				КонецЕсли;
				
				Парам = "explorer.exe /select, " + ПолноеИмяФайла;
				ЗапуститьПриложение(Парам);
				Возврат Истина;
			КонецЕсли;
		КонецЕсли;
	#КонецЕсли	
	
	Возврат Ложь;
КонецФункции

// Процедура открывает проводник Windows, позиционируясь на Файл
// 
Процедура КаталогФайла(ДанныеФайла) Экспорт
	
	// Если Файл без файла  - эта операция не имеет смысла
	Если ДанныеФайла.Версия.Пустая() Тогда 
		Возврат;
	КонецЕсли;
	
	#Если НЕ ВебКлиент Тогда
		ПолноеИмяФайла = ФайловыеФункцииКлиент.ПолучитьПутьФайлаВРабочемКаталоге(ДанныеФайла);
		Если ОткрытьПроводникСФайлом(ПолноеИмяФайла) = Истина Тогда
			Возврат;
		КонецЕсли;	
		
		ИмяФайла = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
		
		КодВозврата = Вопрос(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		  НСтр("ru = 'Файл ""%1"" отсутствует в рабочем каталоге! Получить файл с сервера?'"), ИмяФайла),
		  РежимДиалогаВопрос.ДаНет);
		  
		  Если КодВозврата = КодВозвратаДиалога.Да Тогда
			  ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла);
			  ОткрытьПроводникСФайлом(ПолноеИмяФайла);
		  КонецЕсли;		 
		  
		// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
		Если ЭтоАдресВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии) Тогда
			УдалитьИзВременногоХранилища(ДанныеФайла.НавигационнаяСсылкаТекущейВерсии);
		КонецЕсли;
	#Иначе	
		  Предупреждение(НСтр("ru = 'В Веб-клиенте данная функция не поддерживается.'"));
	#КонецЕсли
КонецПроцедуры

// Открывает диалог вопроса со списком Файлов или информации о Файлах
//
Функция ДиалогВопросаСоСписком(Список, СообщениеВопрос, СообщениеЗаголовок, Заголовок)
	Параметры = Новый Структура;	
	Параметры.Вставить("СообщениеВопрос", СообщениеВопрос);
	Параметры.Вставить("СообщениеЗаголовок", СообщениеЗаголовок);
	Параметры.Вставить("Заголовок", Заголовок);
	Параметры.Вставить("Файлы", Список);
	
	Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.ФормаВопроса", Параметры);
	Возврат (Результат = КодВозвратаДиалога.Да);

КонецФункции

// Обработчик события Перетаскивание в формах объектов - владельцев Файл (кроме формы ХранилищеФайлов)
//
Процедура ОбработкаПеретаскиванияВЛинейныйСписок(ПараметрыПеретаскивания, ВладелецФайлаСписка, ЭтаФорма,
	НеОткрыватьКарточкуПослеСозданияИзФайла = Неопределено) Экспорт
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Файл") И ПараметрыПеретаскивания.Значение.ЭтоФайл() = Истина Тогда
		
		СоздатьДокументНаОсновеФайла(ПараметрыПеретаскивания.Значение.ПолноеИмя, ВладелецФайлаСписка, ЭтаФорма, НеОткрыватьКарточкуПослеСозданияИзФайла);
		
	ИначеЕсли ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Файл") И ПараметрыПеретаскивания.Значение.ЭтоФайл() = Ложь Тогда
		
		Предупреждение(Нстр("ru = 'Выберите для импорта только файлы, но не каталоги.'"));
		Возврат;
		
	ИначеЕсли ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("СправочникСсылка.Файлы") Тогда	
		
		ПеренестиФайлВПриложенныеФайлы(ПараметрыПеретаскивания.Значение, ВладелецФайлаСписка);	
		
	ИначеЕсли ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Массив") Тогда
		
		Если ПараметрыПеретаскивания.Значение.Количество() >= 1 И ТипЗнч(ПараметрыПеретаскивания.Значение[0]) = Тип("Файл") Тогда
			Для Каждого ФайлПринятый Из ПараметрыПеретаскивания.Значение Цикл
				Если Не ФайлПринятый.ЭтоФайл() Тогда // только файлы, но не каталоги
					Предупреждение(Нстр("ru = 'Выберите для импорта только файлы, но не каталоги.'"));
					Возврат;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		Если ПараметрыПеретаскивания.Значение.Количество() >= 1 И ТипЗнч(ПараметрыПеретаскивания.Значение[0]) = Тип("Файл") Тогда
			Для Каждого ФайлПринятый Из ПараметрыПеретаскивания.Значение Цикл
				НеОткрыватьКарточкуПослеСозданияИзФайла = Истина;
				СоздатьДокументНаОсновеФайла(ФайлПринятый.ПолноеИмя, ВладелецФайлаСписка, ЭтаФорма, НеОткрыватьКарточкуПослеСозданияИзФайла);
			КонецЦикла;
		КонецЕсли;
		
		Если ПараметрыПеретаскивания.Значение.Количество() >= 1 И ТипЗнч(ПараметрыПеретаскивания.Значение[0]) = Тип("СправочникСсылка.Файлы") Тогда
			ПеренестиФайлыВПриложенныеФайлы(ПараметрыПеретаскивания.Значение, ВладелецФайлаСписка);
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры

// переносит файл из одного списка приложенных файлов в другой
Процедура ПеренестиФайлВПриложенныеФайлы(ФайлСсылка, ВладелецФайла)

	Результат = РаботаСФайлами.ПолучитьДанныеДляПереносаВПриложенныеФайлы(ФайлСсылка, ВладелецФайла).Получить(ФайлСсылка);
	
	Если Результат = "Скопировать" Тогда
		
		СозданФайл = РаботаСФайлами.СкопироватьФайлВПриложенных(ФайлСсылка, ВладелецФайла);
		Оповестить("СозданФайл", Новый Структура("Владелец, Файл", ВладелецФайла, СозданФайл));
		
		ПоказатьОповещениеПользователя(
				"Создание:", 
				ПолучитьНавигационнуюСсылку(СозданФайл),
				Строка(СозданФайл),
				БиблиотекаКартинок.Информация32);
		
	ИначеЕсли Результат = "Обновить" Тогда	
		
		ОбновленФайл = РаботаСФайлами.ОбновитьФайлВПриложенных(ФайлСсылка, ВладелецФайла);
			
		ПоказатьОповещениеПользователя(
				"Изменение:", 
				ПолучитьНавигационнуюСсылку(ОбновленФайл),
				Строка(ОбновленФайл),
				БиблиотекаКартинок.Информация32);
		
	КонецЕсли;
	
КонецПроцедуры	

// переносит файлы из одного списка приложенных файлов в другой
Процедура ПеренестиФайлыВПриложенныеФайлы(МассивФайлов, ВладелецФайла)
	
	Если МассивФайлов.Количество() = 1 Тогда 
		ПеренестиФайлВПриложенныеФайлы(МассивФайлов[0], ВладелецФайла);
	Иначе
		
		Результат = РаботаСФайлами.ПолучитьДанныеДляПереносаВПриложенныеФайлы(МассивФайлов, ВладелецФайла);
		
		МассивОбновить = Новый Массив;
		МассивСкопировать = Новый Массив;
		Для Каждого ФайлСсылка Из МассивФайлов Цикл
			Если Результат.Получить(ФайлСсылка) = "Скопировать" Тогда
				МассивСкопировать.Добавить(ФайлСсылка);
			ИначеЕсли Результат.Получить(ФайлСсылка) = "Обновить" Тогда
				МассивОбновить.Добавить(ФайлСсылка);
			КонецЕсли;
		КонецЦикла;	
		
		Если МассивСкопировать.Количество() > 0 Тогда 
			РаботаСФайлами.СкопироватьФайлВПриложенных(МассивСкопировать, ВладелецФайла);
		КонецЕсли;	
		
		Если МассивОбновить.Количество() > 0 Тогда 
			РаботаСФайлами.ОбновитьФайлВПриложенных(МассивОбновить, ВладелецФайла);
		КонецЕсли;	
		
		ОбщееКоличество = МассивСкопировать.Количество() + МассивОбновить.Количество();
		Если ОбщееКоличество > 0 Тогда 
			
			ПолноеОписание = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Файлы (%1 шт) перенесены в %2'"),
				ОбщееКоличество,
				ВладелецФайла);
			
			ПоказатьОповещениеПользователя(
				НСтр("ru = 'Файлы перенесены'"), 
				,
				ПолноеОписание,
				БиблиотекаКартинок.Информация32);
				
		КонецЕсли;	
			
	КонецЕсли;	
	
КонецПроцедуры

// Выбирает на  диске файл и создает из него новую версию - реализация низкоуровневая
Процедура ОбновитьИзФайлаНаДискеРеализация(ДанныеФайла, ИдентификаторФормы, ДиалогПолноеИмяФайла, 
	СоздатьНовуюВерсию = Неопределено, КомментарийКВерсии = Неопределено) Экспорт
	
	// данные файла могли измениться - обновим
	ДанныеФайла = РаботаСФайлами.ПолучитьДанныеФайлаИРабочийКаталог(ДанныеФайла.Ссылка);

	ПредыдущаяВерсия = ДанныеФайла.Версия;
	
	ФайлНаДиске = Новый Файл(ДиалогПолноеИмяФайла);
	ИмяИРасширениеФайлаНаДиске = ФайлНаДиске.Имя;
	ИмяИРасширениеФайлаВБазе = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение);
	ВремяИзмененияВыбранное = ФайлНаДиске.ПолучитьВремяИзменения();
	
	РедактируетТекущийПользователь = ДанныеФайла.РедактируетТекущийПользователь;
	
	ДатаФайлаВБазе = ДанныеФайла.ДатаМодификацииУниверсальная;
	ОбщегоНазначенияКлиент.ПреобразоватьЗимнееВремяКТекущему(ДатаФайлаВБазе);
	
	Если ВремяИзмененияВыбранное < ДатаФайлаВБазе Тогда // в кеше более новый
		СтрокаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					   НСтр("ru = 'Файл ""%1"" на сервере имеет более позднюю дату изменения (%2), чем выбранный файл (%3). 
					   |Операция прервана.'"), 
					   Строка(ДанныеФайла.Ссылка), ДатаФайлаВБазе, ВремяИзмененияВыбранное);
		Предупреждение(СтрокаОшибки);
		Возврат;
	КонецЕсли;
	
	
	// проверим  - есть ли файл в локальном кеше
	ПроинициализироватьПутьКРабочемуКаталогу();
	ВРабочемКаталогеНаЧтение = Истина;
	ВРабочемКаталогеВладельца = Ложь;
	ПолноеИмяФайла = "";
	ФайлВРабочемКаталоге = ФайлНаходитсяВЛокальномКэшеФайлов(Неопределено, ПредыдущаяВерсия, ПолноеИмяФайла, ВРабочемКаталогеНаЧтение, ВРабочемКаталогеВладельца);
	
	Если РедактируетТекущийПользователь Тогда // файл уже был занят
		
		Если ФайлВРабочемКаталоге = Истина Тогда
			ФайлВКеше = Новый Файл(ПолноеИмяФайла);
			ВремяИзмененияВКеше = ФайлВКеше.ПолучитьВремяИзменения();
			
			Если ВремяИзмененияВыбранное < ВремяИзмененияВКеше Тогда // в кеше более новый
				СтрокаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							   НСтр("ru = 'Файл ""%1"" в рабочем каталоге имеет более позднюю дату изменения (%2), чем выбранный файл (%3). 
							   |Операция прервана.'"), 
							   Строка(ДанныеФайла.Ссылка), ВремяИзмененияВКеше, ВремяИзмененияВыбранное);
				Предупреждение(СтрокаОшибки);
				Возврат;
			КонецЕсли;
			
			#Если НЕ ВебКлиент Тогда
				Попытка
					// проверяем что файл занят приложением
					ТекстовыйДокумент = Новый ТекстовыйДокумент;
					ТекстовыйДокумент.Прочитать(ПолноеИмяФайла);
				Исключение
					СтрокаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								   НСтр("ru = 'Файл в основном рабочем каталоге
								   |""%1"" 
								   |открыт для редактирования. 
								   |Закончите редактирование перед выполнением обновления из файла на диске.'"), 
								   ПолноеИмяФайла);
					Предупреждение(СтрокаОшибки);
					Возврат;
				КонецПопытки;
			#КонецЕсли
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если ФайлВРабочемКаталоге И ИмяИРасширениеФайлаНаДиске <> ИмяИРасширениеФайлаВБазе Тогда
		Попытка
			ФайловыеФункцииКлиент.УдалитьФайлИзРабочегоКаталога(ДанныеФайла.ТекущаяВерсия, Истина);
			ФайлВРабочемКаталоге = Ложь;
		Исключение
			Инфо = ИнформацияОбОшибке();
			Предупреждение(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								  НСтр("ru = 'Описание=""%1""'"), Инфо.Описание));
			
			Возврат;
		КонецПопытки;
	КонецЕсли;	

	Если Не РедактируетТекущийПользователь Тогда
		
		СтрокаОшибки = "";
		Если Не РаботаСФайламиКлиентСервер.МожноЛиЗанятьФайл(ДанныеФайла, СтрокаОшибки) Тогда
			Предупреждение(СтрокаОшибки);
			Возврат;
		КонецЕсли;
		
		СтрокаОшибки = "";
		Если Не РаботаСФайлами.ЗанятьФайл(ДанныеФайла, СтрокаОшибки, ИдентификаторФормы) Тогда 
			Предупреждение(СтрокаОшибки);
			Возврат;
		КонецЕсли;
		
		НаЧтение = Ложь;
		ВРабочемКаталогеВладельца = ДанныеФайла.РабочийКаталогВладельца <> "";
		ПеререгистрироватьФайлВРабочемКаталоге(ДанныеФайла, НаЧтение, ВРабочемКаталогеВладельца);
		
	КонецЕсли;
	
	ПереданныйПолныйПутьКФайлу = "";
	
	Если ФайлВРабочемКаталоге Тогда
		КопироватьФайл(ДиалогПолноеИмяФайла, ПолноеИмяФайла);
	Иначе
		ПереданныйПолныйПутьКФайлу = ДиалогПолноеИмяФайла;
	КонецЕсли;
	
	Если РедактируетТекущийПользователь Тогда // файл уже был занят
		
		ОпубликоватьФайл(ДанныеФайла.Ссылка, 
			ИдентификаторФормы,
			Неопределено,
			Неопределено, 
			Неопределено,
			Неопределено,
			ПереданныйПолныйПутьКФайлу,
			СоздатьНовуюВерсию, 
			КомментарийКВерсии);
			
	Иначе
		
		ЗакончитьРедактирование(
			ДанныеФайла.Ссылка, 
			ИдентификаторФормы,
			ДанныеФайла.ХранитьВерсии,
			ДанныеФайла.РедактируетТекущийПользователь,
			ДанныеФайла.Редактирует,
			ДанныеФайла.АвторТекущейВерсии,
			ПереданныйПолныйПутьКФайлу,
			СоздатьНовуюВерсию, 
			КомментарийКВерсии); 
			
	КонецЕсли;	
	
	Если ИмяИРасширениеФайлаНаДиске <> ИмяИРасширениеФайлаВБазе ИЛИ НЕ ФайлВРабочемКаталоге Тогда
		
		// обновим данные
		ДанныеФайла = РаботаСФайлами.ПолучитьДанныеФайлаДляОткрытия(
			ДанныеФайла.Ссылка, Неопределено, ИдентификаторФормы);
			
		// получим в кеш
		ПолучитьФайлВерсииВРабочийКаталог(ДанныеФайла, ПолноеИмяФайла);
	КонецЕсли;	
КонецПроцедуры

// Выбирает на  диске файл и создает из него новую версию
// 
Процедура ОбновитьИзФайлаНаДиске(ДанныеФайла, ИдентификаторФормы) Экспорт
	
	РасширениеПодключено = ПодключитьРасширениеРаботыСФайлами();
	
	Если РасширениеПодключено Тогда
	
		Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
		
		ПутьВыбора = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиПрограммы", "ПапкаДляОбновитьИзФайла");
		Если ПутьВыбора = Неопределено ИЛИ ПутьВыбора = "" Тогда
			
			#Если НЕ ВебКлиент Тогда
				
				Если СтандартныеПодсистемыКлиентПовтИсп.ПараметрыРаботыКлиента().ЭтоБазоваяВерсияКонфигурации Тогда
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Данная операция не поддерживается в базовой версии.'"));
					Возврат;
				КонецЕсли;
				
				Оболочка = Новый COMОбъект("MSScriptControl.ScriptControl");
				Оболочка.Language = "vbscript";
				Оболочка.AddCode("
					|Function SpecialFoldersName(Name)
					|set Shell=CreateObject(""WScript.Shell"")
					|SpecialFoldersName=Shell.SpecialFolders(Name)
					|End Function");
				ПутьВыбора = Оболочка.Run("SpecialFoldersName", "MyDocuments");
			#Иначе	
				ПутьВыбора = "";
			#КонецЕсли
		КонецЕсли;
		
		Диалог.Заголовок                   = НСтр("ru = 'Выбор файла'");
		Диалог.ПредварительныйПросмотр     = Ложь;
		Диалог.ПроверятьСуществованиеФайла = Ложь;
		Диалог.МножественныйВыбор          = Ложь;
		Диалог.Каталог					   = ПутьВыбора;
		Диалог.ПолноеИмяФайла			   = ФайловыеФункцииКлиент.ПолучитьИмяСРасширением(ДанныеФайла.ПолноеНаименованиеВерсии, ДанныеФайла.Расширение); 
		Диалог.Фильтр                      = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Файл (*.%1)|*.%1|Все файлы (*.*)|*.*'"), ДанныеФайла.Расширение, ДанныеФайла.Расширение);
		
		Если Диалог.Выбрать() Тогда
					
			ПутьВыбораПрежний = ПутьВыбора;
			ФайлНаДиске = Новый Файл(Диалог.ПолноеИмяФайла);
			ПутьВыбора = ФайлНаДиске.Путь;
			Если ПутьВыбораПрежний <> ПутьВыбора Тогда
				ОбщегоНазначения.ХранилищеОбщихНастроекСохранить("НастройкиПрограммы", "ПапкаДляОбновитьИзФайла",  ПутьВыбора);
			КонецЕсли;
			
			ОбновитьИзФайлаНаДискеРеализация(ДанныеФайла, ИдентификаторФормы, Диалог.ПолноеИмяФайла);
			
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры

Процедура ПоказатьЗанятыеФайлыПриЗавершенииРаботы(Отказ) Экспорт
	
	ТекущийПользователь = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ТекущийПользователь;
	
	ЗанятыеФайлы = РаботаСФайлами.ПолучитьЗанятыеФайлы(, ТекущийПользователь);
	Если ЗанятыеФайлы.Количество() > 0 Тогда 
		
		ПараметрыФормы = Новый Структура;	
		ПараметрыФормы.Вставить("СообщениеВопрос", 		НСТР("ru = 'Завершить работу с программой?'"));
		ПараметрыФормы.Вставить("СообщениеЗаголовок", 	НСТР("ru = 'Следующие файлы заняты вами для редактирования:'"));
		ПараметрыФормы.Вставить("Заголовок", 			НСТР("ru = 'Завершение работы'"));
		ПараметрыФормы.Вставить("Редактирует", 			ТекущийПользователь);
		
		Результат = ОткрытьФормуМодально("Справочник.Файлы.Форма.СписокЗанятыхСВопросом", ПараметрыФормы);
		Если Результат <> КодВозвратаДиалога.Да Тогда 
			Отказ = Истина;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры	

// сохраняет путь к каталогу в настройках
Процедура СохранитьПутьККаталогуВНастройках(ИмяКаталога)
	РаботаСФайлами.СохранитьПутьКРабочемуКаталогуПользователя(ИмяКаталога);
	ОбновитьПовторноИспользуемыеЗначения();
КонецПроцедуры

// Проинициализировать параметр сеанса ПутьКРабочемуКаталогуПользователя, проверив корректность пути, и откорректировав если нужно
Процедура ПроинициализироватьПутьКРабочемуКаталогу() Экспорт
	ПараметрСеансаРабочийКаталог = РаботаСФайламиКлиентПовтИсп.ПолучитьПараметрСеансаРабочийКаталог();
	Если Не ПустаяСтрока(ПараметрСеансаРабочийКаталог) Тогда // уже проинициализировано
		Возврат;
	КонецЕсли;	
	
	ИмяКаталога = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ПутьКЛокальномуКэшуФайлов;
	Если ИмяКаталога = Неопределено Тогда
		ИмяКаталога = ФайловыеФункцииКлиент.ПолучитьПутьККаталогуДанныхПользователя();
		Если Не ПустаяСтрока(ИмяКаталога) Тогда
			СохранитьПутьККаталогуВНастройках(ИмяКаталога);
		Иначе
			Возврат;
		КонецЕсли;	
	Иначе
		РаботаСФайлами.УстановитьПараметрСеансаПутьКРабочемуКаталогуПользователя(ИмяКаталога);
		ОбновитьПовторноИспользуемыеЗначения();
	КонецЕсли;
	
#Если Не ВебКлиент Тогда
	// Создать каталог для файлов
	Попытка
		СоздатьКаталог(ИмяКаталога);
		ИмяКаталогаТестовое = ИмяКаталога + "ПроверкаДоступа\";
		СоздатьКаталог(ИмяКаталогаТестовое);
		УдалитьФайлы(ИмяКаталогаТестовое);
	Исключение
		// нет прав на создание каталога, или такой путь отсутствует - сбрасываем в настройки по умолчанию
		ИмяКаталога = ФайловыеФункцииКлиент.ПолучитьПутьККаталогуДанныхПользователя();
		СохранитьПутьККаталогуВНастройках(ИмяКаталога);
	КонецПопытки;
#КонецЕсли

КонецПроцедуры

// Шифрует объект - Файл, Версия
Функция Зашифровать(ОбъектСсылка, МассивСертификатов, УникальныйИдентификаторФормы, ДанныеФайла,
	МассивДанныхДляЗанесенияВБазу, МассивОтпечатков, МассивАдресов) Экспорт
	
	КоличествоВерсий = ДанныеФайла.КоличествоВерсий;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключеноФайл = ПодключитьРасширениеРаботыСФайлами();
	РасширениеПодключеноКрипто = ПодключитьРасширениеРаботыСКриптографией();
	
	МассивОтпечатков = Новый Массив;
	Для Каждого Сертификат Из МассивСертификатов Цикл
		Отпечаток = Base64Строка(Сертификат.Отпечаток);
		
		КомуВыданСертификат = ЭлектронноЦифроваяПодписьКлиент.ПолучитьПредставлениеПользователя(Сертификат.Субъект);
		Представление = КомуВыданСертификат;
		
		ОтпечатокСтруктура = Новый Структура("Отпечаток, Представление", Отпечаток, Представление);
		МассивОтпечатков.Добавить(ОтпечатокСтруктура);
	КонецЦикла;
	
	МассивОбъектовШифрования = Новый Массив;
	МассивАдресов = Новый Массив;
	
	Если ТипЗнч(ОбъектСсылка) = Тип("СправочникСсылка.Файлы") Тогда
		
		Если КоличествоВерсий > 1 Тогда
			
			ТекстВопроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Сейчас будет выполнено шифрование всех %1 версий файла. Это может занять продолжительное время. Продолжить шифрование файла?'"),
				КоличествоВерсий);
			
			Если Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет) <> КодВозвратаДиалога.Да Тогда
				Возврат Ложь;
			КонецЕсли;	
		КонецЕсли;	
		
		МассивВерсий = РаботаСФайлами.ПолучитьДанныеФайлаИНавигационнуюСсылкуВсехВерсийФайла(ОбъектСсылка, УникальныйИдентификаторФормы);
		Если МассивВерсий.Количество() = 0 Тогда
			Возврат Ложь;
		КонецЕсли;	
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Выполняется получение всех версий файла ""%1""'"),
			ОбъектСсылка);
		Состояние(ТекстСообщения, 0);
		
		Счетчик = 0;
		Для Каждого СтруктураВерсии Из МассивВерсий Цикл
			
			Прогресс = Счетчик / МассивВерсий.Количество() * 100;
			Состояние(ТекстСообщения, Прогресс);
			
			ДанныеФайла = СтруктураВерсии.ДанныеФайла;
			АдресФайла = СтруктураВерсии.НавигационнаяСсылкаВерсии;
			
			ДвоичныеДанныеФайла = ПолучитьИзВременногоХранилища(АдресФайла);
				
			// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
			Если ЭтоАдресВременногоХранилища(АдресФайла) Тогда
				МассивАдресов.Добавить(АдресФайла);
			КонецЕсли;
				
			ОбъектДляПодписи = Новый Структура("ДвоичныеДанныеФайла, ВерсияСсылка", 
				ДвоичныеДанныеФайла, СтруктураВерсии.ВерсияСсылка);
				
			МассивОбъектовШифрования.Добавить(ОбъектДляПодписи);
			Счетчик = Счетчик + 1;
			
		КонецЦикла;	
		
		Состояние();
		
	КонецЕсли;	
	
	МенеджерКриптографии = ЭлектронноЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
	
	МассивДанныхДляЗанесенияВБазу = Новый Массив;
	
	Для Каждого ОбъектДляШифрования Из МассивОбъектовШифрования Цикл
		
		ДвоичныеДанныеФайла = ОбъектДляШифрования.ДвоичныеДанныеФайла;
		ВерсияСсылка = ОбъектДляШифрования.ВерсияСсылка;
		
		ШифрованныйФайлДвоичныеДанные = МенеджерКриптографии.Зашифровать(ДвоичныеДанныеФайла, МассивСертификатов);
		АдресВременногоХранилища = ПоместитьВоВременноеХранилище(ШифрованныйФайлДвоичныеДанные, УникальныйИдентификаторФормы);
		
		ДанныеДляЗаписиНаСервере = Новый Структура("АдресВременногоХранилища, ВерсияСсылка", АдресВременногоХранилища, ВерсияСсылка);
		МассивДанныхДляЗанесенияВБазу.Добавить(ДанныеДляЗаписиНаСервере);
		
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

// Расшифрует объект - Файл, Версия
Функция Расшифровать(ОбъектСсылка, УникальныйИдентификаторФормы, ДанныеФайла,
	МассивДанныхДляЗанесенияВБазу, МассивАдресов) Экспорт
	
	КоличествоВерсий = ДанныеФайла.КоличествоВерсий;
	
	ОбщегоНазначенияКлиент.ПредложитьУстановкуРасширенияРаботыСФайлами();
	
	РасширениеПодключеноФайл = ПодключитьРасширениеРаботыСФайлами();
	РасширениеПодключеноКрипто = ПодключитьРасширениеРаботыСКриптографией();
	
	ПредставленияСертификатов = "";
	Для Каждого СтруктураСертификата Из ДанныеФайла.МассивСертификатовШифрования Цикл
		
		Отпечаток = СтруктураСертификата.Отпечаток;
		
		ТолькоВЛичномХранилище = Истина;
		Сертификат = ЭлектронноЦифроваяПодписьКлиент.ПолучитьСертификатПоОтпечатку(Отпечаток, ТолькоВЛичномХранилище);
		Если Сертификат <> Неопределено Тогда // тут собираем только личные сертификаты - с закрытым ключом
			Если НЕ ПустаяСтрока(ПредставленияСертификатов) Тогда
				ПредставленияСертификатов = ПредставленияСертификатов + Символы.ПС;
			КонецЕсли;
			ПредставленияСертификатов = ПредставленияСертификатов + СтруктураСертификата.Представление;
		КонецЕсли;
		
	КонецЦикла;	
	
	Пароль = "";
	Заголовок = НСтр("ru = 'Введите пароль для расшифровки'");
	ПараметрыФормы = Новый Структура("Заголовок, ПредставленияСертификатов, Файл", 
		Заголовок, ПредставленияСертификатов, ОбъектСсылка);
	КодВозврата = ОткрытьФормуМодально("Справочник.Файлы.Форма.ВводПароляСОписаниями", ПараметрыФормы);
	Если ТипЗнч(КодВозврата) = Тип("Строка") Тогда
		Пароль = КодВозврата;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
	МассивОбъектовШифрования = Новый Массив;
	МассивАдресов = Новый Массив;
	
	Если ТипЗнч(ОбъектСсылка) = Тип("СправочникСсылка.Файлы") Тогда
		
		Если КоличествоВерсий > 1 Тогда
			
			ТекстВопроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Сейчас будет выполнена расшифровка всех %1 версий файла. Это может занять продолжительное время. Продолжить расшифровку файла?'"),
				КоличествоВерсий);
			
			Если Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет) <> КодВозвратаДиалога.Да Тогда
				Возврат Ложь;
			КонецЕсли;	
		КонецЕсли;	
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Выполняется получение всех версий файла ""%1""'"),
			ОбъектСсылка);
			
		Состояние(ТекстСообщения, 0);
		МассивВерсий = РаботаСФайлами.ПолучитьДанныеФайлаИНавигационнуюСсылкуВсехВерсийФайла(ОбъектСсылка, УникальныйИдентификаторФормы);
		
		Счетчик = 0;
		Для Каждого СтруктураВерсии Из МассивВерсий Цикл
			
			Прогресс = Счетчик / МассивВерсий.Количество() * 100;
			Состояние(ТекстСообщения, Прогресс);
			
			ДанныеФайла = СтруктураВерсии.ДанныеФайла;
			АдресФайла = СтруктураВерсии.НавигационнаяСсылкаВерсии;
			
			ДвоичныеДанныеФайла = ПолучитьИзВременногоХранилища(АдресФайла);
			
			// для варианта с хранением файлов на диске (на сервере) удаляем Файл из временного хранилища после получения
			Если ЭтоАдресВременногоХранилища(АдресФайла) Тогда
				МассивАдресов.Добавить(АдресФайла);
			КонецЕсли;
				
			ОбъектДляПодписи = Новый Структура("ДвоичныеДанныеФайла, ВерсияСсылка", 
				ДвоичныеДанныеФайла, СтруктураВерсии.ВерсияСсылка);
				
			МассивОбъектовШифрования.Добавить(ОбъектДляПодписи);
			Счетчик = Счетчик + 1;
			
		КонецЦикла;	
		
		Состояние();
		
	КонецЕсли;	
	
	МенеджерКриптографии = ЭлектронноЦифроваяПодписьКлиент.ПолучитьМенеджерКриптографии();
	МенеджерКриптографии.ПарольДоступаКЗакрытомуКлючу = Пароль;
	
	МассивДанныхДляЗанесенияВБазу = Новый Массив;
	
	Для Каждого ОбъектДляШифрования Из МассивОбъектовШифрования Цикл
		
		ДвоичныеДанныеФайла = ОбъектДляШифрования.ДвоичныеДанныеФайла;
		ВерсияСсылка = ОбъектДляШифрования.ВерсияСсылка;
		
		ДвоичныеДанныеРасшифрованные = МенеджерКриптографии.Расшифровать(ДвоичныеДанныеФайла);
		АдресВременногоХранилища = ПоместитьВоВременноеХранилище(ДвоичныеДанныеРасшифрованные, УникальныйИдентификаторФормы);
		
		ДанныеДляЗаписиНаСервере = Новый Структура("АдресВременногоХранилища, ВерсияСсылка", АдресВременногоХранилища, ВерсияСсылка);
		МассивДанныхДляЗанесенияВБазу.Добавить(ДанныеДляЗаписиНаСервере);
		
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции	

// По окончании Зашифровать нотифицирует
Процедура ИнформироватьОШифровании(МассивФайловВРабочемКаталогеДляУдаления, ВладелецФайла, 
	ОбъектСсылка) Экспорт
	
	ОповеститьОбИзменении(ОбъектСсылка);
	СтруктураОповещения = Новый Структура("Владелец", 
		ВладелецФайла);
	Оповестить("ПрисоединенныйФайлЗашифрован", СтруктураОповещения);
	
	// удаляем из рабочего каталога все версии файла
	Для Каждого ПутьФайла Из МассивФайловВРабочемКаталогеДляУдаления Цикл
		РаботаСФайламиКлиент.УдалитьФайл(ПутьФайла, Ложь); // не задавать вопрос
	КонецЦикла;	
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Файл ""%1"" зашифрован'"),
		ОбъектСсылка);
	Состояние(ТекстСообщения);
	
КонецПроцедуры	

// По окончании Расшифровать нотифицирует
Процедура ИнформироватьОРасшифровании(ВладелецФайла, ОбъектСсылка) Экспорт
	
	ОповеститьОбИзменении(ОбъектСсылка);
	СтруктураОповещения = Новый Структура("Владелец", 
		ВладелецФайла);
	Оповестить("ПрисоединенныйФайлЗашифрован", СтруктураОповещения);
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Файл ""%1"" расшифрован'"),
		ОбъектСсылка);
	Состояние(ТекстСообщения);
	
КонецПроцедуры	

