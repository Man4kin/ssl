

// Обработчик события ПередЗаписью формирует временную таблицу старых пользователей
// для обработчика ПриЗаписи.
//
Процедура ПередЗаписью(Отказ)
	
	// Следующие строки необходимо, чтобы предотвратить возможность ответственному за группу доступа
	// повысить себя до администратора программным путем, т.к. запись групп доступа разрешена
	// ответственным пользователям.
	// Для обмена данными эти строки критичны, если выполняется попытка записать загруженный профиль
	// со ссылкой на предопределенный профиль Администратор.
	// Такие данные загружать недопустимо.
	Если Ссылка = Справочники.ГруппыДоступа.Администраторы Тогда
		Профиль = Справочники.ПрофилиГруппДоступа.Администратор;
		Если НЕ УправлениеДоступом.ЕстьРоль("ПолныеПрава") Тогда
			ВызватьИсключение(НСтр("ru = 'Предопределенную группу доступа Администраторы могут
			                             |изменять только Администраторы!'"));
		КонецЕсли;
	ИначеЕсли Профиль = Справочники.ПрофилиГруппДоступа.Администратор Тогда
		ВызватьИсключение(НСтр("ru = 'Предопределенный профиль Администратор может быть только
		                             |у предопределенной группы доступа Администраторы!'"));
	КонецЕсли;
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЭтоГруппа Тогда
		
		Если НЕ ДополнительныеСвойства.Свойство("НеОбновлятьРолиПользователей") Тогда
			ДополнительныеСвойства.Вставить("СтарыеУчастникиГруппыДоступа", ЭтотОбъект.Пользователи.ВыгрузитьКолонку("Пользователь"));
		КонецЕсли;
		
		Если Ссылка = Справочники.ГруппыДоступа.Администраторы Тогда
			Пользователь = Неопределено;
		КонецЕсли;
		
		// Автоматическая установка реквизитов для персональной группы доступа
		Если ЗначениеЗаполнено(Пользователь) Тогда
			Родитель         = УправлениеДоступом.РодительПерсональныхГруппДоступа();
			ТипПользователей = Неопределено;
		Иначе
			Пользователь = Неопределено;
			Если Родитель = УправлениеДоступом.РодительПерсональныхГруппДоступа(Истина) Тогда
				Родитель = Неопределено;
			КонецЕсли;
		КонецЕсли;
		
		// При снятии пометки удаления снятие пометки удаления с профиля групп доступа этой группы
		Если НЕ ПометкаУдаления
		   И ОбщегоНазначения.ПолучитьЗначениеРеквизита(Ссылка,  "ПометкаУдаления") = Истина
		   И ОбщегоНазначения.ПолучитьЗначениеРеквизита(Профиль, "ПометкаУдаления") = Истина Тогда
			ЗаблокироватьДанныеДляРедактирования(Профиль);
			ПрофильОбъект = Профиль.ПолучитьОбъект();
			ПрофильОбъект.ПометкаУдаления = Ложь;
			ПрофильОбъект.Записать();
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПриЗаписи обновляет
// - роли добавленных, оставшихся и удаленных пользователей;
// - РегистрСведений.ТаблицыГруппДоступа;
// - РегистрСведений.ЗначенияГруппДоступа.
//
Процедура ПриЗаписи(Отказ)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЭтоГруппа Тогда
	
		Если НЕ ДополнительныеСвойства.Свойство("НеОбновлятьРолиПользователей") Тогда
			//
			ЕстьОшибки = Ложь;
			УправлениеДоступом.ОбновитьРолиПользователейПриИзмененииГруппыДоступа(Ссылка, ДополнительныеСвойства.СтарыеУчастникиГруппыДоступа, ЕстьОшибки);
			Если ЕстьОшибки Тогда
				ДополнительныеСвойства.Вставить("ЕстьОшибки");
			КонецЕсли;
		КонецЕсли;
		
		УправлениеДоступом.ОбновитьТаблицыГруппДоступа(Ссылка);
		
		УправлениеДоступом.ЗаписатьЗначенияГруппДоступа(Ссылка);
	
	КонецЕсли;
	
КонецПроцедуры

