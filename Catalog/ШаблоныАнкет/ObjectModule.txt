
Процедура ПриКопировании(ОбъектКопирования)
	
	Попытка 
		
		НачатьТранзакцию();
		
		УстановитьСсылкуНового(Справочники.ШаблоныАнкет.ПолучитьСсылку());
		РедактированиеШаблонаЗавершено = Ложь;
		Записать();
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		               |	ВопросыШаблонаАнкеты.Ссылка КАК Ссылка,
		               |	ВопросыШаблонаАнкеты.ПометкаУдаления,
		               |	ВопросыШаблонаАнкеты.Предопределенный,
		               |	ВопросыШаблонаАнкеты.Владелец,
		               |	ВопросыШаблонаАнкеты.Родитель,
		               |	ВопросыШаблонаАнкеты.ЭтоГруппа,
		               |	ВопросыШаблонаАнкеты.Код КАК Код,
		               |	ВопросыШаблонаАнкеты.Наименование,
		               |	ВопросыШаблонаАнкеты.Обязательный,
		               |	ВопросыШаблонаАнкеты.ТипВопроса,
		               |	ВопросыШаблонаАнкеты.ТипТабличногоВопроса,
		               |	ВопросыШаблонаАнкеты.ЭлементарныйВопрос,
		               |	ВопросыШаблонаАнкеты.РодительВопрос,
		               |	ВопросыШаблонаАнкеты.СоставТабличногоВопроса.(
		               |		ЭлементарныйВопрос КАК ЭлементарныйВопрос,
		               |		НомерСтроки
		               |	),
		               |	ВопросыШаблонаАнкеты.ПредопределенныеОтветы.(
		               |		ЭлементарныйВопрос КАК ЭлементарныйВопрос,
		               |		Ответ,
		               |		НомерСтроки
		               |	),
		               |	ВопросыШаблонаАнкеты.Формулировка,
		               |	ВопросыШаблонаАнкеты.ВысотаЭлементаФормулировкиВопроса
		               |ИЗ
		               |	Справочник.ВопросыШаблонаАнкеты КАК ВопросыШаблонаАнкеты
		               |ГДЕ
		               |	ВопросыШаблонаАнкеты.Владелец = &ШаблонАнкеты
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	Ссылка ИЕРАРХИЯ,
		               |	Код";
		
		Запрос.УстановитьПараметр("ШаблонАнкеты",ОбъектКопирования.Ссылка);
		
		Результат = Запрос.Выполнить();
		Если Результат.Пустой() Тогда
			Возврат;	
		КонецЕсли;  		
		
		Выборка = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
				
		ДобавитьЭлементыСправочникаВопросыШаблонаАнкеты(Выборка);
		
	Исключение
		
		ОтменитьТранзакцию();
		Возврат;
		
	КонецПопытки; 
	
	ЗафиксироватьТранзакцию();
	
КонецПроцедуры

Процедура ДобавитьЭлементыСправочникаВопросыШаблонаАнкеты(Выборка,Родитель = Неопределено)
	
	ВопросыСУсловием = Новый Соответствие;
	
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.ЭтоГруппа Тогда
			                                                                                        
			НовыйЭлемент = Справочники.ВопросыШаблонаАнкеты.СоздатьГруппу();
			ЗаполнитьЗначенияСвойств(НовыйЭлемент,Выборка,"Наименование,Код,Формулировка");
			
		Иначе
			
			НовыйЭлемент = Справочники.ВопросыШаблонаАнкеты.СоздатьЭлемент();
			
			СсылкаНового = Справочники.ВопросыШаблонаАнкеты.ПолучитьСсылку();
			НовыйЭлемент.УстановитьСсылкуНового(СсылкаНового);
			
			ЗаполнитьЗначенияСвойств(НовыйЭлемент,Выборка,,"Владелец,Родитель,СоставТабличногоВопроса,ПредопределенныеОтветы,Код,РодительВопрос,ВысотаЭлементаФормулировкиВопроса");
			СоставТабличногоВопроса = Выборка.СоставТабличногоВопроса.Выгрузить();
			СоставТабличногоВопроса.Сортировать("НомерСтроки Возр");
			НовыйЭлемент.СоставТабличногоВопроса.Загрузить(СоставТабличногоВопроса);
			ПредопределенныеОтветы = Выборка.ПредопределенныеОтветы.Выгрузить();
			ПредопределенныеОтветы.Сортировать("НомерСтроки Возр");
			НовыйЭлемент.ПредопределенныеОтветы.Загрузить(ПредопределенныеОтветы);
			
			Если Выборка.ТипВопроса = Перечисления.ТипыВопросовШаблонаАнкеты.ВопросСУсловием Тогда
			     ВопросыСУсловием.Вставить(Выборка.Ссылка,СсылкаНового);			
			КонецЕсли;
			 
			Если НЕ Выборка.РодительВопрос.Пустая() Тогда
			    НовыйЭлемент.РодительВопрос = ВопросыСУсловием.Получить(Выборка.РодительВопрос);			
			КонецЕсли; 
			
		КонецЕсли; 		
		
		НовыйЭлемент.Владелец = Ссылка;
		НовыйЭлемент.Родитель = ?(Родитель = Неопределено,Справочники.ВопросыШаблонаАнкеты.ПустаяСсылка(),Родитель);
		НовыйЭлемент.Записать();
				
		
		ПодчиненнаяВыборка = Выборка.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
		Если ПодчиненнаяВыборка.Количество() > 0 Тогда
			 ДобавитьЭлементыСправочникаВопросыШаблонаАнкеты(ПодчиненнаяВыборка,НовыйЭлемент.Ссылка);
		КонецЕсли;
		
	КонецЦикла; 
	
КонецПроцедуры


	
		
	

